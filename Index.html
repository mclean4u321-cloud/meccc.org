<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MECCC Malaysia Ecological Civilization Communication Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
        }
        
        /* Emoji image styling */
        .emoji-image {
            display: inline-block !important;
            vertical-align: middle;
            margin: 0 2px;
            border-radius: 2px;
            transition: transform 0.2s ease;
        }
        
        .emoji-image:hover {
            transform: scale(1.1);
        }
        
        /* Large emoji images in cards and headers */
        .text-6xl .emoji-image,
        .text-5xl .emoji-image,
        .text-4xl .emoji-image {
            margin: 0 4px;
            border-radius: 4px;
        }
        
        /* Ensure emoji images don't break layout */
        .emoji-image + span {
            display: none;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            position: relative;
            overflow: hidden;
        }
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.2) 0%, transparent 50%);
            pointer-events: none;
        }
        .hero-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        .hero-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"),
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(120, 219, 226, 0.3) 0%, transparent 50%);
            pointer-events: none;
        }
        .section-bg {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            position: relative;
            overflow: hidden;
        }
        .section-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M20 20c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10zm10 0c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10z'/%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }
        .card-hover {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px -10px rgba(16, 185, 129, 0.3);
            background: rgba(255, 255, 255, 1);
        }
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .pulse-green {
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }
        .modal-backdrop {
            backdrop-filter: blur(8px);
        }
        .sponsor-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid transparent;
            background-clip: padding-box;
            backdrop-filter: blur(10px);
        }
        .sponsor-card:hover {
            border-color: #10b981;
            transform: scale(1.02);
        }
        .logo-editor {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10;
            min-width: 280px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .logo-editor.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        .size-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }
        .size-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .nature-pattern {
            background-image: 
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2310b981' fill-opacity='0.1'%3E%3Cpath d='M30 30c0-11 9-20 20-20s20 9 20 20-9 20-20 20-20-9-20-20zm-20 0c0-11 9-20 20-20s20 9 20 20-9 20-20 20-20-9-20-20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Text Edit Mode Styles */
        .text-edit-mode {
            position: relative;
        }
        
        .text-edit-mode .editable-text {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }
        
        .text-edit-mode .editable-text:hover {
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
        }
        
        .text-edit-mode .editable-text.selected {
            background-color: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        .text-edit-mode .editable-text.editing {
            background-color: rgba(34, 197, 94, 0.1);
            border: 2px solid #22c55e;
        }
        
        .inline-editor {
            background: white !important;
            border: 2px solid #3b82f6 !important;
            border-radius: 6px !important;
            padding: 8px 12px !important;
            font-family: inherit;
            font-size: inherit;
            color: #1f2937 !important;
            font-weight: inherit;
            line-height: inherit;
            min-width: 120px !important;
            min-height: 32px !important;
            resize: none;
            outline: none !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2) !important;
            z-index: 9999 !important;
            position: relative !important;
            transition: all 0.2s ease !important;
        }
        
        .inline-editor:focus {
            border-color: #1d4ed8 !important;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3) !important;
        }
        

        
        .custom-text-element {
            position: relative;
            display: inline-block;
            margin: 4px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .custom-text-element:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .text-edit-mode .custom-text-element {
            border-color: #fbbf24;
        }
        
        .text-edit-mode .custom-text-element:hover {
            border-color: #f59e0b;
            background: rgba(251, 191, 36, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-2xl relative overflow-hidden">
        <!-- Header Background -->
        <div id="headerBg" class="absolute inset-0 bg-gradient-to-r from-green-600 to-blue-600"></div>
        
        <!-- Header Background Change Button (Admin Only) -->
        <button onclick="changeBannerBackground('header')" class="admin-only absolute top-4 right-4 z-20 bg-white bg-opacity-20 hover:bg-opacity-40 text-white rounded-full p-2 text-xs transition-all hidden">
            🖼️ 更换Header背景
        </button>
        
        <div class="max-w-7xl mx-auto px-4 py-6 relative z-10">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <!-- MECCC Logo with Editor -->
                    <div class="relative" id="logoContainer">
                        <img id="mecccLogo" src="" alt="MECCC Logo" class="object-contain rounded-lg bg-white bg-opacity-20 p-2 hidden transition-all duration-300 cursor-pointer" onclick="toggleLogoEditor()" style="width: 64px; height: 64px;">
                        <div id="logoPlaceholder" class="h-16 w-16 bg-white bg-opacity-20 rounded-lg flex items-center justify-center cursor-pointer hover:bg-opacity-30 transition-all" onclick="triggerLogoUpload()">
                            <span class="text-2xl">📷</span>
                        </div>
                        <input type="file" id="logoUpload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
                        
                        <!-- Logo Editor Panel -->
                        <div id="logoEditor" class="logo-editor">
                            <h4 class="font-bold text-gray-800 mb-3">🎨 Logo编辑器</h4>
                            
                            <!-- Size Control -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">📏 大小调整</label>
                                <input type="range" id="logoSizeSlider" class="size-slider" min="32" max="128" value="64" oninput="adjustLogoSize(this.value)">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>小</span>
                                    <span id="sizeDisplay">64px</span>
                                    <span>大</span>
                                </div>
                            </div>
                            
                            <!-- Shape Control -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">🔲 形状样式</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="setLogoShape('rounded-lg')" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-xs">圆角</button>
                                    <button onclick="setLogoShape('rounded-full')" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-xs">圆形</button>
                                    <button onclick="setLogoShape('rounded-none')" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-xs">方形</button>
                                </div>
                            </div>
                            
                            <!-- Background Control -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">🎨 背景样式</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setLogoBg('bg-white bg-opacity-20')" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-xs">透明</button>
                                    <button onclick="setLogoBg('bg-white')" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-xs">白色</button>
                                    <button onclick="setLogoBg('bg-green-100')" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-xs">绿色</button>
                                    <button onclick="setLogoBg('bg-blue-100')" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-xs">蓝色</button>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex space-x-2">
                                <button onclick="triggerLogoUpload()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                                    📷 更换
                                </button>
                                <button onclick="removeLogo()" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">
                                    🗑️ 删除
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">MECCC Malaysia Ecological Civilization Communication Center</h1>
                        <p class="text-green-100 text-sm">Empowering Youth Through Environmental Action</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm text-green-100">🌍 Global Ecological Communication</p>
                        <p class="text-xs text-green-200">Education is Action, Action is Culture</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="showMagazineModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm">
                            📚 E-Magazine
                        </button>
                        <button onclick="showSchoolLoginModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm">
                            🏫 School Portal
                        </button>
                        <button onclick="showAdminAccessModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm">
                            <span id="adminModeText">🔧 Admin Access</span>
                        </button>
                        <button onclick="toggleTextEditMode()" class="admin-only bg-yellow-500 bg-opacity-20 hover:bg-opacity-40 px-4 py-2 rounded-lg text-sm hidden">
                            <span id="textEditModeText">✏️ 文字编辑模式</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-bg py-16 relative overflow-hidden">
        <!-- Hero Background -->
        <div id="heroBg" class="absolute inset-0 bg-gradient-to-br from-blue-500 to-purple-600"></div>
        
        <!-- Hero Background Change Button (Admin Only) -->
        <button onclick="changeBannerBackground('hero')" class="admin-only absolute top-4 right-4 z-20 bg-white bg-opacity-20 hover:bg-opacity-40 text-gray-800 rounded-full p-2 text-xs transition-all hidden">
            🖼️ 更换Hero背景
        </button>
        
        <div class="max-w-7xl mx-auto px-4 text-center relative z-10">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">
                🌍 Education is Action, Action is Culture
            </h2>
            <p class="text-xl text-gray-600 mb-8">
                Join Malaysia's premier platform for youth environmental education and action
            </p>
            
            <!-- Main Action Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 max-w-7xl mx-auto">
                <!-- My Green Movement Button -->
                <div class="relative overflow-hidden rounded-xl shadow-lg transform hover:scale-105 transition-all">
                    <div id="greenMovementBg" class="absolute inset-0 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 transition-all bg-cover bg-center"></div>
                    <button onclick="showEcoSubmissionModal()" class="relative z-10 w-full text-white p-6 text-center bg-black bg-opacity-20 hover:bg-opacity-10 transition-all">
                        <div class="text-5xl mb-3">📝</div>
                        <h4 class="text-xl font-bold mb-2">My Green Movement</h4>
                        <p class="text-green-100 text-sm">Share environmental insights</p>
                    </button>
                    <button onclick="changeButtonBackground('greenMovement')" class="admin-only absolute top-2 right-2 z-20 bg-white bg-opacity-20 hover:bg-opacity-40 text-white rounded-full p-2 text-xs transition-all hidden">
                        🖼️
                    </button>
                </div>
                
                <!-- E-Magazine Button -->
                <div class="relative overflow-hidden rounded-xl shadow-lg transform hover:scale-105 transition-all">
                    <div id="eMagazineBg" class="absolute inset-0 bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 transition-all bg-cover bg-center"></div>
                    <button onclick="showMagazineModal()" class="relative z-10 w-full text-white p-6 text-center bg-black bg-opacity-20 hover:bg-opacity-10 transition-all">
                        <div class="text-5xl mb-3">📚</div>
                        <h4 class="text-xl font-bold mb-2">E-Magazine</h4>
                        <p class="text-orange-100 text-sm">Read & earn points</p>
                    </button>
                    <button onclick="changeButtonBackground('eMagazine')" class="admin-only absolute top-2 right-2 z-20 bg-white bg-opacity-20 hover:bg-opacity-40 text-white rounded-full p-2 text-xs transition-all hidden">
                        🖼️
                    </button>
                </div>
                
                <!-- Student Registration Button -->
                <div class="relative overflow-hidden rounded-xl shadow-lg transform hover:scale-105 transition-all">
                    <div id="studentRegBg" class="absolute inset-0 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 transition-all bg-cover bg-center"></div>
                    <button onclick="showStudentRegistrationModal()" class="relative z-10 w-full text-white p-6 text-center bg-black bg-opacity-20 hover:bg-opacity-10 transition-all">
                        <div class="text-5xl mb-3">🎓</div>
                        <h4 class="text-xl font-bold mb-2">Student Registration</h4>
                        <p class="text-blue-100 text-sm">Join as school student</p>
                    </button>
                    <button onclick="changeButtonBackground('studentReg')" class="admin-only absolute top-2 right-2 z-20 bg-white bg-opacity-20 hover:bg-opacity-40 text-white rounded-full p-2 text-xs transition-all hidden">
                        🖼️
                    </button>
                </div>
                
                <!-- Green Mover Button -->
                <div class="relative overflow-hidden rounded-xl shadow-lg transform hover:scale-105 transition-all">
                    <div id="greenMoverBg" class="absolute inset-0 bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 transition-all bg-cover bg-center"></div>
                    <button onclick="showGreenMoverModal()" class="relative z-10 w-full text-white p-6 text-center bg-black bg-opacity-20 hover:bg-opacity-10 transition-all">
                        <div class="text-5xl mb-3">🌟</div>
                        <h4 class="text-xl font-bold mb-2">Green Mover</h4>
                        <p class="text-purple-100 text-sm">Individual participation</p>
                    </button>
                    <button onclick="changeButtonBackground('greenMover')" class="admin-only absolute top-2 right-2 z-20 bg-white bg-opacity-20 hover:bg-opacity-40 text-white rounded-full p-2 text-xs transition-all hidden">
                        🖼️
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Core Features Section -->
    <section class="py-16 glass-effect nature-pattern relative overflow-hidden">
        <!-- Core Features Background -->
        <div id="coreFeaturesBg" class="absolute inset-0 bg-gradient-to-br from-green-100 to-blue-100"></div>
        
        <!-- Core Features Background Change Button (Admin Only) -->
        <button onclick="changeBannerBackground('coreFeatures')" class="admin-only absolute top-4 right-4 z-20 bg-white bg-opacity-60 hover:bg-opacity-80 text-gray-800 rounded-full p-2 text-xs transition-all hidden">
            🖼️ 更换背景
        </button>
        
        <div class="max-w-7xl mx-auto px-4 relative z-10">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">
                🎯 Core Features
            </h2>
            <p class="text-center text-gray-600 mb-12">
                Simple and effective environmental education platform focusing on essential functions
            </p>
            
            <!-- Core Features Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 text-center">
                    <div class="text-5xl mb-3">📝</div>
                    <h3 class="text-xl font-bold text-green-800 mb-3">My Green Movement</h3>
                    <p class="text-gray-600 mb-4 text-sm">AI-guided environmental experiences with real-time mentoring</p>
                    <button onclick="showEcoSubmissionModal()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold text-sm">
                        Start Submission
                    </button>
                </div>
                
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 text-center">
                    <div class="text-5xl mb-3">📚</div>
                    <h3 class="text-xl font-bold text-orange-800 mb-3">E-Magazine Reading</h3>
                    <p class="text-gray-600 mb-4 text-sm">Read ecological magazines and earn points for reviews</p>
                    <button onclick="showMagazineModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold text-sm">
                        Read & Review
                    </button>
                </div>
                
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 text-center">
                    <div class="text-5xl mb-3">🏫</div>
                    <h3 class="text-xl font-bold text-blue-800 mb-3">School Competition</h3>
                    <p class="text-gray-600 mb-4 text-sm">Monthly rankings with PAJSK international scores</p>
                    <button onclick="showCompetitionModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold text-sm">
                        View Rankings
                    </button>
                </div>
                
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 text-center">
                    <div class="text-5xl mb-3">🌟</div>
                    <h3 class="text-xl font-bold text-purple-800 mb-3">Green Mover Program</h3>
                    <p class="text-gray-600 mb-4 text-sm">Individual environmental champions and advocates</p>
                    <button onclick="showGreenMoverModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold text-sm">
                        Join Green Movers
                    </button>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="bg-gradient-to-r from-green-500 to-blue-600 rounded-xl text-white p-8 text-center">
                <h3 class="text-2xl font-bold mb-6">📊 Platform Statistics</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold">156</div>
                        <p class="text-xs">Students</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold">23</div>
                        <p class="text-xs">Schools</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold">42</div>
                        <p class="text-xs">Green Movers</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold">89</div>
                        <p class="text-xs">Submissions</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold">4.8</div>
                        <p class="text-xs">Avg Rating</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Competition Rankings Section -->
    <section class="py-16 section-bg relative overflow-hidden">
        <!-- Competition Rankings Background -->
        <div id="competitionBg" class="absolute inset-0 bg-gradient-to-br from-purple-200 to-pink-200"></div>
        
        <!-- Competition Rankings Background Change Button (Admin Only) -->
        <button onclick="changeBannerBackground('competition')" class="admin-only absolute top-4 right-4 z-20 bg-white bg-opacity-60 hover:bg-opacity-80 text-gray-800 rounded-full p-2 text-xs transition-all hidden">
            🖼️ 更换背景
        </button>
        
        <div class="max-w-7xl mx-auto px-4 relative z-10">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">
                    🏆 Competition Rankings & Individual Honors
                </h2>
                <p class="text-gray-600 mb-6">
                    Monthly competitions for schools and individual Green Mover recognition
                </p>
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="showCompetitionModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold">
                        School Rankings
                    </button>
                    <button onclick="showGreenMoverRankingsModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold">
                        Green Mover Honors
                    </button>
                </div>
            </div>
            
            <!-- Awards Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- School Awards -->
                <div>
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">🏫 School Competition Awards</h3>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-xl p-4 border-2 border-yellow-300">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">🥇</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-yellow-800">Gold Award Schools</h4>
                                    <p class="text-sm text-gray-600">SMK Damansara Jaya (87.5 avg) • SJKC Chong Hwa (84.2 avg)</p>
                                    <p class="text-xs text-yellow-700 font-semibold">Prize: Cash Award + Equipment + 生态文明认证奖状 + PAJSK国际分数</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 border-2 border-gray-300">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">🥈</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">Silver Award Schools</h4>
                                    <p class="text-sm text-gray-600">SMK Subang Jaya (76.8 avg) • SJKT Ladang Bukit Jalil (73.4 avg)</p>
                                    <p class="text-xs text-gray-700 font-semibold">Prize: Cash Award + Materials + 生态文明认证奖状 + PAJSK国际分数</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-4 border-2 border-orange-300">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">🥉</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-orange-800">Bronze Award Schools</h4>
                                    <p class="text-sm text-gray-600">SMK Bandar Utama (68.9 avg) • SK Taman Desa (65.3 avg)</p>
                                    <p class="text-xs text-orange-700 font-semibold">Prize: Cash Award + Supplies + 生态文明认证奖状 + PAJSK国际分数</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Green Mover Awards -->
                <div>
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">🌟 Green Mover Individual Honors</h3>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 border-2 border-purple-300">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">👑</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-purple-800">Environmental Champion</h4>
                                    <p class="text-sm text-gray-600">Sarah Chen • 95.2 avg score • 28 submissions</p>
                                    <p class="text-xs text-purple-700 font-semibold">World Green Movement Award: Certificate + Medal + Media</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-4 border-2 border-green-300">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">🌱</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-green-800">Eco Innovation Leader</h4>
                                    <p class="text-sm text-gray-600">Ahmad Rahman • 92.8 avg score • 22 submissions</p>
                                    <p class="text-xs text-green-700 font-semibold">World Green Movement Award: Certificate + Medal + Media</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4 border-2 border-blue-300">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">💚</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-blue-800">Community Impact Award</h4>
                                    <p class="text-sm text-gray-600">Priya Devi • 89.5 avg score • 19 submissions</p>
                                    <p class="text-xs text-blue-700 font-semibold">World Green Movement Award: Certificate + Medal + Media</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-6">
                            <button onclick="showGreenMoverRankingsModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold text-sm">
                                View All Green Mover Rankings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Enterprise Partnership Section -->
    <section class="py-16 glass-effect relative overflow-hidden">
        <!-- Enterprise Partnership Background -->
        <div id="partnershipBg" class="absolute inset-0 bg-gradient-to-br from-gray-100 to-blue-100"></div>
        
        <!-- Enterprise Partnership Background Change Button (Admin Only) -->
        <button onclick="changeBannerBackground('partnership')" class="admin-only absolute top-4 right-4 z-20 bg-white bg-opacity-60 hover:bg-opacity-80 text-gray-800 rounded-full p-2 text-xs transition-all hidden">
            🖼️ 更换背景
        </button>
        
        <div class="max-w-7xl mx-auto px-4 relative z-10">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">
                    🤝 Enterprise Partners
                </h2>
                <p class="text-gray-600">Supporting youth environmental education across Malaysia</p>
            </div>
            
            <!-- Current Sponsors -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12" id="sponsorsGrid">
                <!-- Sponsors will be loaded here -->
            </div>
            
            <!-- Partnership Benefits -->
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Become a Partner</h3>
                <p class="text-gray-600 mb-6">
                    Partner with us to support youth environmental education
                </p>
                <button onclick="showSponsorModal()" class="bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 text-white py-3 px-8 rounded-lg font-semibold">
                    Learn More About Partnership
                </button>
            </div>
        </div>
    </section>

    <!-- Eco Submission Modal -->
    <div id="ecoSubmissionModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">📝 My Green Movement</h3>
                    <button onclick="closeEcoSubmissionModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <form onsubmit="submitEcoArticle(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">Student Name</label>
                            <input type="text" id="studentName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Enter your name">
                        </div>
                        <div>
                            <label for="schoolName" class="block text-sm font-medium text-gray-700 mb-2">School Name</label>
                            <input type="text" id="schoolName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Enter your school name">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">Grade Level</label>
                            <select id="grade" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Grade</option>
                                <option value="kindergarten">Kindergarten (幼儿园)</option>
                                <option value="primary1">Primary 1 (小学一年级)</option>
                                <option value="primary2">Primary 2 (小学二年级)</option>
                                <option value="primary3">Primary 3 (小学三年级)</option>
                                <option value="primary4">Primary 4 (小学四年级)</option>
                                <option value="primary5">Primary 5 (小学五年级)</option>
                                <option value="primary6">Primary 6 (小学六年级)</option>
                                <option value="secondary1">Secondary 1 (中学一年级)</option>
                                <option value="secondary2">Secondary 2 (中学二年级)</option>
                                <option value="secondary3">Secondary 3 (中学三年级)</option>
                                <option value="secondary4">Secondary 4 (中学四年级)</option>
                                <option value="secondary5">Secondary 5 (中学五年级)</option>
                                <option value="form6">Form 6 (大学预科)</option>
                                <option value="diploma">Diploma (文凭课程)</option>
                                <option value="degree">Degree (学士学位)</option>
                                <option value="postgrad">Postgraduate (研究生)</option>
                            </select>
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">Green Movement Category</label>
                            <select id="category" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Category</option>
                                <option value="recycling">♻️ Waste Sorting & Recycling (废物分类回收)</option>
                                <option value="planting">🌱 Tree Planting & Gardening (植树种植)</option>
                                <option value="cleanup">🧹 Environmental Cleanup (环境清洁)</option>
                                <option value="conservation">💡 Energy/Water Conservation (节能节水)</option>
                                <option value="transport">🚲 Green Transportation (绿色出行)</option>
                                <option value="education">📚 Environmental Education (环保教育)</option>
                                <option value="innovation">🔬 Eco Innovation Project (生态创新)</option>
                                <option value="togetherness">🤝 Togetherness & Care (合作关怀)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Experience Title</label>
                        <input type="text" id="title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., My School Recycling Project Experience">
                    </div>
                    
                    <!-- Community Guidelines -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-blue-800 mb-3">🌟 Community Guidelines</h4>
                        <div class="space-y-2 text-sm text-blue-700">
                            <p><strong>✅ 我们鼓励的内容：</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>真实的环保体验分享</li>
                                <li>积极正面的环保行动</li>
                                <li>团队合作和互助精神</li>
                                <li>环保知识和技能学习</li>
                                <li>对环境保护的思考和感悟</li>
                            </ul>
                            <div class="bg-blue-100 p-3 rounded-lg mt-3">
                                <p class="font-bold text-blue-800">💡 内容建议：</p>
                                <p class="text-blue-700">• 分享您的真实体验和感受</p>
                                <p class="text-blue-700">• 用积极正面的语言表达</p>
                                <p class="text-blue-700">• 展现环保行动的积极影响</p>
                            </div>
                            <p class="font-bold text-blue-800 mt-3">🤖 AI助手会帮助您改进内容表达</p>
                        </div>
                    </div>

                    <!-- Photo Upload Section -->
                    <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6">
                        <h4 class="font-bold text-green-800 mb-3">📸 行动证明照片 (必须)</h4>
                        <p class="text-sm text-green-700 mb-4">上传显示您真实参与环保行动的照片。AI将验证行动真实性、原创性和内容安全性。</p>
                        
                        <div class="bg-blue-100 border border-blue-300 rounded-lg p-4 mb-4">
                            <h5 class="font-bold text-blue-800 mb-2">✅ 有效行动证明照片应包含：</h5>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• <strong>人员参与：</strong>您本人或团队正在进行环保活动</li>
                                <li>• <strong>行动过程：</strong>清晰显示环保行动的具体过程</li>
                                <li>• <strong>相关工具：</strong>使用的环保工具、设备或材料</li>
                                <li>• <strong>类别匹配：</strong>照片内容与所选环保类别相符</li>
                                <li>• <strong>原创拍摄：</strong>您亲自拍摄，非网络下载图片</li>
                            </ul>
                        </div>
                        
                        <div class="bg-red-100 border border-red-300 rounded-lg p-4 mb-4">
                            <h5 class="font-bold text-red-800 mb-2">❌ 以下照片将被AI拒绝：</h5>
                            <ul class="text-sm text-red-700 space-y-1">
                                <li>• <strong>纯风景照片：</strong>没有人员参与的自然风景</li>
                                <li>• <strong>无行动证据：</strong>静态展示，无实际环保行动</li>
                                <li>• <strong>网络图片：</strong>从互联网下载的图片</li>
                                <li>• <strong>类别不符：</strong>与所选环保类别无关的内容</li>
                                <li>• <strong>无意义照片：</strong>模糊、无关或无法证明环保行动</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="photoUpload" class="block text-sm font-medium text-gray-700 mb-2">Upload Photos (1-5 images)</label>
                                <input type="file" id="photoUpload" multiple accept="image/*" required class="w-full p-3 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500" onchange="handlePhotoUpload(event)">
                                <p class="text-xs text-gray-500 mt-1">Supported formats: JPG, PNG, HEIC. Max 5MB per image.</p>
                            </div>
                            
                            <div id="photoPreview" class="grid grid-cols-2 md:grid-cols-3 gap-4 hidden">
                                <!-- Photo previews will appear here -->
                            </div>
                            
                            <div id="aiPhotoStatus" class="hidden">
                                <div class="flex items-center space-x-2 text-sm">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600"></div>
                                    <span class="text-green-700">AI analyzing photos for authenticity and quality...</span>
                                </div>
                            </div>
                            
                            <div id="safetyCheckStatus" class="hidden">
                                <div class="bg-green-100 border border-green-300 rounded-lg p-3 mt-3">
                                    <div class="flex items-center space-x-2 text-sm">
                                        <span class="text-green-600">✅</span>
                                        <span class="text-green-700 font-semibold">Quality Check: PASSED</span>
                                    </div>
                                    <p class="text-xs text-green-600 mt-1">Photos verified as authentic environmental content.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Experience Description (体验描述)</label>
                        <textarea id="content" rows="8" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="简单描述您的环保体验：什么时候在哪里？为什么这样做？得到什么结果？有什么感想？AI会提供标准示例和表达指导。" oninput="checkContentSafety(this.value)"></textarea>
                        <p class="text-xs text-gray-500 mt-1">用您自己的话描述即可。AI会在提交后提供标准示例和表达升华指导。</p>
                        
                        <div id="contentSafetyStatus" class="hidden mt-2">
                            <div class="bg-red-100 border border-red-300 rounded-lg p-3">
                                <div class="flex items-center space-x-2 text-sm">
                                    <span class="text-red-600">⚠️</span>
                                    <span class="text-red-700 font-semibold">Content Safety Warning</span>
                                </div>
                                <p class="text-xs text-red-600 mt-1" id="safetyWarningMessage">Inappropriate content detected. Please revise your text.</p>
                            </div>
                        </div>
                        
                        <div id="contentSafetyPassed" class="hidden mt-2">
                            <div class="bg-green-100 border border-green-300 rounded-lg p-3">
                                <div class="flex items-center space-x-2 text-sm">
                                    <span class="text-green-600">✅</span>
                                    <span class="text-green-700 font-semibold">Content Quality: APPROVED</span>
                                </div>
                                <p class="text-xs text-green-600 mt-1">Content is ready for submission.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Content Enhancement Section -->
                    <div id="aiEnhancementSection" class="hidden bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                        <h4 class="font-bold text-blue-800 mb-3">🤖 AI语法修正与优化</h4>
                        <div id="aiProcessing" class="flex items-center space-x-2 text-sm mb-4">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                            <span class="text-blue-700">AI正在修正语法并优化表达...</span>
                        </div>
                        
                        <div id="enhancedContent" class="hidden">
                            <p class="text-sm text-blue-700 mb-3">AI已修正语法并优化了您的表达，让内容更加清晰流畅：</p>
                            <div class="bg-white rounded-lg p-4 border border-blue-200 mb-4">
                                <div id="enhancedText" class="text-gray-800"></div>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" onclick="acceptEnhancement()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    ✓ 使用修正版本 (按Enter键)
                                </button>
                                <button type="button" onclick="rejectEnhancement()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    ✗ 保持原文
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-bold text-green-800 mb-2">🔍 AI Review Process:</h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>• <strong>Content Safety Scan:</strong> Real-time monitoring for inappropriate content, bullying, or harmful material</li>
                            <li>• <strong>Photo Verification:</strong> AI checks image authenticity, originality, and content appropriateness</li>
                            <li>• <strong>Mental Health Protection:</strong> Filters emotional manipulation and content harmful to youth development</li>
                            <li>• <strong>Content Analysis:</strong> Originality check and plagiarism detection</li>
                            <li>• <strong>Enhancement Suggestions:</strong> AI improves clarity, structure, and impact (only after safety approval)</li>
                            <li>• <strong>Final Scoring:</strong> Comprehensive evaluation based on authenticity, impact, and presentation</li>
                        </ul>
                    </div>
                    
                    <div class="bg-red-50 rounded-lg p-4">
                        <h4 class="font-bold text-red-800 mb-2">🛡️ Youth Protection System:</h4>
                        <ul class="text-sm text-red-700 space-y-1">
                            <li>• <strong>24/7 AI Monitoring:</strong> Continuous content scanning for safety violations</li>
                            <li>• <strong>Blacklist System:</strong> Permanent ban for serious violations affecting youth safety</li>
                            <li>• <strong>Progressive Penalties:</strong> Warning → Suspension → Permanent Ban</li>
                            <li>• <strong>Community Reporting:</strong> Students and teachers can report inappropriate content</li>
                            <li>• <strong>Mental Health Focus:</strong> Special protection against cyberbullying and emotional harm</li>
                            <li>• <strong>Parent/Teacher Alerts:</strong> Automatic notifications for concerning behavior patterns</li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-bold text-blue-800 mb-2">🎓 AI教育引导系统：</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>• 📋 提供标准答案示例（时间地点、动机、结果、感悟）</li>
                            <li>• 🎯 个人表达升华指导（观察体验深化建议）</li>
                            <li>• ✅ 通过/检讨判定（无需评分，专注学习成长）</li>
                            <li>• 🏫 学校多样性统计（8大绿色行动环环相扣）</li>
                        </ul>
                    </div>
                    
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h4 class="font-bold text-purple-800 mb-2">🏆 学校获奖新标准：</h4>
                        <ul class="text-sm text-purple-700 space-y-1">
                            <li>• <strong>参与多样性：</strong>学校需要在8大绿色行动中展现多样性</li>
                            <li>• <strong>环环相扣：</strong>不能只专注单一行动（如只种树或只分类）</li>
                            <li>• <strong>合作关怀：</strong>特别重视团队合作和互相关怀的环保行动</li>
                            <li>• <strong>教育成长：</strong>重视学生的观察体验能力和表达升华</li>
                            <li>• <strong>持续参与：</strong>鼓励长期持续的环保行动参与</li>
                        </ul>
                    </div>
                    
                    <button type="submit" id="submitButton" disabled class="w-full bg-gray-400 text-white py-3 px-6 rounded-lg font-semibold cursor-not-allowed">
                        Upload Photos First
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Student Registration Modal -->
    <div id="studentRegistrationModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🎓 Student Registration</h3>
                    <button onclick="closeStudentRegistrationModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">🌱</div>
                    <p class="text-gray-600">Join Malaysia's ecological civilization action platform</p>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Participation Type</label>
                        <div class="flex justify-center space-x-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="participationType" value="school" checked onchange="toggleSchoolField()" class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">🏫 School Student</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="participationType" value="individual" onchange="toggleSchoolField()" class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">👤 Individual Student</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <form onsubmit="submitStudentRegistration(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="regStudentName" class="block text-sm font-medium text-gray-700 mb-2">Student Name</label>
                            <input type="text" id="regStudentName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Enter your full name">
                        </div>
                        <div id="schoolNameField">
                            <label for="regSchoolName" class="block text-sm font-medium text-gray-700 mb-2">School Name</label>
                            <input type="text" id="regSchoolName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Enter your complete school name">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="regGrade" class="block text-sm font-medium text-gray-700 mb-2">Grade Level</label>
                            <select id="regGrade" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Grade</option>
                                <option value="kindergarten">Kindergarten (幼儿园)</option>
                                <option value="primary1">Primary 1 (小学一年级)</option>
                                <option value="primary2">Primary 2 (小学二年级)</option>
                                <option value="primary3">Primary 3 (小学三年级)</option>
                                <option value="primary4">Primary 4 (小学四年级)</option>
                                <option value="primary5">Primary 5 (小学五年级)</option>
                                <option value="primary6">Primary 6 (小学六年级)</option>
                                <option value="secondary1">Secondary 1 (中学一年级)</option>
                                <option value="secondary2">Secondary 2 (中学二年级)</option>
                                <option value="secondary3">Secondary 3 (中学三年级)</option>
                                <option value="secondary4">Secondary 4 (中学四年级)</option>
                                <option value="secondary5">Secondary 5 (中学五年级)</option>
                                <option value="form6">Form 6 (大学预科)</option>
                                <option value="diploma">Diploma (文凭课程)</option>
                                <option value="degree">Degree (学士学位)</option>
                                <option value="postgrad">Postgraduate (研究生)</option>
                            </select>
                        </div>
                        <div>
                            <label for="regEmail" class="block text-sm font-medium text-gray-700 mb-2">Email (Optional)</label>
                            <input type="email" id="regEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="For platform notifications">
                        </div>
                    </div>
                    
                    <div>
                        <label for="interests" class="block text-sm font-medium text-gray-700 mb-2">Environmental Interests</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm">Waste Management</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm">Energy Conservation</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm">Water Conservation</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm">Green Transportation</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm">Tree Planting</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm">Environmental Education</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-bold text-green-800 mb-2">Platform Benefits:</h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>• AI-scored environmental submissions</li>
                            <li>• Growth points for university applications</li>
                            <li>• Peer feedback and collaboration</li>
                            <li id="schoolBenefit">• School competition participation (school students)</li>
                            <li id="individualBenefit" class="hidden">• Individual achievement tracking (individual students)</li>
                            <li>• Environmental education resources</li>
                            <li>• Certificate of participation</li>
                            <li>• <strong>Flexible transfer:</strong> Switch from individual to school participation anytime</li>
                        </ul>
                    </div>
                    
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h4 class="font-bold text-yellow-800 mb-2">🔄 School Transfer System:</h4>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>• <strong>Seamless Transfer:</strong> Individual students can join school competitions when their school registers</li>
                            <li>• <strong>Historical Preservation:</strong> All previous submissions and scores are permanently kept</li>
                            <li>• <strong>Retroactive Counting:</strong> Past individual scores automatically contribute to school rankings</li>
                            <li>• <strong>Dual Recognition:</strong> Students maintain both individual achievements and school contributions</li>
                            <li>• <strong>Annual Summary:</strong> Year-end awards consider full participation history</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold">
                        Register Now
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- School Registration Modal -->
    <div id="schoolRegistrationModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🏫 School Registration</h3>
                    <button onclick="closeSchoolRegistrationModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <form onsubmit="submitSchoolRegistration(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="fullSchoolName" class="block text-sm font-medium text-gray-700 mb-2">Full School Name</label>
                            <input type="text" id="fullSchoolName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., SMK Damansara Jaya">
                        </div>
                        <div>
                            <label for="schoolType" class="block text-sm font-medium text-gray-700 mb-2">School Type</label>
                            <select id="schoolType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Type</option>
                                <option value="kindergarten">Kindergarten (幼儿园)</option>
                                <option value="sk">National Primary School (SK)</option>
                                <option value="sjkc">Chinese Primary School (SJKC)</option>
                                <option value="sjkt">Tamil Primary School (SJKT)</option>
                                <option value="smk">National Secondary School (SMK)</option>
                                <option value="smjk">Chinese Independent Secondary School (SMJK)</option>
                                <option value="private_primary">Private Primary School</option>
                                <option value="private_secondary">Private Secondary School</option>
                                <option value="international">International School</option>
                                <option value="college">College (学院)</option>
                                <option value="university_public">Public University (公立大学)</option>
                                <option value="university_private">Private University (私立大学)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <select id="state" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select State</option>
                                <option value="selangor">Selangor</option>
                                <option value="kl">Kuala Lumpur</option>
                                <option value="johor">Johor</option>
                                <option value="penang">Penang</option>
                                <option value="perak">Perak</option>
                                <option value="sabah">Sabah</option>
                                <option value="sarawak">Sarawak</option>
                                <option value="other">Other States</option>
                            </select>
                        </div>
                        <div>
                            <label for="studentCount" class="block text-sm font-medium text-gray-700 mb-2">Student Population</label>
                            <select id="studentCount" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">Select Size</option>
                                <option value="small">Small (Less than 500)</option>
                                <option value="medium">Medium (500-1000)</option>
                                <option value="large">Large (1000-2000)</option>
                                <option value="xlarge">Extra Large (2000+)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="contactPerson" class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                            <input type="text" id="contactPerson" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Teacher or administrator name">
                        </div>
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                            <input type="text" id="position" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., Environmental Club Advisor">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="contactEmail" class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                            <input type="email" id="contactEmail" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-2">Contact Phone</label>
                            <input type="tel" id="contactPhone" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="applicationReason" class="block text-sm font-medium text-gray-700 mb-2">Application Reason</label>
                        <textarea id="applicationReason" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Please explain why you want to register your school and how you plan to use this platform..."></textarea>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-bold text-blue-800 mb-2">School Administrator Access Includes:</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>• Generate school-specific participation links</li>
                            <li>• View student participation statistics</li>
                            <li>• Manage school environmental activities</li>
                            <li>• Download school competition reports</li>
                            <li>• Set school environmental goals</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold">
                        Submit Application
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- School Login Modal -->
    <div id="schoolLoginModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🏫 School Administrator Login</h3>
                    <button onclick="closeSchoolLoginModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">🎓</div>
                    <p class="text-gray-600">School administrator management portal</p>
                </div>
                
                <form onsubmit="handleSchoolLogin(event)" class="space-y-4">
                    <div>
                        <label for="schoolCode" class="block text-sm font-medium text-gray-700 mb-2">School Code</label>
                        <input type="text" id="schoolCode" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g., SMK001">
                    </div>
                    <div>
                        <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-2">Administrator Password</label>
                        <input type="password" id="adminPassword" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold">
                        Login to Management Portal
                    </button>
                </form>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-3">Don't have a school account?</h4>
                    <button onclick="showSchoolRegistrationFromLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm">
                        Apply for School Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Competition Modal -->
    <div id="competitionModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-6xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🏆 School Competition Details</h3>
                    <button onclick="closeCompetitionModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <!-- Competition Rules -->
                <div class="mb-8">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">Competition Rules & Historical Records</h4>
                    <div class="bg-blue-50 rounded-lg p-6">
                        <ul class="space-y-2 text-gray-700">
                            <li>• Students must include school name when submitting</li>
                            <li>• AI system automatically scores submissions (0-100 points)</li>
                            <li>• School rankings calculated by average score of all student submissions</li>
                            <li>• Gold Award: 80-100 points, Silver Award: 70-79 points, Bronze Award: 60-69 points</li>
                            <li>• Monthly evaluation with cash prizes and awards</li>
                            <li>• All schools participate equally regardless of size</li>
                        </ul>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-6 mt-4">
                        <h5 class="font-bold text-green-800 mb-3">🔄 Individual-to-School Transfer System</h5>
                        <ul class="space-y-2 text-gray-700">
                            <li>• <strong>Automatic Transfer:</strong> When schools register, their individual students are automatically identified and transferred</li>
                            <li>• <strong>Historical Integration:</strong> All previous individual submissions immediately count toward school rankings</li>
                            <li>• <strong>Retroactive Scoring:</strong> Past scores contribute to school's average from the moment of school registration</li>
                            <li>• <strong>Permanent Records:</strong> Individual achievement history is never deleted, always accessible</li>
                            <li>• <strong>Annual Awards:</strong> Year-end recognition includes full participation history (individual + school periods)</li>
                            <li>• <strong>Dual Recognition:</strong> Students receive both individual achievement certificates and school competition awards</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Detailed Rankings Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">School Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Students</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prize</th>
                            </tr>
                        </thead>
                        <tbody id="rankingsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rankings will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sponsor Modal -->
    <div id="sponsorModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🏢 Enterprise Sponsorship</h3>
                    <button onclick="closeSponsorModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Sponsorship Benefits -->
                    <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Sponsorship Benefits</h4>
                        <div class="space-y-4">
                            <div class="flex items-start space-x-3">
                                <span class="text-2xl">🎯</span>
                                <div>
                                    <h5 class="font-bold text-gray-700">Brand Exposure</h5>
                                    <p class="text-sm text-gray-600">Logo display on platform homepage and all activity materials</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <span class="text-2xl">📊</span>
                                <div>
                                    <h5 class="font-bold text-gray-700">Data Reports</h5>
                                    <p class="text-sm text-gray-600">Detailed user engagement and environmental impact data</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <span class="text-2xl">🤝</span>
                                <div>
                                    <h5 class="font-bold text-gray-700">CSR Collaboration</h5>
                                    <p class="text-sm text-gray-600">Corporate social responsibility project opportunities</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <span class="text-2xl">🌟</span>
                                <div>
                                    <h5 class="font-bold text-gray-700">Media Publicity</h5>
                                    <p class="text-sm text-gray-600">Recognition in award ceremonies and media coverage</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sponsorship Form -->
                    <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Sponsorship Application</h4>
                        <form onsubmit="submitSponsorApplication(event)" class="space-y-4">
                            <div>
                                <label for="companyName" class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                                <input type="text" id="companyName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="contactPersonSponsor" class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                                <input type="text" id="contactPersonSponsor" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="emailSponsor" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="emailSponsor" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="phoneSponsor" class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="phoneSponsor" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="sponsorshipLevel" class="block text-sm font-medium text-gray-700 mb-2">Sponsorship Level</label>
                                <select id="sponsorshipLevel" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Please Select</option>
                                    <option value="platinum">Platinum Sponsor</option>
                                    <option value="gold">Gold Sponsor</option>
                                    <option value="silver">Silver Sponsor</option>
                                    <option value="bronze">Bronze Sponsor</option>
                                </select>
                            </div>
                            <div>
                                <label for="cooperationIntention" class="block text-sm font-medium text-gray-700 mb-2">Cooperation Intention</label>
                                <textarea id="cooperationIntention" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Please describe your cooperation intentions and expectations..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold">
                                Submit Application
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Green Mover Registration Modal -->
    <div id="greenMoverModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🌟 Green Mover Registration</h3>
                    <button onclick="closeGreenMoverModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">🌟</div>
                    <p class="text-gray-600">For individuals who have left university - join the prestigious World Green Movement Award program!</p>
                </div>
                
                <form onsubmit="submitGreenMoverRegistration(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="greenMoverName" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="greenMoverName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter your full name">
                        </div>
                        <div>
                            <label for="greenMoverAge" class="block text-sm font-medium text-gray-700 mb-2">Age</label>
                            <select id="greenMoverAge" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Select Age Range</option>
                                <option value="18-25">18-25 years old (已离开学校)</option>
                                <option value="26-35">26-35 years old</option>
                                <option value="36-50">36-50 years old</option>
                                <option value="50+">50+ years old</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="greenMoverLocation" class="block text-sm font-medium text-gray-700 mb-2">Location (State)</label>
                            <select id="greenMoverLocation" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Select State</option>
                                <option value="selangor">Selangor</option>
                                <option value="kl">Kuala Lumpur</option>
                                <option value="johor">Johor</option>
                                <option value="penang">Penang</option>
                                <option value="perak">Perak</option>
                                <option value="sabah">Sabah</option>
                                <option value="sarawak">Sarawak</option>
                                <option value="other">Other States</option>
                            </select>
                        </div>
                        <div>
                            <label for="greenMoverEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="greenMoverEmail" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="For platform notifications">
                        </div>
                    </div>
                    
                    <div>
                        <label for="greenMoverBackground" class="block text-sm font-medium text-gray-700 mb-2">Background/Profession</label>
                        <select id="greenMoverBackground" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Select Background</option>
                            <option value="working">Working Professional (在职人员)</option>
                            <option value="educator">Educator/Teacher (教育工作者)</option>
                            <option value="activist">Environmental Activist (环保活动家)</option>
                            <option value="entrepreneur">Entrepreneur (企业家)</option>
                            <option value="freelancer">Freelancer (自由职业者)</option>
                            <option value="retiree">Retiree (退休人员)</option>
                            <option value="homemaker">Homemaker (家庭主妇/夫)</option>
                            <option value="other">Other (其他)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="greenMoverExperience" class="block text-sm font-medium text-gray-700 mb-2">Environmental Experience</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm">Waste Management</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm">Energy Conservation</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm">Water Conservation</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm">Sustainable Living</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm">Community Organizing</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm">Environmental Education</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label for="greenMoverMotivation" class="block text-sm font-medium text-gray-700 mb-2">Why do you want to be a Green Mover?</label>
                        <textarea id="greenMoverMotivation" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Share your motivation for joining as an individual environmental champion..."></textarea>
                    </div>
                    
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h4 class="font-bold text-purple-800 mb-2">Green Mover Benefits:</h4>
                        <ul class="text-sm text-purple-700 space-y-1">
                            <li>• <strong>World Green Movement Award</strong> - Annual prestigious recognition</li>
                            <li>• Official certificate and commemorative medal</li>
                            <li>• National and international media exposure</li>
                            <li>• Personal environmental impact tracking</li>
                            <li>• Direct mentorship opportunities</li>
                            <li>• Community leadership roles</li>
                            <li>• Professional networking opportunities</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold">
                        Join as Green Mover
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Green Mover Rankings Modal -->
    <div id="greenMoverRankingsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-6xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🌟 Green Mover Individual Rankings</h3>
                    <button onclick="closeGreenMoverRankingsModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <!-- Green Mover Categories -->
                <div class="mb-8">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">Recognition Categories</h4>
                    <div class="bg-purple-50 rounded-lg p-6">
                        <ul class="space-y-2 text-gray-700">
                            <li>• <strong>Environmental Champion:</strong> Highest overall score (90+ average)</li>
                            <li>• <strong>Eco Innovation Leader:</strong> Most creative and innovative submissions</li>
                            <li>• <strong>Community Impact Award:</strong> Greatest community engagement and influence</li>
                            <li>• <strong>Consistency Award:</strong> Regular participation and sustained quality</li>
                            <li>• <strong>Youth Leader:</strong> Outstanding performance by participants under 25</li>
                            <li>• <strong>Mentor Award:</strong> Exceptional guidance and support to other participants</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Detailed Rankings Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submissions</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average Score</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">World Green Movement Award</th>
                            </tr>
                        </thead>
                        <tbody id="greenMoverRankingsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rankings will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- E-Magazine Modal -->
    <div id="magazineModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-6xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">📚 生态文明电子杂志</h3>
                    <button onclick="closeMagazineModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <!-- Magazine Upload Section (Admin Only) -->
                <div id="adminMagazineUpload" class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-8 hidden">
                    <h4 class="text-xl font-bold text-blue-800 mb-4">📤 管理员上传电子杂志</h4>
                    <form onsubmit="uploadMagazine(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="magazineTitle" class="block text-sm font-medium text-gray-700 mb-2">杂志标题</label>
                                <input type="text" id="magazineTitle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="例如：生态文明学校第1期">
                            </div>
                            <div>
                                <label for="magazineIssue" class="block text-sm font-medium text-gray-700 mb-2">期数</label>
                                <input type="text" id="magazineIssue" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="例如：第1期">
                            </div>
                        </div>
                        <div>
                            <label for="magazineUrl" class="block text-sm font-medium text-gray-700 mb-2">Visual Paradigm 电子杂志链接</label>
                            <input type="url" id="magazineUrl" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="https://online.visual-paradigm.com/share/book/...">
                        </div>
                        <div>
                            <label for="magazineDescription" class="block text-sm font-medium text-gray-700 mb-2">杂志简介</label>
                            <textarea id="magazineDescription" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="简要描述杂志内容..."></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="readingPoints" class="block text-sm font-medium text-gray-700 mb-2">阅读积分</label>
                                <input type="number" id="readingPoints" min="1" max="50" value="10" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="reviewPoints" class="block text-sm font-medium text-gray-700 mb-2">读后感积分</label>
                                <input type="number" id="reviewPoints" min="1" max="100" value="25" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold">
                            📤 上传电子杂志
                        </button>
                    </form>
                </div>
                
                <!-- Available Magazines -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-xl font-bold text-gray-800">📖 可阅读杂志</h4>
                        <button onclick="toggleAdminUpload()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                            🔧 管理员模式
                        </button>
                    </div>
                    
                    <div id="magazinesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Magazines will be loaded here -->
                    </div>
                </div>
                
                <!-- Comprehensive Ecological Civilization School Certification System -->
                <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-xl p-8 border-2 border-green-200">
                    <h4 class="text-2xl font-bold text-green-800 mb-6 text-center">🏆 生态文明学校认证积分系统</h4>
                    
                    <!-- Official Certification Formula -->
                    <div class="bg-white rounded-lg p-6 mb-6 border-2 border-blue-300">
                        <h5 class="text-xl font-bold text-blue-800 mb-4 text-center">📐 官方认证计算公式</h5>
                        <div class="bg-blue-50 p-4 rounded-lg text-center mb-4">
                            <p class="text-lg font-bold text-blue-900">学校生态文明指数 = (A + B + C) × D × E</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-green-50 p-3 rounded-lg">
                                <p class="font-bold text-green-800">A = 绿色行动积分</p>
                                <p class="text-green-700">• 学生环保体验提交：20-105分/篇</p>
                                <p class="text-green-700">• 照片真实性验证：+5分奖励</p>
                                <p class="text-green-700">• AI内容质量评估：影响最终得分</p>
                            </div>
                            <div class="bg-orange-50 p-3 rounded-lg">
                                <p class="font-bold text-orange-800">B = 阅读学习积分</p>
                                <p class="text-orange-700">• 杂志阅读验证：15-25分/期</p>
                                <p class="text-orange-700">• 读后感提交：25-55分/篇</p>
                                <p class="text-orange-700">• 深度阅读奖励：+5分</p>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <p class="font-bold text-purple-800">C = 持续参与积分</p>
                                <p class="text-purple-700">• 月度活跃奖励：20分/月</p>
                                <p class="text-purple-700">• 连续参与奖励：累进制</p>
                                <p class="text-purple-700">• 同伴互助奖励：10分/次</p>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <p class="font-bold text-yellow-800">D = 参与率系数</p>
                                <p class="text-yellow-700">• 学生参与率 ≥ 80%：1.2倍</p>
                                <p class="text-yellow-700">• 学生参与率 60-79%：1.1倍</p>
                                <p class="text-yellow-700">• 学生参与率 40-59%：1.0倍</p>
                                <p class="text-yellow-700">• 学生参与率 < 40%：0.8倍</p>
                            </div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg mt-4">
                            <p class="font-bold text-red-800">E = 质量保证系数</p>
                            <p class="text-red-700">• 无违规记录：1.0倍 | 轻微违规：0.9倍 | 严重违规：0.7倍</p>
                        </div>
                    </div>
                    
                    <!-- Certification Levels -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 p-4 rounded-lg border-2 border-yellow-400">
                            <div class="text-center">
                                <div class="text-4xl mb-2">🥇</div>
                                <h6 class="font-bold text-yellow-800">金牌生态文明学校</h6>
                                <p class="text-sm text-yellow-700 mt-2">≥ 8000分</p>
                                <p class="text-xs text-yellow-600">现金奖励 + 设备 + 国际认证</p>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-gray-100 to-gray-200 p-4 rounded-lg border-2 border-gray-400">
                            <div class="text-center">
                                <div class="text-4xl mb-2">🥈</div>
                                <h6 class="font-bold text-gray-800">银牌生态文明学校</h6>
                                <p class="text-sm text-gray-700 mt-2">6000-7999分</p>
                                <p class="text-xs text-gray-600">现金奖励 + 教材 + 国际认证</p>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-100 to-orange-200 p-4 rounded-lg border-2 border-orange-400">
                            <div class="text-center">
                                <div class="text-4xl mb-2">🥉</div>
                                <h6 class="font-bold text-orange-800">铜牌生态文明学校</h6>
                                <p class="text-sm text-orange-700 mt-2">4000-5999分</p>
                                <p class="text-xs text-orange-600">现金奖励 + 用品 + 国际认证</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fair Competition Principles -->
                    <div class="bg-white rounded-lg p-6 border-2 border-green-300">
                        <h5 class="font-bold text-green-800 mb-3 text-center">⚖️ 公平竞争原则</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <h6 class="font-bold text-green-700 mb-2">🎯 规模公平性：</h6>
                                <ul class="text-green-600 space-y-1">
                                    <li>• 大学校（>1000人）：需要更高总分</li>
                                    <li>• 中学校（500-1000人）：标准计算</li>
                                    <li>• 小学校（<500人）：参与率加权</li>
                                    <li>• 特殊学校：个别评估标准</li>
                                </ul>
                            </div>
                            <div>
                                <h6 class="font-bold text-green-700 mb-2">📊 质量保证：</h6>
                                <ul class="text-green-600 space-y-1">
                                    <li>• AI多重验证防止作弊</li>
                                    <li>• 照片原创性检测</li>
                                    <li>• 内容抄袭监测</li>
                                    <li>• 异常行为自动标记</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Progress Tracking -->
                    <div class="bg-blue-50 rounded-lg p-4 mt-4">
                        <h5 class="font-bold text-blue-800 mb-2 text-center">📈 月度进度追踪</h5>
                        <div class="text-sm text-blue-700 text-center">
                            <p>• 每月15日发布学校排名更新</p>
                            <p>• 实时积分计算和透明度报告</p>
                            <p>• 年终综合评估和国际认证申请</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Magazine Reading Modal -->
    <div id="magazineReadingModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-5xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800" id="readingMagazineTitle">📚 阅读杂志</h3>
                    <button onclick="closeMagazineReadingModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <!-- Magazine Viewer -->
                <div class="mb-6">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-gray-800">📖 杂志阅读器</h4>
                            <div class="flex space-x-2">
                                <button onclick="toggleFullscreen()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    🔍 全屏阅读
                                </button>
                                <button onclick="openMagazineInNewTab()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                    🔗 新窗口打开
                                </button>
                            </div>
                        </div>
                        
                        <!-- Enhanced Magazine Display -->
                        <div id="magazineContainer" class="relative bg-white rounded-lg shadow-lg overflow-hidden">
                            <!-- Loading State -->
                            <div id="magazineLoading" class="flex items-center justify-center h-96 bg-gray-50">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                    <p class="text-gray-600">正在加载电子杂志...</p>
                                </div>
                            </div>
                            
                            <!-- Magazine Iframe -->
                            <iframe 
                                id="magazineViewer" 
                                src="" 
                                class="w-full h-96 border-0 hidden" 
                                frameborder="0"
                                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                                onload="handleMagazineLoad()"
                                onerror="handleMagazineError()">
                            </iframe>
                            
                            <!-- Error State -->
                            <div id="magazineError" class="hidden p-8 text-center bg-yellow-50">
                                <div class="text-4xl mb-4">⚠️</div>
                                <h4 class="font-bold text-yellow-800 mb-2">杂志加载遇到问题</h4>
                                <p class="text-yellow-700 mb-4">某些电子杂志可能需要在新窗口中打开以获得最佳阅读体验</p>
                                <button onclick="openMagazineInNewTab()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-semibold">
                                    🔗 在新窗口中打开杂志
                                </button>
                            </div>
                            
                            <!-- Alternative Display -->
                            <div id="magazineAlternative" class="hidden p-6 bg-blue-50">
                                <div class="text-center mb-4">
                                    <div class="text-5xl mb-3" id="altMagazineCover">📚</div>
                                    <h4 class="font-bold text-blue-800 mb-2" id="altMagazineTitle">杂志标题</h4>
                                    <p class="text-blue-700 mb-4" id="altMagazineDesc">杂志描述</p>
                                </div>
                                
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <h5 class="font-bold text-gray-800 mb-2">📋 杂志内容预览</h5>
                                    <ul class="text-sm text-gray-700 space-y-1" id="magazineContents">
                                        <li>• 生态文明教育理念与实践</li>
                                        <li>• 学校环保项目案例分析</li>
                                        <li>• 青少年环保行动指南</li>
                                        <li>• 可持续发展目标解读</li>
                                        <li>• 环保创新技术介绍</li>
                                    </ul>
                                </div>
                                
                                <div class="text-center">
                                    <button onclick="openMagazineInNewTab()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold text-lg">
                                        📖 开始完整阅读
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reading Progress -->
                        <div class="mt-4 bg-white rounded-lg p-3">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">阅读进度</span>
                                <span class="text-blue-600 font-semibold" id="readingProgress">准备开始</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reading Confirmation -->
                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6 mb-6">
                    <h4 class="font-bold text-green-800 mb-3">📖 阅读确认</h4>
                    <p class="text-sm text-green-700 mb-4">请确认您已完整阅读此杂志，然后点击下方按钮获得阅读积分。</p>
                    <button onclick="confirmReading()" id="confirmReadingBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold">
                        ✅ 确认已完整阅读 (+<span id="readingPointsDisplay">10</span>积分)
                    </button>
                </div>
                
                <!-- Review Submission -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                    <h4 class="font-bold text-blue-800 mb-3">✍️ 提交读后感</h4>
                    <form onsubmit="submitMagazineReview(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="reviewerName" class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                                <input type="text" id="reviewerName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="请输入您的姓名">
                            </div>
                            <div>
                                <label for="reviewerSchool" class="block text-sm font-medium text-gray-700 mb-2">学校名称</label>
                                <input type="text" id="reviewerSchool" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="请输入学校名称（可选）">
                            </div>
                        </div>
                        <div>
                            <label for="magazineReview" class="block text-sm font-medium text-gray-700 mb-2">读后感内容</label>
                            <textarea id="magazineReview" rows="6" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="请分享您阅读此杂志后的感想、学到的知识、以及如何应用到环保行动中..."></textarea>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <p class="text-sm text-blue-800"><strong>💡 写作建议：</strong></p>
                            <ul class="text-xs text-blue-700 mt-1 space-y-1">
                                <li>• 分享您最印象深刻的内容</li>
                                <li>• 描述您学到的新知识或技能</li>
                                <li>• 说明如何将所学应用到实际环保行动中</li>
                                <li>• 表达对生态文明建设的想法和建议</li>
                            </ul>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold">
                            📝 提交读后感 (+<span id="reviewPointsDisplay">25</span>积分)
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Background Image Upload Modal -->
    <div id="backgroundUploadModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🖼️ 更换背景图片</h3>
                    <button onclick="closeBackgroundUploadModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3" id="currentButtonIcon">📝</div>
                    <h4 class="text-lg font-bold text-gray-800 mb-2" id="currentButtonName">My Green Movement</h4>
                    <p class="text-gray-600 text-sm">为此按钮选择自定义背景图片</p>
                </div>
                
                <div class="space-y-4">
                    <!-- Image Upload -->
                    <div>
                        <label for="backgroundImageUpload" class="block text-sm font-medium text-gray-700 mb-2">上传图片</label>
                        <input type="file" id="backgroundImageUpload" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="handleBackgroundImageUpload(event)">
                        <p class="text-xs text-gray-500 mt-1">支持格式：JPG, PNG, WebP。建议尺寸：400x300px</p>
                    </div>
                    
                    <!-- Preview -->
                    <div id="backgroundPreview" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">预览效果</label>
                        <div class="relative overflow-hidden rounded-xl shadow-lg">
                            <div id="previewBackground" class="h-32 bg-cover bg-center"></div>
                            <div class="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center">
                                <div class="text-center text-white">
                                    <div class="text-3xl mb-2" id="previewIcon">📝</div>
                                    <h4 class="font-bold" id="previewTitle">My Green Movement</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opacity Control -->
                    <div id="opacityControl" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">背景透明度</label>
                        <input type="range" id="backgroundOpacity" class="w-full" min="0.3" max="1" step="0.1" value="1" oninput="updateBackgroundOpacity(this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>透明</span>
                            <span>不透明</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-3 pt-4">
                        <button onclick="applyBackgroundImage()" id="applyBackgroundBtn" disabled class="flex-1 bg-gray-400 text-white py-3 px-4 rounded-lg font-semibold cursor-not-allowed">
                            ✅ 应用背景
                        </button>
                        <button onclick="resetToGradient()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-3 px-4 rounded-lg font-semibold">
                            🔄 恢复渐变
                        </button>
                    </div>
                </div>
                
                <!-- Preset Backgrounds -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-3">🎨 预设背景</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="applyPresetBackground('nature')" class="h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-lg flex items-center justify-center text-white text-xs font-semibold hover:scale-105 transition-transform">
                            🌿 自然
                        </button>
                        <button onclick="applyPresetBackground('ocean')" class="h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center text-white text-xs font-semibold hover:scale-105 transition-transform">
                            🌊 海洋
                        </button>
                        <button onclick="applyPresetBackground('sunset')" class="h-16 bg-gradient-to-br from-orange-400 to-pink-500 rounded-lg flex items-center justify-center text-white text-xs font-semibold hover:scale-105 transition-transform">
                            🌅 日落
                        </button>
                        <button onclick="applyPresetBackground('forest')" class="h-16 bg-gradient-to-br from-green-600 to-green-800 rounded-lg flex items-center justify-center text-white text-xs font-semibold hover:scale-105 transition-transform">
                            🌲 森林
                        </button>
                        <button onclick="applyPresetBackground('sky')" class="h-16 bg-gradient-to-br from-blue-300 to-blue-500 rounded-lg flex items-center justify-center text-white text-xs font-semibold hover:scale-105 transition-transform">
                            ☁️ 天空
                        </button>
                        <button onclick="applyPresetBackground('earth')" class="h-16 bg-gradient-to-br from-yellow-600 to-orange-700 rounded-lg flex items-center justify-center text-white text-xs font-semibold hover:scale-105 transition-transform">
                            🌍 大地
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Access Modal -->
    <div id="adminAccessModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">🔐 管理员访问验证</h3>
                    <button onclick="closeAdminAccessModal()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">🛡️</div>
                    <p class="text-gray-600">请输入管理员密码以访问自定义功能</p>
                </div>
                
                <form onsubmit="verifyAdminAccess(event)" class="space-y-4">
                    <div>
                        <label for="adminAccessPassword" class="block text-sm font-medium text-gray-700 mb-2">管理员密码</label>
                        <input type="password" id="adminAccessPassword" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="请输入密码">
                        <p class="text-xs text-gray-500 mt-1">提示：默认密码是 "admin2024"</p>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <h4 class="font-bold text-yellow-800 text-sm mb-2">⚠️ 管理员功能说明</h4>
                        <ul class="text-xs text-yellow-700 space-y-1">
                            <li>• 自定义所有按钮和区域背景图片</li>
                            <li>• 上传和编辑MECCC Logo</li>
                            <li>• 上传电子杂志内容</li>
                            <li>• 访问高级自定义选项</li>
                        </ul>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <h4 class="font-bold text-red-800 text-sm mb-2">🚨 安全提醒</h4>
                        <ul class="text-xs text-red-700 space-y-1">
                            <li>• 管理员功能仅供授权人员使用</li>
                            <li>• 请勿与他人分享管理员密码</li>
                            <li>• 使用完毕后请退出管理员模式</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold">
                        🔓 验证并进入管理员模式
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <button onclick="closeAdminAccessModal()" class="text-gray-500 hover:text-gray-700 text-sm">
                        取消访问
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Edit Toolbar -->
    <div id="textEditToolbar" class="fixed top-20 right-4 bg-white rounded-xl shadow-xl border-2 border-yellow-400 hidden z-50" style="max-width: 280px;">
        <!-- Draggable Header -->
        <div id="toolbarHeader" class="bg-yellow-400 text-gray-800 p-3 rounded-t-xl cursor-move select-none flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-sm font-bold">✏️ 文字编辑工具</span>
                <span class="text-xs opacity-75">(可拖拽)</span>
            </div>
            <div class="flex space-x-1">
                <button onclick="toggleToolbarCollapse()" class="hover:bg-yellow-500 rounded px-2 py-1 text-xs font-bold" id="collapseBtn">
                    ➖
                </button>
                <button onclick="toggleTextEditMode()" class="hover:bg-yellow-500 rounded px-2 py-1 text-xs font-bold">
                    ✕
                </button>
            </div>
        </div>
        
        <!-- Collapsible Content -->
        <div id="toolbarContent" class="p-4">
            <div class="text-center mb-3">
                <p class="text-xs text-gray-600">点击文字编辑，Enter保存，Esc取消</p>
            </div>
        
        <div class="space-y-3">
            <!-- Undo/Redo Controls -->
            <div class="bg-red-50 rounded-lg p-3">
                <h5 class="font-bold text-red-800 text-sm mb-2">↩️ 撤销/重做</h5>
                <div class="flex space-x-2">
                    <button onclick="undoChange()" id="undoBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        ↩️ 撤销
                    </button>
                    <button onclick="redoChange()" id="redoBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        ↪️ 重做
                    </button>
                </div>
                <p class="text-xs text-red-600 mt-1" id="historyStatus">无历史记录</p>
            </div>
            
            <!-- Font Size Controls -->
            <div class="bg-blue-50 rounded-lg p-3">
                <h5 class="font-bold text-blue-800 text-sm mb-2">📏 字体大小</h5>
                <div class="flex space-x-2">
                    <button onclick="changeFontSize('smaller')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                        A-
                    </button>
                    <button onclick="changeFontSize('larger')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                        A+
                    </button>
                    <button onclick="resetFontSize()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs">
                        重置
                    </button>
                </div>
            </div>
            
            <!-- Text Style Controls -->
            <div class="bg-green-50 rounded-lg p-3">
                <h5 class="font-bold text-green-800 text-sm mb-2">🎨 文字样式</h5>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="toggleBold()" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                        <strong>粗体</strong>
                    </button>
                    <button onclick="toggleItalic()" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                        <em>斜体</em>
                    </button>
                </div>
            </div>
            
            <!-- Emoji Picker -->
            <div class="bg-purple-50 rounded-lg p-3">
                <h5 class="font-bold text-purple-800 text-sm mb-2">😊 表情符号</h5>
                <div class="grid grid-cols-6 gap-1 text-lg">
                    <button onclick="insertEmoji('🌱')" class="hover:bg-purple-200 rounded p-1">🌱</button>
                    <button onclick="insertEmoji('📚')" class="hover:bg-purple-200 rounded p-1">📚</button>
                    <button onclick="insertEmoji('🏫')" class="hover:bg-purple-200 rounded p-1">🏫</button>
                    <button onclick="insertEmoji('🌟')" class="hover:bg-purple-200 rounded p-1">🌟</button>
                    <button onclick="insertEmoji('🎯')" class="hover:bg-purple-200 rounded p-1">🎯</button>
                    <button onclick="insertEmoji('🏆')" class="hover:bg-purple-200 rounded p-1">🏆</button>
                    <button onclick="insertEmoji('💚')" class="hover:bg-purple-200 rounded p-1">💚</button>
                    <button onclick="insertEmoji('✅')" class="hover:bg-purple-200 rounded p-1">✅</button>
                    <button onclick="insertEmoji('🎉')" class="hover:bg-purple-200 rounded p-1">🎉</button>
                    <button onclick="insertEmoji('🔧')" class="hover:bg-purple-200 rounded p-1">🔧</button>
                    <button onclick="insertEmoji('⚡')" class="hover:bg-purple-200 rounded p-1">⚡</button>
                    <button onclick="insertEmoji('🌍')" class="hover:bg-purple-200 rounded p-1">🌍</button>
                </div>
                <button onclick="showEmojiPicker()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs mt-2">
                    更多表情...
                </button>
            </div>
            
            <!-- Text Actions -->
            <div class="bg-orange-50 rounded-lg p-3">
                <h5 class="font-bold text-orange-800 text-sm mb-2">📝 文字操作</h5>
                <div class="space-y-2">
                    <button onclick="addTextElement()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs">
                        ➕ 添加文字
                    </button>
                    <button onclick="deleteSelectedText()" class="w-full bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                        🗑️ 删除选中文字
                    </button>
                </div>
            </div>
            
            <!-- Current Selection Info -->
            <div id="selectionInfo" class="bg-gray-50 rounded-lg p-3 hidden">
                <h5 class="font-bold text-gray-800 text-sm mb-2">📍 当前选择</h5>
                <p class="text-xs text-gray-600" id="selectedElementInfo">未选择任何元素</p>
            </div>
        </div>
        
        <div class="mt-4 pt-3 border-t border-gray-200">
            <button onclick="toggleTextEditMode()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded font-semibold text-sm">
                🚪 退出编辑模式
            </button>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emojiPickerModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">😊 选择表情符号</h3>
                    <button onclick="closeEmojiPicker()" class="text-gray-400 hover:text-gray-600 text-xl">✕</button>
                </div>
                
                <div class="space-y-4">
                    <!-- Emoji Categories -->
                    <div class="flex space-x-2 text-xs">
                        <button onclick="showEmojiCategory('nature')" class="bg-green-100 hover:bg-green-200 px-3 py-1 rounded">🌱 自然</button>
                        <button onclick="showEmojiCategory('objects')" class="bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">📚 物品</button>
                        <button onclick="showEmojiCategory('symbols')" class="bg-purple-100 hover:bg-purple-200 px-3 py-1 rounded">⭐ 符号</button>
                        <button onclick="showEmojiCategory('faces')" class="bg-yellow-100 hover:bg-yellow-200 px-3 py-1 rounded">😊 表情</button>
                    </div>
                    
                    <!-- Emoji Grid -->
                    <div id="emojiGrid" class="grid grid-cols-8 gap-2 text-2xl max-h-64 overflow-y-auto">
                        <!-- Emojis will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">⚠️ 确认修改</h3>
                    <button onclick="closeConfirmationModal()" class="text-gray-400 hover:text-gray-600 text-xl">✕</button>
                </div>
                
                <div class="mb-6">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2" id="confirmationIcon">⚠️</div>
                        <p class="text-gray-700" id="confirmationMessage">您确定要进行此修改吗？</p>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                        <h4 class="font-bold text-yellow-800 text-sm mb-2">📋 修改详情：</h4>
                        <p class="text-yellow-700 text-sm" id="changeDetails">即将进行的修改...</p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <h4 class="font-bold text-blue-800 text-sm mb-2">💡 提示：</h4>
                        <p class="text-blue-700 text-sm">此操作可以通过"撤销"功能恢复。您的修改历史将被保存。</p>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="confirmAction()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-semibold">
                        ✅ 确认修改
                    </button>
                    <button onclick="closeConfirmationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold">
                        ❌ 取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Input Modal -->
    <div id="textInputModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">📝 添加新文字</h3>
                    <button onclick="closeTextInputModal()" class="text-gray-400 hover:text-gray-600 text-xl">✕</button>
                </div>
                
                <form onsubmit="createNewTextElement(event)" class="space-y-4">
                    <div>
                        <label for="newTextContent" class="block text-sm font-medium text-gray-700 mb-2">文字内容</label>
                        <textarea id="newTextContent" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="输入要添加的文字..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="textSize" class="block text-sm font-medium text-gray-700 mb-2">字体大小</label>
                            <select id="textSize" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="text-xs">很小</option>
                                <option value="text-sm">小</option>
                                <option value="text-base" selected>正常</option>
                                <option value="text-lg">大</option>
                                <option value="text-xl">很大</option>
                                <option value="text-2xl">超大</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="textColor" class="block text-sm font-medium text-gray-700 mb-2">文字颜色</label>
                            <select id="textColor" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="text-gray-800" selected>深灰</option>
                                <option value="text-green-600">绿色</option>
                                <option value="text-blue-600">蓝色</option>
                                <option value="text-purple-600">紫色</option>
                                <option value="text-orange-600">橙色</option>
                                <option value="text-red-600">红色</option>
                                <option value="text-white">白色</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="textPosition" class="block text-sm font-medium text-gray-700 mb-2">插入位置</label>
                        <select id="textPosition" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="header">Header区域</option>
                            <option value="hero" selected>Hero区域</option>
                            <option value="features">功能区域</option>
                            <option value="competition">竞赛区域</option>
                            <option value="partnership">合作区域</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold">
                            ✅ 添加文字
                        </button>
                        <button type="button" onclick="closeTextInputModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold">
                            ❌ 取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform z-50">
        <div class="flex items-center space-x-2">
            <span>✅</span>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <script>
        // Sample magazines data
        const magazinesData = [
            {
                id: 1,
                title: "生态文明学校第1期",
                issue: "第1期",
                description: "介绍生态文明教育的基本理念和实践方法，包含学校环保项目案例分析。",
                url: "https://online.visual-paradigm.com/share/book/sekolah-bertamadun-ekologi-ebook-23owrlo1dc",
                readingPoints: 15,
                reviewPoints: 30,
                publishDate: "2024年1月",
                coverImage: "📚",
                status: "available"
            },
            {
                id: 2,
                title: "环保行动指南",
                issue: "第2期",
                description: "详细介绍各种环保行动的具体实施方法，包含废物分类、节能减排等实用技巧。",
                url: "https://online.visual-paradigm.com/share/book/environmental-action-guide-abc123",
                readingPoints: 12,
                reviewPoints: 25,
                publishDate: "2024年2月",
                coverImage: "🌱",
                status: "available"
            },
            {
                id: 3,
                title: "青少年生态领袖",
                issue: "第3期",
                description: "展示优秀青少年环保领袖的故事和经验分享，激励更多学生参与环保行动。",
                url: "https://online.visual-paradigm.com/share/book/youth-eco-leaders-def456",
                readingPoints: 18,
                reviewPoints: 35,
                publishDate: "2024年3月",
                coverImage: "🌟",
                status: "available"
            }
        ];

        // Current reading magazine
        let currentMagazine = null;
        let hasReadCurrentMagazine = false;
        
        // Admin mode state
        let isAdminMode = false;

        // Sample data for sponsors
        const sponsorsData = [
            {
                name: "Green Tech Solutions",
                logo: "🌱",
                level: "platinum",
                contribution: "Platinum Level",
                description: "Environmental technology solutions provider"
            },
            {
                name: "Eco Education Foundation",
                logo: "📚",
                level: "gold",
                contribution: "Gold Level",
                description: "Focused on youth environmental education development"
            },
            {
                name: "Clean Energy Group",
                logo: "⚡",
                level: "gold",
                contribution: "Gold Level",
                description: "Renewable energy technology leader"
            },
            {
                name: "Sustainable Construction",
                logo: "🏗️",
                level: "silver",
                contribution: "Silver Level",
                description: "Green building and ecological restoration expert"
            }
        ];

        // Sample school rankings data
        const schoolRankingsData = [
            {
                rank: 1,
                school: "SMK Damansara Jaya",
                students: 45,
                averageScore: 87.5,
                award: "gold",
                prize: "Cash Award + Environmental Equipment"
            },
            {
                rank: 2,
                school: "SJKC Chong Hwa",
                students: 32,
                averageScore: 84.2,
                award: "gold",
                prize: "Cash Award + Environmental Equipment"
            },
            {
                rank: 3,
                school: "SMK Subang Jaya",
                students: 28,
                averageScore: 76.8,
                award: "silver",
                prize: "Cash Award + Educational Materials"
            },
            {
                rank: 4,
                school: "SJKT Ladang Bukit Jalil",
                students: 15,
                averageScore: 73.4,
                award: "silver",
                prize: "Cash Award + Educational Materials"
            },
            {
                rank: 5,
                school: "SMK Bandar Utama",
                students: 22,
                averageScore: 68.9,
                award: "bronze",
                prize: "Cash Award + Eco Supplies"
            },
            {
                rank: 6,
                school: "SK Taman Desa",
                students: 18,
                averageScore: 65.3,
                award: "bronze",
                prize: "Cash Award + Eco Supplies"
            }
        ];

        // Sample Green Mover rankings data
        const greenMoverRankingsData = [
            {
                rank: 1,
                name: "Sarah Chen",
                location: "Kuala Lumpur",
                submissions: 28,
                averageScore: 95.2,
                award: "champion",
                recognition: "Certificate + Medal + Media Coverage"
            },
            {
                rank: 2,
                name: "Ahmad Rahman",
                location: "Selangor",
                submissions: 22,
                averageScore: 92.8,
                award: "innovation",
                recognition: "Certificate + Medal + Media Coverage"
            },
            {
                rank: 3,
                name: "Priya Devi",
                location: "Penang",
                submissions: 19,
                averageScore: 89.5,
                award: "impact",
                recognition: "Certificate + Medal + Media Coverage"
            },
            {
                rank: 4,
                name: "Lim Wei Ming",
                location: "Johor",
                submissions: 25,
                averageScore: 87.3,
                award: "consistency",
                recognition: "Certificate + Medal + Media Coverage"
            },
            {
                rank: 5,
                name: "Nurul Aisyah",
                location: "Perak",
                submissions: 16,
                averageScore: 85.7,
                award: "youth",
                recognition: "Certificate + Medal + Media Coverage"
            },
            {
                rank: 6,
                name: "David Tan",
                location: "Sabah",
                submissions: 20,
                averageScore: 83.9,
                award: "mentor",
                recognition: "Certificate + Medal + Media Coverage"
            }
        ];

        // Load sponsors and rankings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSponsors();
            loadSchoolRankings();
            loadGreenMoverRankings();
            loadMagazines();
            loadSavedLogo(); // Load saved MECCC logo
            loadSavedBackgrounds(); // Load saved button backgrounds
            loadAdminModeState(); // Load admin mode state
            loadChangeHistory(); // Load change history
            
            // Emoji replacement is now disabled to prevent layout issues
            // Users can still see native emojis which work well across all devices
        });

        // Load sponsors
        function loadSponsors() {
            const sponsorsGrid = document.getElementById('sponsorsGrid');
            sponsorsGrid.innerHTML = '';
            
            sponsorsData.forEach(sponsor => {
                const sponsorCard = document.createElement('div');
                sponsorCard.className = 'sponsor-card rounded-xl p-6 text-center card-hover';
                sponsorCard.innerHTML = `
                    <div class="text-4xl mb-4">${sponsor.logo}</div>
                    <h4 class="font-bold text-gray-800 mb-2">${sponsor.name}</h4>
                    <p class="text-sm text-gray-600 mb-2">${sponsor.description}</p>
                    <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${getLevelColor(sponsor.level)}">
                        ${getLevelText(sponsor.level)}
                    </div>
                    <p class="text-lg font-bold text-green-600 mt-2">${sponsor.contribution}</p>
                `;
                sponsorsGrid.appendChild(sponsorCard);
            });
        }

        // Load school rankings
        function loadSchoolRankings() {
            const rankingsTableBody = document.getElementById('rankingsTableBody');
            if (rankingsTableBody) {
                rankingsTableBody.innerHTML = '';
                
                schoolRankingsData.forEach(school => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="text-2xl mr-2">${getRankIcon(school.rank)}</span>
                                <span class="text-lg font-bold text-gray-900">${school.rank}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${school.school}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${school.students} students
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-lg font-bold ${getScoreColor(school.averageScore)}">${school.averageScore}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getAwardColor(school.award)}">
                                ${getAwardIcon(school.award)} ${getAwardText(school.award)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${school.prize}
                        </td>
                    `;
                    rankingsTableBody.appendChild(row);
                });
            }
        }

        // Helper functions
        function getLevelColor(level) {
            switch(level) {
                case 'platinum': return 'bg-purple-100 text-purple-800';
                case 'gold': return 'bg-yellow-100 text-yellow-800';
                case 'silver': return 'bg-gray-100 text-gray-800';
                case 'bronze': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getLevelText(level) {
            switch(level) {
                case 'platinum': return 'Platinum Sponsor';
                case 'gold': return 'Gold Sponsor';
                case 'silver': return 'Silver Sponsor';
                case 'bronze': return 'Bronze Sponsor';
                default: return 'Sponsor';
            }
        }

        function getRankIcon(rank) {
            if (rank === 1) return '🥇';
            if (rank === 2) return '🥈';
            if (rank === 3) return '🥉';
            return '🏆';
        }

        function getScoreColor(score) {
            if (score >= 80) return 'text-yellow-600';
            if (score >= 70) return 'text-gray-600';
            if (score >= 60) return 'text-orange-600';
            return 'text-red-600';
        }

        function getAwardColor(award) {
            switch(award) {
                case 'gold': return 'bg-yellow-100 text-yellow-800';
                case 'silver': return 'bg-gray-100 text-gray-800';
                case 'bronze': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getAwardIcon(award) {
            switch(award) {
                case 'gold': return '🥇';
                case 'silver': return '🥈';
                case 'bronze': return '🥉';
                default: return '🏆';
            }
        }

        function getAwardText(award) {
            switch(award) {
                case 'gold': return 'Gold Award';
                case 'silver': return 'Silver Award';
                case 'bronze': return 'Bronze Award';
                default: return 'Participation Award';
            }
        }

        function getGreenMoverAwardIcon(award) {
            switch(award) {
                case 'champion': return '👑';
                case 'innovation': return '🌱';
                case 'impact': return '💚';
                case 'consistency': return '⭐';
                case 'youth': return '🚀';
                case 'mentor': return '🎓';
                default: return '🏆';
            }
        }

        function getGreenMoverAwardText(award) {
            switch(award) {
                case 'champion': return 'Environmental Champion';
                case 'innovation': return 'Eco Innovation Leader';
                case 'impact': return 'Community Impact Award';
                case 'consistency': return 'Consistency Award';
                case 'youth': return 'Youth Leader';
                case 'mentor': return 'Mentor Award';
                default: return 'Recognition Award';
            }
        }

        function getGreenMoverAwardColor(award) {
            switch(award) {
                case 'champion': return 'bg-purple-100 text-purple-800';
                case 'innovation': return 'bg-green-100 text-green-800';
                case 'impact': return 'bg-blue-100 text-blue-800';
                case 'consistency': return 'bg-yellow-100 text-yellow-800';
                case 'youth': return 'bg-pink-100 text-pink-800';
                case 'mentor': return 'bg-indigo-100 text-indigo-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Load magazines
        function loadMagazines() {
            const magazinesList = document.getElementById('magazinesList');
            if (magazinesList) {
                magazinesList.innerHTML = '';
                
                magazinesData.forEach(magazine => {
                    const magazineCard = document.createElement('div');
                    magazineCard.className = 'bg-white rounded-xl p-6 shadow-lg border-2 border-gray-200 hover:border-orange-300 transition-all';
                    magazineCard.innerHTML = `
                        <div class="text-center mb-4">
                            <div class="text-6xl mb-3">${magazine.coverImage}</div>
                            <h4 class="font-bold text-gray-800 text-lg mb-2">${magazine.title}</h4>
                            <p class="text-sm text-gray-600 mb-3">${magazine.description}</p>
                            <div class="flex justify-between text-xs text-gray-500 mb-4">
                                <span>📅 ${magazine.publishDate}</span>
                                <span>📖 ${magazine.issue}</span>
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 rounded-lg p-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-orange-700">📖 阅读积分: <strong>${magazine.readingPoints}</strong></span>
                                <span class="text-orange-700">✍️ 读后感积分: <strong>${magazine.reviewPoints}</strong></span>
                            </div>
                        </div>
                        
                        <button onclick="readMagazine(${magazine.id})" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 px-4 rounded-lg font-semibold">
                            📚 开始阅读
                        </button>
                    `;
                    magazinesList.appendChild(magazineCard);
                });
            }
        }

        // Magazine functions
        function readMagazine(magazineId) {
            currentMagazine = magazinesData.find(m => m.id === magazineId);
            if (currentMagazine) {
                document.getElementById('readingMagazineTitle').textContent = `📚 ${currentMagazine.title}`;
                document.getElementById('readingPointsDisplay').textContent = currentMagazine.readingPoints;
                document.getElementById('reviewPointsDisplay').textContent = currentMagazine.reviewPoints;
                
                // Reset reading state
                hasReadCurrentMagazine = false;
                document.getElementById('confirmReadingBtn').disabled = false;
                document.getElementById('confirmReadingBtn').className = 'bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold';
                
                // Reset magazine viewer state
                document.getElementById('magazineLoading').classList.remove('hidden');
                document.getElementById('magazineViewer').classList.add('hidden');
                document.getElementById('magazineError').classList.add('hidden');
                document.getElementById('magazineAlternative').classList.add('hidden');
                
                // Reset progress
                updateReadingProgress(0);
                document.getElementById('readingProgress').textContent = '准备开始';
                
                // Clear any existing timer
                if (window.currentReadingTimer) {
                    clearInterval(window.currentReadingTimer);
                }
                
                closeMagazineModal();
                document.getElementById('magazineReadingModal').classList.remove('hidden');
                
                // Try to load magazine in iframe with delay to show loading state
                setTimeout(() => {
                    const viewer = document.getElementById('magazineViewer');
                    viewer.src = currentMagazine.url;
                    
                    // Set a timeout to show error state if iframe doesn't load
                    setTimeout(() => {
                        if (viewer.classList.contains('hidden')) {
                            handleMagazineError();
                        }
                    }, 8000); // 8 second timeout
                }, 1000);
            }
        }

        function openMagazineInNewTab() {
            if (currentMagazine) {
                window.open(currentMagazine.url, '_blank', 'noopener,noreferrer');
                
                // Update reading progress when opening in new tab
                updateReadingProgress(25);
                document.getElementById('readingProgress').textContent = '已在新窗口打开';
            }
        }

        function handleMagazineLoad() {
            // Hide loading, show iframe
            document.getElementById('magazineLoading').classList.add('hidden');
            document.getElementById('magazineViewer').classList.remove('hidden');
            document.getElementById('magazineError').classList.add('hidden');
            document.getElementById('magazineAlternative').classList.add('hidden');
            
            updateReadingProgress(50);
            document.getElementById('readingProgress').textContent = '杂志已加载';
            
            // Start reading timer
            startReadingTimer();
        }

        function handleMagazineError() {
            // Show error state and alternative display
            document.getElementById('magazineLoading').classList.add('hidden');
            document.getElementById('magazineViewer').classList.add('hidden');
            document.getElementById('magazineError').classList.remove('hidden');
            document.getElementById('magazineAlternative').classList.remove('hidden');
            
            // Update alternative display with current magazine info
            if (currentMagazine) {
                document.getElementById('altMagazineCover').textContent = currentMagazine.coverImage;
                document.getElementById('altMagazineTitle').textContent = currentMagazine.title;
                document.getElementById('altMagazineDesc').textContent = currentMagazine.description;
            }
            
            document.getElementById('readingProgress').textContent = '请在新窗口阅读';
        }

        function toggleFullscreen() {
            const container = document.getElementById('magazineContainer');
            const viewer = document.getElementById('magazineViewer');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().then(() => {
                    viewer.style.height = '100vh';
                    updateReadingProgress(75);
                    document.getElementById('readingProgress').textContent = '全屏阅读中';
                }).catch(err => {
                    console.log('Fullscreen not supported');
                    // Fallback: make container larger
                    viewer.style.height = '80vh';
                    showToast('💡 提示：按 ESC 键可退出全屏模式');
                });
            } else {
                document.exitFullscreen();
                viewer.style.height = '24rem'; // Reset to h-96 equivalent
            }
        }

        function updateReadingProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
        }

        function startReadingTimer() {
            let timeSpent = 0;
            const timer = setInterval(() => {
                timeSpent += 10;
                const progress = Math.min(50 + (timeSpent / 120) * 40, 90); // 50% base + up to 40% for time
                updateReadingProgress(progress);
                
                if (timeSpent >= 60) { // After 1 minute
                    document.getElementById('readingProgress').textContent = '深度阅读中';
                }
                if (timeSpent >= 180) { // After 3 minutes
                    document.getElementById('readingProgress').textContent = '阅读进展良好';
                    updateReadingProgress(95);
                }
                if (timeSpent >= 300) { // After 5 minutes
                    document.getElementById('readingProgress').textContent = '可确认完整阅读';
                    updateReadingProgress(100);
                    clearInterval(timer);
                }
            }, 10000); // Update every 10 seconds
            
            // Store timer to clear when modal closes
            window.currentReadingTimer = timer;
        }

        function confirmReading() {
            if (currentMagazine && !hasReadCurrentMagazine) {
                hasReadCurrentMagazine = true;
                
                // Disable the reading confirmation button
                const confirmBtn = document.getElementById('confirmReadingBtn');
                confirmBtn.disabled = true;
                confirmBtn.className = 'bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold cursor-not-allowed';
                confirmBtn.innerHTML = '✅ 已获得阅读积分 (+' + currentMagazine.readingPoints + '积分)';
                
                showToast(`🎉 阅读完成！获得 ${currentMagazine.readingPoints} 积分。现在可以提交读后感获得额外 ${currentMagazine.reviewPoints} 积分！`);
            }
        }

        function submitMagazineReview(event) {
            event.preventDefault();
            
            if (!hasReadCurrentMagazine || !readingVerified) {
                showToast('⚠️ 请先确认完整阅读杂志后再提交读后感！');
                return;
            }
            
            const reviewerName = document.getElementById('reviewerName').value;
            const reviewerSchool = document.getElementById('reviewerSchool').value;
            const reviewContent = document.getElementById('magazineReview').value;
            
            if (reviewContent.length < 100) {
                showToast('⚠️ 读后感内容至少需要100字，请详细分享您的感想和收获！');
                return;
            }
            
            // Enhanced AI review scoring with comprehensive evaluation
            const contentQuality = Math.floor(Math.random() * 20) + 80; // 80-100 base score
            const originalityScore = Math.floor(Math.random() * 15) + 85; // 85-100 originality
            const depthScore = reviewContent.length > 300 ? Math.floor(Math.random() * 10) + 90 : Math.floor(Math.random() * 15) + 75;
            
            // Calculate comprehensive review score
            const averageScore = Math.floor((contentQuality + originalityScore + depthScore) / 3);
            
            // Determine bonus points based on quality
            let qualityBonus = 0;
            if (averageScore >= 95) qualityBonus = 15;
            else if (averageScore >= 90) qualityBonus = 10;
            else if (averageScore >= 85) qualityBonus = 5;
            
            // Get reading points from previous confirmation
            const actualReadingPoints = parseInt(document.getElementById('readingPointsDisplay').textContent);
            const totalReviewPoints = currentMagazine.reviewPoints + qualityBonus;
            const grandTotal = actualReadingPoints + totalReviewPoints;
            
            // Calculate contribution to school ecological civilization index
            let schoolContribution = '';
            if (reviewerSchool) {
                const readingContribution = actualReadingPoints; // B component
                const reviewContribution = totalReviewPoints; // B component
                const totalBComponent = readingContribution + reviewContribution;
                
                schoolContribution = `
                📊 学校生态文明指数贡献：
                • B(阅读学习积分): +${totalBComponent}分
                • 个人质量评级: ${averageScore >= 90 ? 'A级' : averageScore >= 80 ? 'B级' : 'C级'}
                • 对学校总指数影响: +${totalBComponent}分 (将与参与率和质量系数计算)
                `;
            }
            
            let message = `🎉 读后感AI评估完成！
            
📝 内容质量: ${contentQuality}/100
🎯 原创性: ${originalityScore}/100  
📚 深度分析: ${depthScore}/100
⭐ 综合评分: ${averageScore}/100

💰 积分明细：
• 阅读验证积分: ${actualReadingPoints}分
• 读后感基础积分: ${currentMagazine.reviewPoints}分`;
            
            if (qualityBonus > 0) {
                message += `\n• 优质内容奖励: +${qualityBonus}分`;
            }
            
            message += `\n🏆 本次总获得: ${grandTotal}分`;
            
            if (reviewerSchool) {
                message += `\n\n${schoolContribution}`;
            }
            
            showToast(message);
            closeMagazineReadingModal();
            
            // Reset form
            document.getElementById('reviewerName').value = '';
            document.getElementById('reviewerSchool').value = '';
            document.getElementById('magazineReview').value = '';
        }

        function uploadMagazine(event) {
            event.preventDefault();
            
            const title = document.getElementById('magazineTitle').value;
            const issue = document.getElementById('magazineIssue').value;
            const url = document.getElementById('magazineUrl').value;
            const description = document.getElementById('magazineDescription').value;
            const readingPoints = parseInt(document.getElementById('readingPoints').value);
            const reviewPoints = parseInt(document.getElementById('reviewPoints').value);
            
            // Add new magazine to the data
            const newMagazine = {
                id: magazinesData.length + 1,
                title: title,
                issue: issue,
                description: description,
                url: url,
                readingPoints: readingPoints,
                reviewPoints: reviewPoints,
                publishDate: new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' }),
                coverImage: "📖",
                status: "available"
            };
            
            magazinesData.push(newMagazine);
            loadMagazines();
            
            showToast(`📚 电子杂志 "${title}" 上传成功！学生现在可以阅读并获得积分。`);
            
            // Reset form
            document.getElementById('magazineTitle').value = '';
            document.getElementById('magazineIssue').value = '';
            document.getElementById('magazineUrl').value = '';
            document.getElementById('magazineDescription').value = '';
            document.getElementById('readingPoints').value = '10';
            document.getElementById('reviewPoints').value = '25';
            
            // Hide admin upload section
            document.getElementById('adminMagazineUpload').classList.add('hidden');
        }

        function toggleAdminUpload() {
            const adminSection = document.getElementById('adminMagazineUpload');
            adminSection.classList.toggle('hidden');
        }

        // Modal functions
        function showMagazineModal() {
            document.getElementById('magazineModal').classList.remove('hidden');
        }

        function closeMagazineModal() {
            document.getElementById('magazineModal').classList.add('hidden');
        }

        function closeMagazineReadingModal() {
            document.getElementById('magazineReadingModal').classList.add('hidden');
            
            // Clear reading timer
            if (window.currentReadingTimer) {
                clearInterval(window.currentReadingTimer);
                window.currentReadingTimer = null;
            }
            
            // Reset iframe src to stop loading
            document.getElementById('magazineViewer').src = '';
            
            // Exit fullscreen if active
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            
            currentMagazine = null;
            hasReadCurrentMagazine = false;
        }

        function showEcoSubmissionModal() {
            document.getElementById('ecoSubmissionModal').classList.remove('hidden');
        }

        function closeEcoSubmissionModal() {
            document.getElementById('ecoSubmissionModal').classList.add('hidden');
        }

        function showStudentRegistrationModal() {
            document.getElementById('studentRegistrationModal').classList.remove('hidden');
        }

        function closeStudentRegistrationModal() {
            document.getElementById('studentRegistrationModal').classList.add('hidden');
        }

        function showSchoolRegistrationModal() {
            document.getElementById('schoolRegistrationModal').classList.remove('hidden');
        }

        function closeSchoolRegistrationModal() {
            document.getElementById('schoolRegistrationModal').classList.add('hidden');
        }

        function showSchoolLoginModal() {
            document.getElementById('schoolLoginModal').classList.remove('hidden');
        }

        function closeSchoolLoginModal() {
            document.getElementById('schoolLoginModal').classList.add('hidden');
        }

        function showSchoolRegistrationFromLogin() {
            closeSchoolLoginModal();
            showSchoolRegistrationModal();
        }

        function showCompetitionModal() {
            document.getElementById('competitionModal').classList.remove('hidden');
        }

        function closeCompetitionModal() {
            document.getElementById('competitionModal').classList.add('hidden');
        }

        function showSponsorModal() {
            document.getElementById('sponsorModal').classList.remove('hidden');
        }

        function closeSponsorModal() {
            document.getElementById('sponsorModal').classList.add('hidden');
        }

        function showGreenMoverModal() {
            document.getElementById('greenMoverModal').classList.remove('hidden');
        }

        function closeGreenMoverModal() {
            document.getElementById('greenMoverModal').classList.add('hidden');
        }

        function showGreenMoverRankingsModal() {
            document.getElementById('greenMoverRankingsModal').classList.remove('hidden');
        }

        function closeGreenMoverRankingsModal() {
            document.getElementById('greenMoverRankingsModal').classList.add('hidden');
        }

        // Load Green Mover rankings
        function loadGreenMoverRankings() {
            const greenMoverRankingsTableBody = document.getElementById('greenMoverRankingsTableBody');
            if (greenMoverRankingsTableBody) {
                greenMoverRankingsTableBody.innerHTML = '';
                
                greenMoverRankingsData.forEach(mover => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="text-2xl mr-2">${getGreenMoverAwardIcon(mover.award)}</span>
                                <span class="text-lg font-bold text-gray-900">${mover.rank}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${mover.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${mover.location}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${mover.submissions}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-lg font-bold ${getScoreColor(mover.averageScore)}">${mover.averageScore}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getGreenMoverAwardColor(mover.award)}">
                                ${getGreenMoverAwardIcon(mover.award)} ${getGreenMoverAwardText(mover.award)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${mover.recognition}
                        </td>
                    `;
                    greenMoverRankingsTableBody.appendChild(row);
                });
            }
        }

        // Toggle school field based on participation type
        function toggleSchoolField() {
            const participationType = document.querySelector('input[name="participationType"]:checked').value;
            const schoolNameField = document.getElementById('schoolNameField');
            const schoolNameInput = document.getElementById('regSchoolName');
            const schoolBenefit = document.getElementById('schoolBenefit');
            const individualBenefit = document.getElementById('individualBenefit');
            
            if (participationType === 'individual') {
                schoolNameField.style.display = 'none';
                schoolNameInput.required = false;
                schoolBenefit.classList.add('hidden');
                individualBenefit.classList.remove('hidden');
            } else {
                schoolNameField.style.display = 'block';
                schoolNameInput.required = true;
                schoolBenefit.classList.remove('hidden');
                individualBenefit.classList.add('hidden');
            }
        }

        // Photo upload and AI processing
        let uploadedPhotos = [];
        let photosVerified = false;
        let contentEnhanced = false;
        let originalContent = '';
        let enhancedContentText = '';
        let contentSafetyPassed = false;
        let photoSafetyPassed = false;
        let violationCount = 0; // Track violation attempts
        
        // Content safety monitoring for positive environment
        const trulyHarmfulKeywords = [
            // Only truly harmful content that could hurt youth
            '自杀', '伤害', '暴力', '欺凌', '色情', '毒品', '仇恨', '歧视',
            'suicide', 'violence', 'bullying', 'pornography', 'drugs', 'hate', 'discrimination'
        ];
        
        const encouragePositiveKeywords = [
            // Encourage positive environmental expressions
            '环保', '绿色', '节能', '回收', '植树', '清洁', '保护', '学习', '合作', '帮助', '种植', '蚯蚓', '土壤', '有机',
            'environmental', 'green', 'recycle', 'plant', 'clean', 'protect', 'learn', 'cooperate', 'help', 'organic', 'soil', 'earthworm'
        ];
        
        // Check for truly harmful content only
        function checkForHarmfulContent(content) {
            const lowerContent = content.toLowerCase();
            
            // Only flag truly harmful content
            for (let keyword of trulyHarmfulKeywords) {
                if (lowerContent.includes(keyword.toLowerCase())) {
                    return true;
                }
            }
            
            return false; // Environmental content is always safe
        }
        
        // Show safety warning only for truly harmful content
        function showSafetyWarning() {
            const contentSafetyStatus = document.getElementById('contentSafetyStatus');
            const safetyWarningMessage = document.getElementById('safetyWarningMessage');
            
            safetyWarningMessage.textContent = '检测到可能有害的内容，请修改为积极正面的环保体验分享。';
            contentSafetyStatus.classList.remove('hidden');
        }

        // Real-time content guidance and progressive learning system
        function checkContentSafety(content) {
            const contentSafetyStatus = document.getElementById('contentSafetyStatus');
            const contentSafetyPassedDiv = document.getElementById('contentSafetyPassed');
            const safetyWarningMessage = document.getElementById('safetyWarningMessage');
            
            // Clear previous guidance
            clearPreviousGuidance();
            
            if (content.length < 5) {
                contentSafetyStatus.classList.add('hidden');
                contentSafetyPassedDiv.classList.add('hidden');
                contentSafetyPassed = false;
                updateSubmitButton();
                return;
            }
            
            // First check for truly inappropriate content (very restrictive)
            const hasTrulyInappropriateContent = checkForHarmfulContent(content);
            
            if (hasTrulyInappropriateContent) {
                showSafetyWarning();
                contentSafetyPassed = false;
                updateSubmitButton();
                return;
            }
            
            // If content passes safety check, analyze quality and provide guidance
            const analysisResult = analyzeContentQuality(content);
            
            // Always pass safety check for environmental content
            contentSafetyPassed = true;
            
            if (analysisResult.needsImprovement) {
                showRealTimeGuidance(analysisResult);
            } else {
                showProgressiveFeedback(analysisResult);
            }
            
            updateSubmitButton();
        }
        
        // Simplified content quality analysis - easy pass criteria
        function analyzeContentQuality(content) {
            const result = {
                needsImprovement: false,
                score: 0,
                strengths: [],
                improvements: [],
                specificSuggestions: [],
                level: 'beginner',
                passesBasicRequirements: false
            };
            
            const wordCount = content.length;
            
            // Simple pattern matching for basic requirements
            const hasWhenWhere = /在.*时候|在.*地方|昨天|今天|上周|学校|家里|公园|办公室|空地|2025年|8月31日|时间|地点/.test(content);
            const hasWhy = /因为|为了|目的|意义|重要|这样|使用|才会|适合|原因|动机/.test(content);
            const hasResult = /结果|效果|影响|改变|提高|减少|节约|健康|保护|生态|成果|收获/.test(content);
            const hasFeeling = /感到|觉得|体会|学到|收获|启发|鼓励|感想|感悟|想法/.test(content);
            
            // Very generous base scoring - start high
            let score = 50; // High base score
            
            // Basic requirements check (only need 3 out of 4)
            let requirementsMet = 0;
            if (hasWhenWhere) { score += 10; requirementsMet++; }
            if (hasWhy) { score += 10; requirementsMet++; }
            if (hasResult) { score += 10; requirementsMet++; }
            if (hasFeeling) { score += 10; requirementsMet++; }
            
            // Length bonus (very generous)
            if (wordCount >= 30) score += 10;
            if (wordCount >= 50) score += 5;
            
            // Environmental keywords bonus
            const envKeywords = ['环保', '绿色', '有机', '种植', '蚯蚓', '土壤', '生态', '健康', '保护', '工作坊', '学员'];
            const foundEnvKeywords = envKeywords.filter(keyword => content.includes(keyword));
            score += foundEnvKeywords.length * 3; // 3 points per environmental keyword
            
            result.score = Math.min(score, 100);
            result.passesBasicRequirements = requirementsMet >= 3 && wordCount >= 30;
            
            // Very lenient pass criteria
            if (result.passesBasicRequirements) {
                result.level = 'passed';
                result.strengths = getPassedFeedback(content, hasWhenWhere, hasWhy, hasResult, hasFeeling);
            } else {
                result.level = 'needs_simple_additions';
                result.needsImprovement = true;
                result.improvements = getSimpleGuidance(content, hasWhenWhere, hasWhy, hasResult, hasFeeling, wordCount);
            }
            
            return result;
        }
        
        // Simple guidance for missing elements
        function getSimpleGuidance(content, hasWhen, hasWhy, hasResult, hasFeeling, wordCount) {
            const guidance = [];
            
            if (wordCount < 30) {
                guidance.push({
                    type: 'length',
                    title: '📝 内容稍短',
                    suggestion: '请再添加一些细节，至少30字即可',
                    example: '例如：多说几句您的感受或行动过程'
                });
            }
            
            if (!hasWhen) {
                guidance.push({
                    type: 'missing',
                    title: '📅 时间地点',
                    suggestion: '简单说明什么时候、在哪里',
                    example: '例如："8月31日在办公室旁边" 或 "昨天在学校"'
                });
            }
            
            if (!hasWhy) {
                guidance.push({
                    type: 'missing',
                    title: '🎯 为什么',
                    suggestion: '说明您的动机或目的',
                    example: '例如："为了保护土壤" 或 "因为想鼓励大家环保"'
                });
            }
            
            if (!hasResult) {
                guidance.push({
                    type: 'missing',
                    title: '📊 结果',
                    suggestion: '说明得到了什么结果或效果',
                    example: '例如："土壤变得更健康" 或 "学员们学到了知识"'
                });
            }
            
            if (!hasFeeling) {
                guidance.push({
                    type: 'missing',
                    title: '💭 感悟',
                    suggestion: '分享您的感受或收获',
                    example: '例如："我学到了..." 或 "我觉得很有意义"'
                });
            }
            
            return guidance;
        }
        
        // Positive feedback for passed content
        function getPassedFeedback(content, hasWhen, hasWhy, hasResult, hasFeeling) {
            const feedback = [];
            
            feedback.push({
                type: 'strength',
                title: '✅ 基本要求已满足',
                message: '您的内容包含了时间地点、动机、结果和感悟等关键信息'
            });
            
            if (hasWhen) {
                feedback.push({
                    type: 'strength',
                    title: '📅 时间地点清楚',
                    message: '很好地说明了行动的时间和地点'
                });
            }
            
            if (hasWhy) {
                feedback.push({
                    type: 'strength',
                    title: '🎯 动机明确',
                    message: '清楚表达了环保行动的原因和目的'
                });
            }
            
            if (hasResult) {
                feedback.push({
                    type: 'strength',
                    title: '📊 结果具体',
                    message: '很好地描述了行动带来的效果'
                });
            }
            
            if (hasFeeling) {
                feedback.push({
                    type: 'strength',
                    title: '💭 感悟深刻',
                    message: '真诚分享了个人的感受和收获'
                });
            }
            
            return feedback;
        }
        
        // Show real-time guidance
        function showRealTimeGuidance(analysisResult) {
            const contentSafetyStatus = document.getElementById('contentSafetyStatus');
            
            let guidanceHTML = `
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mt-3">
                    <div class="flex items-center space-x-2 mb-3">
                        <span class="text-blue-600">🎯</span>
                        <span class="text-blue-800 font-bold">实时写作指导 (当前得分: ${analysisResult.score}/100)</span>
                    </div>
                    
                    <div class="space-y-3">
            `;
            
            analysisResult.improvements.forEach((improvement, index) => {
                const iconMap = {
                    'missing': '❗',
                    'enhance': '⬆️',
                    'improve': '✨'
                };
                
                guidanceHTML += `
                    <div class="bg-white rounded-lg p-3 border-l-4 border-blue-400">
                        <div class="flex items-start space-x-2">
                            <span class="text-lg">${iconMap[improvement.type]}</span>
                            <div class="flex-1">
                                <h6 class="font-bold text-blue-800 text-sm">${improvement.title}</h6>
                                <p class="text-blue-700 text-sm mb-2">${improvement.suggestion}</p>
                                <div class="bg-blue-100 p-2 rounded text-xs text-blue-800">
                                    <strong>💡 示例：</strong>${improvement.example}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            guidanceHTML += `
                    </div>
                    
                    <div class="mt-4 bg-green-100 p-3 rounded-lg">
                        <p class="text-green-800 text-sm font-bold">🚀 写作提示：</p>
                        <p class="text-green-700 text-xs">按照上述建议完善内容，您的得分将显著提高！每次提交都是学习进步的机会。</p>
                    </div>
                </div>
            `;
            
            contentSafetyStatus.innerHTML = guidanceHTML;
            contentSafetyStatus.classList.remove('hidden');
        }
        
        // Show progressive feedback for good content
        function showProgressiveFeedback(analysisResult) {
            const contentSafetyPassedDiv = document.getElementById('contentSafetyPassed');
            
            let feedbackHTML = `
                <div class="bg-green-100 border border-green-300 rounded-lg p-4 mt-3">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-green-600">🎉</span>
                            <span class="text-green-700 font-bold">内容质量优秀！(得分: ${analysisResult.score}/100)</span>
                        </div>
                        <button onclick="showAIWritingGuidance()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                            🤖 AI写作指引
                        </button>
                    </div>
                    
                    <div class="space-y-2">
            `;
            
            analysisResult.strengths.forEach(strength => {
                feedbackHTML += `
                    <div class="flex items-start space-x-2 text-sm">
                        <span class="text-green-600">${strength.type === 'strength' ? '✅' : '🌟'}</span>
                        <div>
                            <span class="font-semibold text-green-800">${strength.title}</span>
                            <p class="text-green-700">${strength.message}</p>
                        </div>
                    </div>
                `;
            });
            
            feedbackHTML += `
                    </div>
                    
                    <div class="mt-3 bg-yellow-100 p-3 rounded-lg">
                        <p class="text-yellow-800 text-sm font-bold">🏆 继续进步：</p>
                        <p class="text-yellow-700 text-xs">您的表达能力很棒！点击"AI写作指引"获得更专业的写作建议，让您的文章更加出色。</p>
                    </div>
                </div>
            `;
            
            contentSafetyPassedDiv.innerHTML = feedbackHTML;
            contentSafetyPassedDiv.classList.remove('hidden');
        }
        
        // Clear previous guidance
        function clearPreviousGuidance() {
            const contentSafetyStatus = document.getElementById('contentSafetyStatus');
            const contentSafetyPassedDiv = document.getElementById('contentSafetyPassed');
            
            contentSafetyStatus.classList.add('hidden');
            contentSafetyPassedDiv.classList.add('hidden');
        }
        
        // Show gentle guidance for content improvement
        function showContentGuidance() {
            const guidanceOverlay = document.createElement('div');
            guidanceOverlay.className = 'fixed inset-0 bg-blue-500 bg-opacity-80 flex items-center justify-center z-50';
            guidanceOverlay.innerHTML = `
                <div class="bg-white rounded-xl p-8 max-w-lg text-center shadow-2xl border-4 border-blue-400">
                    <div class="text-6xl mb-4">🌱</div>
                    <h3 class="text-2xl font-bold text-blue-800 mb-4">内容改进建议</h3>
                    <div class="bg-blue-100 p-4 rounded-lg text-sm text-blue-900 mb-4">
                        <p><strong>💡 建议：</strong></p>
                        <p>• 分享您的真实环保体验</p>
                        <p>• 描述具体的环保行动</p>
                        <p>• 展现积极的学习态度</p>
                        <p>• 用正面语言表达想法</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">
                        好的，我来改进内容
                    </button>
                </div>
            `;
            document.body.appendChild(guidanceOverlay);
        }
        
        // Show positive content suggestions
        function showContentImprovementSuggestions() {
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'bg-green-50 border-2 border-green-200 rounded-lg p-4 mt-3';
            suggestionsDiv.id = 'improvementSuggestions';
            
            const suggestions = `
                <h5 class="font-bold text-green-800 mb-2">💡 内容改进建议：</h5>
                <ul class="text-sm text-green-700 space-y-1">
                    <li>• 分享您的真实环保体验和感受</li>
                    <li>• 描述具体的环保行动和成果</li>
                    <li>• 展现从环保活动中获得的启发</li>
                    <li>• 用积极正面的语言表达想法</li>
                    <li>• 强调团队合作和互助精神</li>
                </ul>
            `;
            
            suggestionsDiv.innerHTML = suggestions;
            
            // Insert after content safety status
            const contentSafetyStatus = document.getElementById('contentSafetyStatus');
            if (contentSafetyStatus && !document.getElementById('improvementSuggestions')) {
                contentSafetyStatus.parentNode.insertBefore(suggestionsDiv, contentSafetyStatus.nextSibling);
            }
        }
        
        // Show positive reinforcement for good content
        function showPositiveReinforcement(content) {
            // Check for positive environmental keywords
            const foundPositive = encouragePositiveKeywords.filter(keyword => content.includes(keyword));
            
            if (foundPositive.length > 0) {
                const encouragementDiv = document.createElement('div');
                encouragementDiv.className = 'bg-green-50 border-2 border-green-200 rounded-lg p-3 mt-2';
                encouragementDiv.innerHTML = `
                    <div class="flex items-center space-x-2 text-sm">
                        <span class="text-green-600">🌟</span>
                        <span class="text-green-700 font-semibold">内容很棒！</span>
                    </div>
                    <p class="text-xs text-green-600 mt-1">发现了积极的环保关键词，继续保持这种正面的表达方式！</p>
                `;
                
                const contentSafetyPassed = document.getElementById('contentSafetyPassed');
                if (contentSafetyPassed && !contentSafetyPassed.querySelector('.bg-green-50')) {
                    contentSafetyPassed.appendChild(encouragementDiv);
                }
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (encouragementDiv.parentNode) {
                        encouragementDiv.remove();
                    }
                }, 3000);
            }
        }

        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const photoPreview = document.getElementById('photoPreview');
            const aiPhotoStatus = document.getElementById('aiPhotoStatus');
            const safetyCheckStatus = document.getElementById('safetyCheckStatus');
            const submitButton = document.getElementById('submitButton');
            const category = document.getElementById('category').value;
            
            if (files.length === 0) return;
            
            if (!category) {
                showToast('⚠️ 请先选择环保行动类别，以便AI验证照片内容的相关性！');
                document.getElementById('photoUpload').value = '';
                return;
            }
            
            // Show photo previews
            photoPreview.innerHTML = '';
            photoPreview.classList.remove('hidden');
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'relative bg-gray-100 rounded-lg overflow-hidden';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Photo ${index + 1}" class="w-full h-32 object-cover">
                        <div class="absolute top-2 right-2 bg-white rounded-full p-1">
                            <span class="text-xs text-gray-600">${index + 1}</span>
                        </div>
                    `;
                    photoPreview.appendChild(photoDiv);
                };
                reader.readAsDataURL(file);
            });
            
            uploadedPhotos = files;
            
            // Show AI processing status with enhanced messaging
            aiPhotoStatus.innerHTML = `
                <div class="flex items-center space-x-2 text-sm">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span class="text-blue-700">AI正在分析照片：安全检查 + 行动证明验证 + 原创性检测...</span>
                </div>
            `;
            aiPhotoStatus.classList.remove('hidden');
            safetyCheckStatus.classList.add('hidden');
            
            // Enhanced AI photo verification with action evidence detection
            setTimeout(() => {
                // First: Safety check
                const hasInappropriateContent = detectInappropriateImageContent(files);
                
                if (hasInappropriateContent) {
                    handleInappropriateContent();
                    return;
                }
                
                // Second: Action evidence verification
                const actionVerification = verifyActionEvidence(files, category);
                
                if (!actionVerification.hasGenuineAction) {
                    handleInvalidActionEvidence(actionVerification);
                    return;
                }
                
                // Third: Success - both safety and action evidence passed
                handleSuccessfulVerification(actionVerification);
                
            }, 4000); // Longer processing time for thorough analysis
        }
        
        function handleInappropriateContent() {
            violationCount++;
            clearPhotoUpload();
            
            const blockingMessage = createBlockingMessage();
            document.body.appendChild(blockingMessage);
            
            const timeoutDuration = violationCount === 1 ? 3000 : 5000;
            setTimeout(() => {
                if (blockingMessage.parentNode) {
                    blockingMessage.parentNode.removeChild(blockingMessage);
                }
            }, timeoutDuration);
            
            setTimeout(() => {
                if (violationCount === 1) {
                    showToast('🚫 违规内容已清除并记录。请重新上传合适的环保照片。');
                } else {
                    showToast(`🚨 第${violationCount}次违规！账户已被严重警告。再次违规将被永久封禁。`);
                }
            }, timeoutDuration + 500);
        }
        
        function handleInvalidActionEvidence(verification) {
            clearPhotoUpload();
            
            // Show detailed feedback for invalid action evidence
            const feedbackModal = document.createElement('div');
            feedbackModal.className = 'fixed inset-0 bg-orange-600 bg-opacity-90 flex items-center justify-center z-50';
            feedbackModal.innerHTML = `
                <div class="bg-white rounded-xl p-8 max-w-lg text-center shadow-2xl border-4 border-orange-400">
                    <div class="text-6xl mb-4">📸</div>
                    <h3 class="text-2xl font-bold text-orange-800 mb-4">行动证明不足</h3>
                    <div class="bg-orange-100 p-4 rounded-lg text-sm text-orange-900 mb-4">
                        <p class="font-bold mb-2">🔍 AI检测结果：</p>
                        ${verification.issues.map(issue => `<p class="mb-1">• ${issue}</p>`).join('')}
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg text-sm text-blue-900 mb-4">
                        <p class="font-bold mb-2">💡 改进建议：</p>
                        ${verification.suggestions.map(suggestion => `<p class="mb-1">• ${suggestion}</p>`).join('')}
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg text-sm text-green-800 mb-4">
                        <p class="font-bold">✅ 有效行动证明应包含：</p>
                        <p>• 您本人或团队正在进行环保活动</p>
                        <p>• 清晰的行动过程或工具使用</p>
                        <p>• 与所选类别相符的具体行动</p>
                        <p>• 原创拍摄，非网络下载图片</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold">
                        我明白了，重新上传行动照片
                    </button>
                </div>
            `;
            
            document.body.appendChild(feedbackModal);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (feedbackModal.parentNode) {
                    feedbackModal.parentNode.removeChild(feedbackModal);
                }
            }, 8000);
            
            showToast('📸 请上传显示真实环保行动过程的照片，而非风景或无关图片！');
        }
        
        function handleSuccessfulVerification(verification) {
            const safetyCheckStatus = document.getElementById('safetyCheckStatus');
            const aiPhotoStatus = document.getElementById('aiPhotoStatus');
            
            // Show comprehensive success status
            safetyCheckStatus.innerHTML = `
                <div class="bg-green-100 border border-green-300 rounded-lg p-4 mt-3">
                    <div class="flex items-center space-x-2 text-sm mb-2">
                        <span class="text-green-600">🛡️</span>
                        <span class="text-green-700 font-semibold">内容安全检查：通过</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm mb-2">
                        <span class="text-green-600">🎯</span>
                        <span class="text-green-700 font-semibold">行动证明验证：${verification.actionType}</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm">
                        <span class="text-green-600">⭐</span>
                        <span class="text-green-700 font-semibold">证据质量评分：${verification.evidenceQuality}/100</span>
                    </div>
                    <p class="text-xs text-green-600 mt-2">✅ 检测到真实环保行动证据，适合青少年社区分享</p>
                </div>
            `;
            safetyCheckStatus.classList.remove('hidden');
            
            setTimeout(() => {
                aiPhotoStatus.innerHTML = `
                    <div class="flex items-center space-x-2 text-sm">
                        <span class="text-green-600">✅</span>
                        <span class="text-green-700">照片验证完成：真实行动证据 + 原创内容 + 安全合规</span>
                    </div>
                `;
                photosVerified = true;
                photoSafetyPassed = true;
                updateSubmitButton();
                
                // Show positive reinforcement
                showToast(`🎉 太棒了！AI识别到您的${verification.actionType}，证据质量${verification.evidenceQuality}分！`);
            }, 1000);
        }
        
        function clearPhotoUpload() {
            const photoPreview = document.getElementById('photoPreview');
            const aiPhotoStatus = document.getElementById('aiPhotoStatus');
            const safetyCheckStatus = document.getElementById('safetyCheckStatus');
            
            photoPreview.innerHTML = '';
            photoPreview.classList.add('hidden');
            aiPhotoStatus.classList.add('hidden');
            safetyCheckStatus.classList.add('hidden');
            
            document.getElementById('photoUpload').value = '';
            uploadedPhotos = [];
            photosVerified = false;
            photoSafetyPassed = false;
            updateSubmitButton();
        }
        
        function createBlockingMessage() {
            const blockingMessage = document.createElement('div');
            blockingMessage.className = 'fixed inset-0 bg-red-600 bg-opacity-95 flex items-center justify-center z-50';
            
            if (violationCount === 1) {
                blockingMessage.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-md text-center shadow-2xl">
                        <div class="text-6xl mb-4">🚫</div>
                        <h3 class="text-2xl font-bold text-red-800 mb-4">内容已被阻止</h3>
                        <p class="text-red-700 mb-4">检测到不当内容，已立即清除</p>
                        <div class="bg-red-100 p-3 rounded-lg text-sm text-red-800">
                            <p><strong>⚠️ 第一次违规 - 警告</strong></p>
                            <p>请上传合适的环保照片</p>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            此消息将在 3 秒后消失
                        </div>
                    </div>
                `;
            } else {
                blockingMessage.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-md text-center shadow-2xl border-4 border-red-600">
                        <div class="text-6xl mb-4">🚨</div>
                        <h3 class="text-2xl font-bold text-red-800 mb-4">严重违规警告</h3>
                        <p class="text-red-700 mb-4 font-bold">第${violationCount}次违规检测</p>
                        <div class="bg-red-200 p-4 rounded-lg text-sm text-red-900 mb-4">
                            <p><strong>🚨 立即后果：</strong></p>
                            <p>• 账户已被标记</p>
                            <p>• 违规记录永久保存</p>
                            <p>• 下次违规将被永久封禁</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg text-sm text-yellow-800">
                            <p><strong>⚠️ 最后警告</strong></p>
                            <p>请立即停止上传不当内容</p>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            此消息将在 5 秒后消失
                        </div>
                    </div>
                `;
            }
            
            return blockingMessage;
        }
        
        // Enhanced AI Action Evidence Detection System
        function detectInappropriateImageContent(files) {
            // Advanced AI system to detect genuine environmental action evidence
            
            for (let file of files) {
                const fileName = file.name.toLowerCase();
                
                // Check for obvious inappropriate filenames
                const inappropriatePatterns = [
                    'nude', 'naked', 'sex', 'porn', 'explicit', 'nsfw', 'adult', 'xxx',
                    '裸', '色情', '性', '成人', '不雅', '暴露'
                ];
                
                for (let pattern of inappropriatePatterns) {
                    if (fileName.includes(pattern)) {
                        return true; // Definitely inappropriate
                    }
                }
                
                // Simulate AI detection - in demo, randomly flag some uploads as inappropriate
                // In real app, this would be actual AI image analysis
                // Higher detection rate for repeat attempts
                const detectionRate = violationCount >= 1 ? 0.6 : 0.3; // 60% for repeat, 30% for first
                if (Math.random() < detectionRate) {
                    return true;
                }
            }
            
            return false; // Content appears appropriate
        }

        // Advanced AI Action Evidence Verification System
        function verifyActionEvidence(files, category) {
            // Simulate advanced AI analysis for genuine environmental action evidence
            const results = {
                hasGenuineAction: false,
                actionType: '',
                evidenceQuality: 0,
                issues: [],
                suggestions: []
            };
            
            // Simulate AI detection based on category and file analysis
            const actionIndicators = getActionIndicators(category);
            const detectionScore = Math.random();
            
            // Check for landscape/scenery photos (no action evidence)
            if (detectionScore < 0.2) {
                results.issues.push('仅风景照片，未发现环保行动证据');
                results.suggestions.push('请上传显示您实际参与环保行动的照片');
                return results;
            }
            
            // Check for stock photos or generic images
            if (detectionScore < 0.3) {
                results.issues.push('疑似网络图片或非原创内容');
                results.suggestions.push('请上传您亲自拍摄的行动照片');
                return results;
            }
            
            // Check for irrelevant content
            if (detectionScore < 0.4) {
                results.issues.push('照片内容与所选环保类别不符');
                results.suggestions.push(`请上传与"${category}"相关的行动证明照片`);
                return results;
            }
            
            // Check for lack of human action evidence
            if (detectionScore < 0.5) {
                results.issues.push('未发现人员参与环保行动的证据');
                results.suggestions.push('请确保照片中显示您或团队正在进行环保活动');
                return results;
            }
            
            // Genuine action detected
            results.hasGenuineAction = true;
            results.actionType = actionIndicators.type;
            results.evidenceQuality = Math.floor(detectionScore * 100);
            
            return results;
        }
        
        function getActionIndicators(category) {
            const indicators = {
                'recycling': {
                    type: '废物分类回收行动',
                    required: ['分类垃圾桶', '回收材料', '分拣过程', '人员操作'],
                    forbidden: ['纯风景', '无人场景', '网络图片']
                },
                'planting': {
                    type: '植树种植行动',
                    required: ['种植工具', '幼苗植物', '挖土过程', '浇水护理'],
                    forbidden: ['成熟树木', '公园风景', '无行动证据']
                },
                'cleanup': {
                    type: '环境清洁行动',
                    required: ['清洁工具', '垃圾收集', '清理过程', '前后对比'],
                    forbidden: ['干净环境', '无垃圾场景', '纯风景照']
                },
                'conservation': {
                    type: '节能节水行动',
                    required: ['节能设备', '监测仪表', '改进措施', '数据记录'],
                    forbidden: ['普通电器', '无改进证据', '静态展示']
                },
                'transport': {
                    type: '绿色出行行动',
                    required: ['环保交通工具', '出行记录', '团队参与', '路线证明'],
                    forbidden: ['普通交通', '无环保元素', '单纯展示']
                },
                'education': {
                    type: '环保教育行动',
                    required: ['教育材料', '学习过程', '互动场景', '知识分享'],
                    forbidden: ['纯文字材料', '无互动证据', '静态展示']
                },
                'innovation': {
                    type: '生态创新项目',
                    required: ['创新产品', '制作过程', '功能演示', '效果展示'],
                    forbidden: ['现成产品', '无创新元素', '纯理论展示']
                }
            };
            
            return indicators[category] || indicators['cleanup'];
        }

        function updateSubmitButton() {
            const submitButton = document.getElementById('submitButton');
            const content = document.getElementById('content').value;
            
            // Check all safety requirements
            if (!photosVerified || !photoSafetyPassed) {
                submitButton.disabled = true;
                submitButton.className = 'w-full bg-gray-400 text-white py-3 px-6 rounded-lg font-semibold cursor-not-allowed';
                submitButton.textContent = '请先上传并验证照片';
                return;
            }
            
            // If photos are verified but no content yet
            if (photosVerified && photoSafetyPassed && content.length < 10) {
                submitButton.disabled = false;
                submitButton.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold';
                submitButton.textContent = '📝 请填写体验描述后提交';
                return;
            }
            
            // If content has safety issues
            if (content.length > 10 && !contentSafetyPassed) {
                submitButton.disabled = true;
                submitButton.className = 'w-full bg-red-400 text-white py-3 px-6 rounded-lg font-semibold cursor-not-allowed';
                submitButton.textContent = '内容安全检查未通过 - 请修改';
                return;
            }
            
            // Ready to submit - photos verified and content is good
            if (photosVerified && photoSafetyPassed && content.length >= 10) {
                submitButton.disabled = false;
                submitButton.className = 'w-full bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold';
                submitButton.textContent = '🌱 提交绿色行动体验';
            }
        }

        // Monitor content changes
        document.addEventListener('DOMContentLoaded', function() {
            const contentTextarea = document.getElementById('content');
            if (contentTextarea) {
                contentTextarea.addEventListener('input', function() {
                    updateSubmitButton();
                });
            }
        });

        function processContentWithAI() {
            const content = document.getElementById('content').value;
            const aiEnhancementSection = document.getElementById('aiEnhancementSection');
            const aiProcessing = document.getElementById('aiProcessing');
            const enhancedContent = document.getElementById('enhancedContent');
            const enhancedText = document.getElementById('enhancedText');
            
            originalContent = content;
            aiEnhancementSection.classList.remove('hidden');
            aiProcessing.classList.remove('hidden');
            enhancedContent.classList.add('hidden');
            
            // Simulate AI content enhancement with grammar correction
            setTimeout(() => {
                // Generate enhanced content with grammar fixes
                enhancedContentText = generateGrammarCorrectedContent(content);
                
                aiProcessing.classList.add('hidden');
                enhancedContent.classList.remove('hidden');
                enhancedText.innerHTML = enhancedContentText;
                
                // Add keyboard listener for Enter key
                document.addEventListener('keydown', handleEnterKey);
            }, 2000); // Reduced from 4000 to 2000ms for faster processing
        }

        function generateGrammarCorrectedContent(original) {
            // Simulate AI grammar correction and light enhancement
            let corrected = original;
            
            // Basic grammar corrections (simulation)
            corrected = corrected.replace(/，，/g, '，'); // Remove double commas
            corrected = corrected.replace(/。。/g, '。'); // Remove double periods
            corrected = corrected.replace(/\s+/g, ' '); // Clean up extra spaces
            corrected = corrected.replace(/([。！？])([^"」』])/g, '$1 $2'); // Add space after punctuation
            
            // Add proper sentence structure if missing
            if (!corrected.endsWith('。') && !corrected.endsWith('！') && !corrected.endsWith('？')) {
                corrected += '。';
            }
            
            // Simple enhancements while keeping original meaning
            corrected = corrected.replace(/我做了/g, '我参与了');
            corrected = corrected.replace(/很好/g, '非常有意义');
            corrected = corrected.replace(/学到了/g, '深刻学习到了');
            
            const enhanced = `
                <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-3">🤖 AI语法修正版本：</h4>
                    <div class="text-gray-800 leading-relaxed mb-4" style="line-height: 1.8;">
                        ${corrected}
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <p class="text-sm text-blue-800"><strong>✨ AI修正内容：</strong></p>
                        <ul class="text-xs text-blue-700 mt-1 space-y-1">
                            <li>• 修正了语法和标点符号</li>
                            <li>• 优化了句子结构和流畅度</li>
                            <li>• 保持了您的原始意思和真实感受</li>
                            <li>• 让表达更加清晰和专业</li>
                        </ul>
                    </div>
                </div>
            `;
            return enhanced;
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                acceptEnhancement();
            }
        }

        function acceptEnhancement() {
            const contentTextarea = document.getElementById('content');
            
            // Extract the corrected text from the enhanced content
            let corrected = originalContent;
            
            // Apply the same corrections as in generateGrammarCorrectedContent
            corrected = corrected.replace(/，，/g, '，');
            corrected = corrected.replace(/。。/g, '。');
            corrected = corrected.replace(/\s+/g, ' ');
            corrected = corrected.replace(/([。！？])([^"」』])/g, '$1 $2');
            
            if (!corrected.endsWith('。') && !corrected.endsWith('！') && !corrected.endsWith('？')) {
                corrected += '。';
            }
            
            corrected = corrected.replace(/我做了/g, '我参与了');
            corrected = corrected.replace(/很好/g, '非常有意义');
            corrected = corrected.replace(/学到了/g, '深刻学习到了');
            
            // Replace the textarea content with corrected version
            contentTextarea.value = corrected;
            contentEnhanced = true;
            
            document.getElementById('aiEnhancementSection').classList.add('hidden');
            document.removeEventListener('keydown', handleEnterKey);
            updateSubmitButton();
            
            showToast('✨ AI语法修正已应用！您的内容现在更加清晰流畅。');
        }

        function rejectEnhancement() {
            contentEnhanced = false;
            document.getElementById('aiEnhancementSection').classList.add('hidden');
            document.removeEventListener('keydown', handleEnterKey);
            updateSubmitButton();
            
            showToast('Original content kept. Your submission is ready as written.');
        }

        // AI写作指引功能
        function showAIWritingGuidance() {
            const currentContent = document.getElementById('content').value;
            const category = document.getElementById('category').value;
            
            // 创建AI写作指引模态框
            const guidanceModal = document.createElement('div');
            guidanceModal.className = 'fixed inset-0 bg-blue-600 bg-opacity-90 flex items-center justify-center z-50';
            guidanceModal.id = 'aiWritingGuidanceModal';
            
            const enhancedSuggestions = generateAdvancedWritingSuggestions(currentContent, category);
            
            guidanceModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto mx-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-blue-800">🤖 AI专业写作指引</h3>
                        <button onclick="closeAIWritingGuidance()" class="text-gray-400 hover:text-gray-600 text-2xl">✕</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 当前内容分析 -->
                        <div class="bg-green-50 rounded-lg p-6">
                            <h4 class="font-bold text-green-800 mb-4">📊 当前内容分析</h4>
                            <div class="space-y-3">
                                ${enhancedSuggestions.currentAnalysis}
                            </div>
                        </div>
                        
                        <!-- 专业写作建议 -->
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h4 class="font-bold text-blue-800 mb-4">✨ 专业写作建议</h4>
                            <div class="space-y-3">
                                ${enhancedSuggestions.writingTips}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 优化版本生成 -->
                    <div class="mt-6 bg-purple-50 rounded-lg p-6">
                        <h4 class="font-bold text-purple-800 mb-4">🚀 AI优化版本</h4>
                        <div class="bg-white rounded-lg p-4 border-2 border-purple-200 mb-4">
                            <div class="text-gray-800 leading-relaxed" style="line-height: 1.8;">
                                ${enhancedSuggestions.optimizedVersion}
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-3">
                            <button onclick="applyOptimizedVersion()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold">
                                ✅ 使用AI优化版本
                            </button>
                            <button onclick="showWritingTechniques()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold">
                                📚 学习写作技巧
                            </button>
                            <button onclick="generateAlternativeVersion()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold">
                                🔄 生成其他版本
                            </button>
                            <button onclick="closeAIWritingGuidance()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">
                                📝 继续自己写作
                            </button>
                        </div>
                    </div>
                    
                    <!-- 写作技巧学习区域 -->
                    <div id="writingTechniquesSection" class="hidden mt-6 bg-yellow-50 rounded-lg p-6">
                        <h4 class="font-bold text-yellow-800 mb-4">📖 环保写作技巧大全</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${enhancedSuggestions.writingTechniques}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(guidanceModal);
            
            // 存储优化版本以供后续使用
            window.currentOptimizedContent = enhancedSuggestions.optimizedContent;
        }
        
        function generateAdvancedWritingSuggestions(content, category) {
            // 深度分析当前内容
            const wordCount = content.length;
            const sentences = content.split(/[。！？]/).filter(s => s.trim().length > 0);
            const hasEmotionalWords = /感动|激动|兴奋|开心|满足|自豪|感激|温暖|希望/.test(content);
            const hasSpecificDetails = /\d+|具体|详细|清楚|明确/.test(content);
            const hasTeamwork = /一起|合作|帮助|协作|团队|同学|朋友|大家/.test(content);
            
            // 当前内容分析
            const currentAnalysis = `
                <div class="bg-white p-3 rounded border-l-4 border-green-400">
                    <p class="font-semibold text-green-800">📝 内容长度：${wordCount}字 (${wordCount >= 50 ? '✅ 充足' : '⚠️ 可以更详细'})</p>
                    <p class="text-green-700 text-sm">句子数量：${sentences.length}句</p>
                </div>
                <div class="bg-white p-3 rounded border-l-4 border-blue-400">
                    <p class="font-semibold text-blue-800">💭 情感表达：${hasEmotionalWords ? '✅ 丰富' : '💡 可以增加'}</p>
                    <p class="text-blue-700 text-sm">${hasEmotionalWords ? '很好地表达了内心感受' : '建议加入更多情感词汇'}</p>
                </div>
                <div class="bg-white p-3 rounded border-l-4 border-purple-400">
                    <p class="font-semibold text-purple-800">🔍 具体细节：${hasSpecificDetails ? '✅ 详细' : '💡 需要更具体'}</p>
                    <p class="text-purple-700 text-sm">${hasSpecificDetails ? '包含了具体的细节描述' : '可以添加数字、时间等具体信息'}</p>
                </div>
                <div class="bg-white p-3 rounded border-l-4 border-orange-400">
                    <p class="font-semibold text-orange-800">🤝 团队合作：${hasTeamwork ? '✅ 体现' : '💡 可以强调'}</p>
                    <p class="text-orange-700 text-sm">${hasTeamwork ? '很好地展现了合作精神' : '建议描述与他人的互动合作'}</p>
                </div>
            `;
            
            // 专业写作建议
            const writingTips = `
                <div class="bg-white p-3 rounded border-l-4 border-blue-400">
                    <h5 class="font-bold text-blue-800">🎯 开头技巧</h5>
                    <p class="text-blue-700 text-sm">用具体的时间、地点、天气开始，营造画面感</p>
                </div>
                <div class="bg-white p-3 rounded border-l-4 border-green-400">
                    <h5 class="font-bold text-green-800">📖 过程描述</h5>
                    <p class="text-green-700 text-sm">按时间顺序，详细描述每个步骤和感受</p>
                </div>
                <div class="bg-white p-3 rounded border-l-4 border-purple-400">
                    <h5 class="font-bold text-purple-800">💡 感悟升华</h5>
                    <p class="text-purple-700 text-sm">连接个人成长与环保意义，展现深度思考</p>
                </div>
                <div class="bg-white p-3 rounded border-l-4 border-orange-400">
                    <h5 class="font-bold text-orange-800">🌟 结尾呼应</h5>
                    <p class="text-orange-700 text-sm">总结收获，表达对未来环保行动的期待</p>
                </div>
            `;
            
            // 生成优化版本
            const optimizedContent = generateOptimizedContent(content, category);
            const optimizedVersion = optimizedContent.replace(/\n/g, '<br>');
            
            // 写作技巧大全
            const writingTechniques = `
                <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-bold text-gray-800 mb-2">🎨 感官描写技巧</h5>
                    <ul class="text-sm text-gray-700 space-y-1">
                        <li>• 视觉：颜色、形状、大小变化</li>
                        <li>• 听觉：声音、音乐、对话</li>
                        <li>• 触觉：温度、质感、重量</li>
                        <li>• 嗅觉：气味的变化和感受</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-bold text-gray-800 mb-2">💭 情感表达词汇</h5>
                    <ul class="text-sm text-gray-700 space-y-1">
                        <li>• 积极：兴奋、满足、自豪、感激</li>
                        <li>• 成长：启发、领悟、收获、进步</li>
                        <li>• 责任：使命、担当、奉献、坚持</li>
                        <li>• 希望：期待、憧憬、梦想、愿景</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-bold text-gray-800 mb-2">🔢 具体化技巧</h5>
                    <ul class="text-sm text-gray-700 space-y-1">
                        <li>• 时间：具体到小时、分钟</li>
                        <li>• 数量：多少人、多少物品</li>
                        <li>• 尺寸：长度、重量、面积</li>
                        <li>• 效果：百分比、对比数据</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-bold text-gray-800 mb-2">🤝 合作描写要点</h5>
                    <ul class="text-sm text-gray-700 space-y-1">
                        <li>• 分工：谁负责什么任务</li>
                        <li>• 互助：相互帮助的具体行为</li>
                        <li>• 沟通：对话和交流过程</li>
                        <li>• 成果：团队合作的成就感</li>
                    </ul>
                </div>
            `;
            
            return {
                currentAnalysis,
                writingTips,
                optimizedVersion,
                optimizedContent,
                writingTechniques
            };
        }
        
        function generateOptimizedContent(originalContent, category) {
            // 基于原内容生成更专业的优化版本
            const categoryContext = {
                'recycling': '废物分类回收',
                'planting': '植树种植',
                'cleanup': '环境清洁',
                'conservation': '节能节水',
                'transport': '绿色出行',
                'education': '环保教育',
                'innovation': '生态创新',
                'togetherness': '合作关怀'
            };
            
            const actionType = categoryContext[category] || '环保行动';
            
            // 生成结构化的优化内容
            let optimized = `在一个阳光明媚的周末上午，我参与了一次意义深刻的${actionType}活动。\n\n`;
            
            // 保留原内容的核心信息，但增强表达
            if (originalContent.includes('学校') || originalContent.includes('办公室')) {
                optimized += `活动地点选在学校办公室旁边的空地，这里平时人流量大，是进行环保教育的理想场所。`;
            } else {
                optimized += `我们选择了社区附近的一个开放空间，这里环境优美，很适合开展${actionType}活动。`;
            }
            
            optimized += `当我看到现场的情况时，内心涌起了强烈的责任感。\n\n`;
            
            // 过程描述
            optimized += `活动过程中，我们分工明确，相互配合。每个人都全身心投入，认真对待每一个细节。`;
            optimized += `通过大家的共同努力，我们不仅完成了预定目标，更重要的是在过程中学会了团队合作的重要性。\n\n`;
            
            // 结果和感悟
            optimized += `看着活动取得的成果，我深深感受到环保行动的意义不仅在于改善环境，更在于唤醒每个人内心的环保意识。`;
            optimized += `这次经历让我明白，真正的环保不是口号，而是需要我们用实际行动来证明的责任和担当。\n\n`;
            
            optimized += `未来，我会继续参与更多的环保活动，用自己的行动影响身边的人，为建设美丽的生态环境贡献自己的力量。`;
            
            return optimized;
        }
        
        function closeAIWritingGuidance() {
            const modal = document.getElementById('aiWritingGuidanceModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function applyOptimizedVersion() {
            const contentTextarea = document.getElementById('content');
            contentTextarea.value = window.currentOptimizedContent;
            
            // 重新检查内容安全性
            checkContentSafety(window.currentOptimizedContent);
            
            closeAIWritingGuidance();
            showToast('🎉 AI优化版本已应用！您的文章现在更加专业和生动。');
        }
        
        function showWritingTechniques() {
            const techniquesSection = document.getElementById('writingTechniquesSection');
            techniquesSection.classList.toggle('hidden');
        }
        
        function generateAlternativeVersion() {
            const category = document.getElementById('category').value;
            const alternativeContent = generateAlternativeOptimizedContent(category);
            
            // 更新优化版本显示
            const optimizedVersionDiv = document.querySelector('#aiWritingGuidanceModal .bg-white.rounded-lg.p-4.border-2.border-purple-200 .text-gray-800');
            if (optimizedVersionDiv) {
                optimizedVersionDiv.innerHTML = alternativeContent.replace(/\n/g, '<br>');
                window.currentOptimizedContent = alternativeContent;
                showToast('🔄 已生成新的优化版本！');
            }
        }
        
        function generateAlternativeOptimizedContent(category) {
            const alternatives = {
                'recycling': `昨天下午，我和同学们在学校开展了一次废物分类回收活动。看到校园里散落的各种垃圾，我们决定用实际行动来改变这种状况。

我们准备了不同颜色的垃圾袋和分类标签，开始了细致的分类工作。塑料瓶、纸张、食物残渣，每一样都被我们认真地分类处理。在这个过程中，我发现原来垃圾分类需要这么多的知识和耐心。

最让我感动的是，当其他同学看到我们的行动时，也主动加入进来。大家一起工作，一起学习，那种团结合作的氛围让我深深感受到集体的力量。

通过这次活动，我不仅学会了正确的垃圾分类方法，更重要的是理解了环保需要每个人的参与。小小的行动，却能带来大大的改变。`,

                'planting': `春天的早晨，空气格外清新。我参加了社区组织的植树活动，心情既兴奋又紧张。

拿着小树苗和铁锹，我小心翼翼地挖着土坑。泥土的芬芳混合着春天的气息，让我感受到大自然的生命力。当我把小树苗轻轻放入土坑，用双手为它培土时，仿佛能感受到生命在我手中萌发。

活动中，一位老爷爷教我如何正确浇水，如何判断树苗是否种得稳固。他说："种树就像培养孩子，需要耐心和爱心。"这句话深深印在我心里。

看着一排排新种的小树，我想象着它们长大后的样子。也许多年后，这里会成为一片绿荫，为人们带来清新的空气和美丽的环境。`
            };
            
            return alternatives[category] || alternatives['recycling'];
        }

        // Form submission functions
        function submitEcoArticle(event) {
            event.preventDefault();
            
            const content = document.getElementById('content').value;
            
            // Final safety check before submission
            if (!photoSafetyPassed || !contentSafetyPassed) {
                showToast('⚠️ 提交被阻止：请修改不当内容后重新提交。');
                return;
            }
            
            // Check if content meets basic requirements
            const analysisResult = analyzeContentQuality(content);
            
            // If content doesn't meet basic requirements, offer AI help
            if (!analysisResult.passesBasicRequirements && !contentEnhanced) {
                showToast('💡 内容还需要完善，AI可以帮您修正语法并优化表达！');
                processContentWithAI();
                return;
            }
            
            // If content is good but not enhanced, offer AI grammar correction
            if (content.length > 30 && !contentEnhanced && !document.getElementById('aiEnhancementSection').classList.contains('hidden') === false) {
                processContentWithAI();
                return;
            }
            
            // AI教育引导系统 - 生成标准答案和内容升华
            const category = document.getElementById('category').value;
            const studentName = document.getElementById('studentName').value;
            const schoolName = document.getElementById('schoolName').value;
            
            // 生成标准答案示例
            const standardExample = generateStandardExample(category, content);
            
            // 内容升华和教育指导
            const educationalGuidance = generateEducationalGuidance(content, category);
            
            let successMessage = `🎉 绿色行动体验上传成功！

📚 AI学习指导系统：

${standardExample}

${educationalGuidance}

✅ 提交状态：通过 - 已记录您的环保参与
📝 学习成果：观察体验能力提升
🌱 环保意识：持续成长中

🏫 学校参与统计已更新：${schoolName || '个人参与者'}`;

            // 检查5大绿色行动的多样性参与
            const diversityMessage = checkGreenActionDiversity(schoolName, category);
            if (diversityMessage) {
                successMessage += `\n\n${diversityMessage}`;
            }
            
            showToast(successMessage);
            closeEcoSubmissionModal();
            
            // Reset form state
            uploadedPhotos = [];
            photosVerified = false;
            contentEnhanced = false;
            originalContent = '';
            enhancedContentText = '';
            contentSafetyPassed = false;
            photoSafetyPassed = false;
        }

        function submitStudentRegistration(event) {
            event.preventDefault();
            const participationType = document.querySelector('input[name="participationType"]:checked').value;
            const schoolName = document.getElementById('regSchoolName').value;
            
            let message = 'Registration successful! Welcome to the Ecological Civilization Action Platform!';
            if (participationType === 'individual') {
                message += ' You are registered as an individual student participant.';
            } else if (schoolName) {
                message += ` You are registered under ${schoolName}.`;
            }
            
            showToast(message);
            closeStudentRegistrationModal();
        }

        function submitSchoolRegistration(event) {
            event.preventDefault();
            showToast('School registration application submitted! We will contact you within 3 business days.');
            closeSchoolRegistrationModal();
        }

        function handleSchoolLogin(event) {
            event.preventDefault();
            const schoolCode = document.getElementById('schoolCode').value;
            
            if (schoolCode) {
                showToast('Login successful! Loading school management panel...');
                closeSchoolLoginModal();
                // In a real application, this would redirect to the school dashboard
                setTimeout(() => {
                    showToast('School dashboard would load here in the full application.');
                }, 1000);
            }
        }

        function submitSponsorApplication(event) {
            event.preventDefault();
            showToast('Sponsorship application submitted! We will contact you within 24 hours.');
            closeSponsorModal();
        }

        function submitGreenMoverRegistration(event) {
            event.preventDefault();
            showToast('Green Mover registration successful! Welcome to the World Green Movement Award program!');
            closeGreenMoverModal();
        }

        // AI教育引导系统函数
        function generateStandardExample(category, userContent) {
            const examples = {
                'recycling': {
                    title: '📋 废物分类标准示例',
                    content: `🕐 时间地点：2024年8月31日，在学校办公室旁边的空地
🎯 行动动机：为了教育大家正确的废物分类方法，保护环境
📊 行动结果：成功设置了分类回收站，同学们学会了正确分类
💭 个人感悟：通过实际行动，我深刻体会到环保需要每个人的参与`
                },
                'planting': {
                    title: '📋 植树种植标准示例',
                    content: `🕐 时间地点：周末上午，在社区公园的指定绿化区域
🎯 行动动机：为了增加绿色覆盖，改善空气质量，美化环境
📊 行动结果：成功种植了10棵小树苗，建立了长期护理计划
💭 个人感悟：看着小树苗在土壤中扎根，我感受到生命的力量和希望`
                },
                'cleanup': {
                    title: '📋 环境清洁标准示例',
                    content: `🕐 时间地点：上周六早晨，在附近的河边公园
🎯 行动动机：因为看到垃圾污染了美丽的自然环境，想要恢复清洁
📊 行动结果：清理了3袋垃圾，河边恢复了原有的美丽面貌
💭 个人感悟：环境保护不是口号，而是需要我们用行动来证明的责任`
                },
                'conservation': {
                    title: '📋 节能节水标准示例',
                    content: `🕐 时间地点：这个月在家里和学校实施节能计划
🎯 行动动机：为了减少能源浪费，降低碳足迹，保护地球资源
📊 行动结果：用电量减少了20%，水费也明显降低
💭 个人感悟：小小的改变积累起来就是巨大的环保贡献`
                },
                'transport': {
                    title: '📋 绿色出行标准示例',
                    content: `🕐 时间地点：每天上下学路上，选择步行或骑自行车
🎯 行动动机：为了减少汽车尾气排放，同时锻炼身体
📊 行动结果：一个月减少了碳排放，身体也更健康了
💭 个人感悟：绿色出行不仅环保，还让我更加热爱大自然`
                },
                'education': {
                    title: '📋 环保教育标准示例',
                    content: `🕐 时间地点：昨天下午，在班级里组织环保知识分享会
🎯 行动动机：为了提高同学们的环保意识，传播生态文明理念
📊 行动结果：30位同学参与，大家都学到了实用的环保知识
💭 个人感悟：教育他人的过程中，我自己也学到了更多环保知识`
                },
                'innovation': {
                    title: '📋 生态创新标准示例',
                    content: `🕐 时间地点：上周末，在家里的小工作室制作环保装置
🎯 行动动机：为了解决生活中的环保问题，发挥创新思维
📊 行动结果：成功制作了雨水收集装置，可以用来浇花
💭 个人感悟：创新让环保变得更有趣，也让我发现了自己的潜力`
                },
                'togetherness': {
                    title: '📋 合作关怀标准示例',
                    content: `🕐 时间地点：昨天下午，在学校组织蚯蚓堆肥工作坊
🎯 行动动机：为了教导大家有机废料处理，同时培养团队合作精神
📊 行动结果：20位学员学会了蚯蚓养殖技术，大家互相帮助和关怀
💭 个人感悟：通过合作，我们不仅保护了环境，更重要的是建立了深厚的友谊`
                }
            };
            
            const example = examples[category] || examples['cleanup'];
            return `${example.title}：\n${example.content}`;
        }
        
        function generateEducationalGuidance(userContent, category) {
            // 分析用户内容的优点和改进建议
            const hasTimePlace = /在.*时候|在.*地方|昨天|今天|上周|学校|家里|公园|办公室|时间|地点/.test(userContent);
            const hasMotivation = /因为|为了|目的|意义|重要|原因|动机/.test(userContent);
            const hasResult = /结果|效果|影响|改变|提高|减少|节约|成果|收获/.test(userContent);
            const hasReflection = /感到|觉得|体会|学到|收获|启发|感想|感悟/.test(userContent);
            
            let guidance = `🎓 个人表达升华指导：\n\n`;
            
            // 表扬已有的优点
            const strengths = [];
            if (hasTimePlace) strengths.push('✅ 时间地点描述清楚');
            if (hasMotivation) strengths.push('✅ 行动动机表达明确');
            if (hasResult) strengths.push('✅ 行动结果记录完整');
            if (hasReflection) strengths.push('✅ 个人感悟真诚深刻');
            
            if (strengths.length > 0) {
                guidance += `🌟 您的优秀表现：\n${strengths.join('\n')}\n\n`;
            }
            
            // 提供观察体验的深化建议
            guidance += `🔍 观察体验深化建议：\n`;
            guidance += `• 环保行动中的细节观察（工具使用、过程变化）\n`;
            guidance += `• 团队合作的温暖时刻（互助、关怀、共同努力）\n`;
            guidance += `• 环境变化的具体感受（前后对比、改善效果）\n`;
            guidance += `• 内心成长的真实体验（责任感、成就感、使命感）\n\n`;
            
            guidance += `💡 表达技巧提升：\n`;
            guidance += `• 用具体的数字和事实说话\n`;
            guidance += `• 描述感官体验（看到、听到、感受到）\n`;
            guidance += `• 连接个人成长与环保意义\n`;
            guidance += `• 展现对未来环保行动的计划`;
            
            return guidance;
        }
        
        // 学校5大绿色行动多样性检查
        const schoolGreenActions = {}; // 存储各学校的行动类型统计
        
        function checkGreenActionDiversity(schoolName, newCategory) {
            if (!schoolName) return '';
            
            // 初始化学校记录
            if (!schoolGreenActions[schoolName]) {
                schoolGreenActions[schoolName] = {
                    recycling: 0,
                    planting: 0,
                    cleanup: 0,
                    conservation: 0,
                    transport: 0,
                    education: 0,
                    innovation: 0,
                    togetherness: 0 // 合作关怀行动
                };
            }
            
            // 更新统计
            schoolGreenActions[schoolName][newCategory]++;
            
            const actions = schoolGreenActions[schoolName];
            const totalActions = Object.values(actions).reduce((sum, count) => sum + count, 0);
            const diversityCount = Object.values(actions).filter(count => count > 0).length;
            
            let diversityMessage = `\n🏆 ${schoolName} 绿色行动多样性统计：\n`;
            diversityMessage += `📊 总参与次数：${totalActions} 次\n`;
            diversityMessage += `🌈 行动类型覆盖：${diversityCount}/8 种\n\n`;
            
            // 显示各类型参与情况
            const actionNames = {
                recycling: '♻️ 废物分类回收',
                planting: '🌱 植树种植',
                cleanup: '🧹 环境清洁',
                conservation: '💡 节能节水',
                transport: '🚲 绿色出行',
                education: '📚 环保教育',
                innovation: '🔬 生态创新',
                togetherness: '🤝 合作关怀'
            };
            
            Object.entries(actions).forEach(([key, count]) => {
                if (count > 0) {
                    diversityMessage += `${actionNames[key]}：${count} 次\n`;
                }
            });
            
            // 多样性评价和建议
            if (diversityCount >= 5) {
                diversityMessage += `\n🎉 优秀！您的学校展现了全面的环保行动多样性！`;
                diversityMessage += `\n🏅 环环相扣的绿色行动体现了真正的生态文明理念！`;
            } else if (diversityCount >= 3) {
                diversityMessage += `\n👍 很好！继续探索更多类型的环保行动！`;
                diversityMessage += `\n💡 建议：尝试更多合作关怀类的团队环保活动！`;
            } else {
                diversityMessage += `\n🌱 起步阶段，建议尝试不同类型的环保行动！`;
                diversityMessage += `\n🤝 特别推荐：团队合作的环保项目能培养关怀精神！`;
            }
            
            return diversityMessage;
        }

        // Emoji to Image replacement system
        const emojiImageMap = {
            // Header and navigation emojis
            '🌍': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f30d.png',
            '📚': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4da.png',
            '🏫': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f3eb.png',
            '📷': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4f7.png',
            
            // Action category emojis
            '📝': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4dd.png',
            '🎓': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f393.png',
            '🌟': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f31f.png',
            '🎯': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f3af.png',
            
            // Environmental action emojis
            '♻️': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/267e.png',
            '🌱': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f331.png',
            '🧹': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f9f9.png',
            '💡': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4a1.png',
            '🚲': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f6b2.png',
            '🔬': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f52c.png',
            '🤝': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f91d.png',
            
            // Award and ranking emojis
            '🥇': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f947.png',
            '🥈': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f948.png',
            '🥉': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f949.png',
            '🏆': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f3c6.png',
            '👑': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f451.png',
            '💚': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f49a.png',
            
            // Interface and feedback emojis
            '✅': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2705.png',
            '⚠️': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26a0.png',
            '🚫': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f6ab.png',
            '🎉': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f389.png',
            '💡': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4a1.png',
            '🔍': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f50d.png',
            '📊': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4ca.png',
            '📈': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4c8.png',
            '🤖': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f916.png',
            
            // Magazine and reading emojis
            '📖': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4d6.png',
            '✍️': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/270d.png',
            '📅': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4c5.png',
            '🔗': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f517.png',
            
            // Sponsor and partnership emojis
            '🏢': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f3e2.png',
            '⚡': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26a1.png',
            '🏗️': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f3d7.png',
            
            // Photo and upload emojis
            '📸': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4f8.png',
            '🛡️': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f6e1.png',
            '🚨': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f6a8.png',
            '🗑️': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5d1.png',
            
            // Logo editor emojis
            '🎨': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f3a8.png',
            '📏': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4cf.png',
            '🔲': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f532.png',
            '🔧': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f527.png'
        };

        // Function to replace emojis with images (simplified and safe)
        function replaceEmojisWithImages() {
            // Only replace emojis in specific safe containers to avoid breaking the layout
            const safeContainers = document.querySelectorAll('.card-hover, .sponsor-card, .bg-gradient-to-br');
            
            safeContainers.forEach(container => {
                replaceEmojisInElement(container);
            });
        }

        // Function to escape special regex characters
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Enhanced emoji replacement for specific large emojis (like in cards)
        function replaceLargeEmojis() {
            // Replace large emojis in cards and prominent positions
            const largeEmojiSelectors = [
                '.text-5xl', '.text-6xl', '.text-4xl', '.text-3xl', '.text-2xl'
            ];

            largeEmojiSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    Object.entries(emojiImageMap).forEach(([emoji, imageUrl]) => {
                        if (element.textContent.includes(emoji)) {
                            const size = getSizeFromClass(element.className);
                            element.innerHTML = element.innerHTML.replace(
                                new RegExp(escapeRegExp(emoji), 'g'),
                                `<img src="${imageUrl}" alt="${emoji}" class="emoji-image inline-block ${size}" style="vertical-align: middle;" onerror="this.style.display='none'; this.parentNode.innerHTML='${emoji}';">`
                            );
                        }
                    });
                });
            });
        }

        // Get appropriate size class for large emojis
        function getSizeFromClass(className) {
            if (className.includes('text-6xl')) return 'w-16 h-16';
            if (className.includes('text-5xl')) return 'w-14 h-14';
            if (className.includes('text-4xl')) return 'w-12 h-12';
            if (className.includes('text-3xl')) return 'w-10 h-10';
            if (className.includes('text-2xl')) return 'w-8 h-8';
            return 'w-6 h-6';
        }

        // Function to add emoji replacement for dynamically added content (safe version)
        function replaceEmojisInElement(element) {
            // Simple and safe emoji replacement - only replace in innerHTML of specific elements
            if (!element || !element.innerHTML) return;
            
            let html = element.innerHTML;
            let hasChanges = false;
            
            // Only replace a few key emojis to avoid breaking the layout
            const safeEmojis = {
                '🌱': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f331.png',
                '📚': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4da.png',
                '⚡': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26a1.png',
                '🏗️': 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f3d7.png'
            };
            
            Object.entries(safeEmojis).forEach(([emoji, imageUrl]) => {
                if (html.includes(emoji)) {
                    const regex = new RegExp(escapeRegExp(emoji), 'g');
                    html = html.replace(regex, 
                        `<img src="${imageUrl}" alt="${emoji}" class="emoji-image inline-block w-6 h-6" style="vertical-align: middle;" onerror="this.outerHTML='${emoji}';">`
                    );
                    hasChanges = true;
                }
            });
            
            if (hasChanges) {
                element.innerHTML = html;
            }
        }

        // Background image management
        let currentButtonType = '';
        let currentBannerType = '';
        let uploadedBackgroundImage = '';
        let backgroundSettings = {
            greenMovement: { type: 'gradient', value: 'bg-gradient-to-br from-green-500 to-green-600' },
            eMagazine: { type: 'gradient', value: 'bg-gradient-to-br from-orange-500 to-orange-600' },
            studentReg: { type: 'gradient', value: 'bg-gradient-to-br from-blue-500 to-blue-600' },
            greenMover: { type: 'gradient', value: 'bg-gradient-to-br from-purple-500 to-purple-600' }
        };
        
        // Banner background settings
        let bannerSettings = {
            header: { type: 'gradient', value: 'bg-gradient-to-r from-green-600 to-blue-600' },
            hero: { type: 'gradient', value: 'bg-gradient-to-br from-blue-500 to-purple-600' },
            coreFeatures: { type: 'gradient', value: 'bg-gradient-to-br from-green-100 to-blue-100' },
            competition: { type: 'gradient', value: 'bg-gradient-to-br from-purple-200 to-pink-200' },
            partnership: { type: 'gradient', value: 'bg-gradient-to-br from-gray-100 to-blue-100' }
        };

        // Button configuration
        const buttonConfig = {
            greenMovement: { name: 'My Green Movement', icon: '📝', color: 'green' },
            eMagazine: { name: 'E-Magazine', icon: '📚', color: 'orange' },
            studentReg: { name: 'Student Registration', icon: '🎓', color: 'blue' },
            greenMover: { name: 'Green Mover', icon: '🌟', color: 'purple' }
        };
        
        // Banner configuration
        const bannerConfig = {
            header: { name: 'Header Banner', icon: '🏠', description: 'Top navigation header background' },
            hero: { name: 'Hero Section', icon: '🌟', description: 'Main hero section background' },
            coreFeatures: { name: 'Core Features', icon: '🎯', description: 'Core features section background' },
            competition: { name: 'Competition Rankings', icon: '🏆', description: 'Competition rankings section background' },
            partnership: { name: 'Enterprise Partners', icon: '🤝', description: 'Partnership section background' }
        };

        // Logo upload and editing functions
        let logoEditorVisible = false;
        
        function triggerLogoUpload() {
            document.getElementById('logoUpload').click();
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Check if it's an image file
                if (!file.type.startsWith('image/')) {
                    showToast('⚠️ 请上传图片文件（JPG, PNG, SVG等格式）');
                    return;
                }
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('⚠️ 图片文件过大，请选择小于5MB的文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const mecccLogo = document.getElementById('mecccLogo');
                    const logoPlaceholder = document.getElementById('logoPlaceholder');
                    
                    mecccLogo.src = e.target.result;
                    mecccLogo.classList.remove('hidden');
                    logoPlaceholder.classList.add('hidden');
                    
                    // Store logo and settings in localStorage for persistence
                    const logoSettings = {
                        src: e.target.result,
                        size: 64,
                        shape: 'rounded-lg',
                        background: 'bg-white bg-opacity-20'
                    };
                    localStorage.setItem('mecccLogoSettings', JSON.stringify(logoSettings));
                    
                    showToast('✅ MECCC logo已成功上传！点击logo可以编辑样式。');
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleLogoEditor() {
            const logoEditor = document.getElementById('logoEditor');
            logoEditorVisible = !logoEditorVisible;
            
            if (logoEditorVisible) {
                logoEditor.classList.add('show');
                // Load current settings
                loadLogoSettings();
            } else {
                logoEditor.classList.remove('show');
            }
        }

        function adjustLogoSize(size) {
            const mecccLogo = document.getElementById('mecccLogo');
            const sizeDisplay = document.getElementById('sizeDisplay');
            
            mecccLogo.style.width = size + 'px';
            mecccLogo.style.height = size + 'px';
            sizeDisplay.textContent = size + 'px';
            
            // Save settings
            saveLogoSettings();
        }

        function setLogoShape(shape) {
            const mecccLogo = document.getElementById('mecccLogo');
            
            // Remove existing shape classes
            mecccLogo.classList.remove('rounded-lg', 'rounded-full', 'rounded-none');
            mecccLogo.classList.add(shape);
            
            // Save settings
            saveLogoSettings();
            showToast(`✨ Logo形状已更新为${getShapeName(shape)}`);
        }

        function setLogoBg(bgClass) {
            const mecccLogo = document.getElementById('mecccLogo');
            
            // Remove existing background classes
            mecccLogo.classList.remove('bg-white', 'bg-opacity-20', 'bg-green-100', 'bg-blue-100');
            
            // Add new background classes
            const classes = bgClass.split(' ');
            classes.forEach(cls => mecccLogo.classList.add(cls));
            
            // Save settings
            saveLogoSettings();
            showToast(`🎨 Logo背景已更新`);
        }

        function removeLogo() {
            const mecccLogo = document.getElementById('mecccLogo');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            const logoEditor = document.getElementById('logoEditor');
            
            mecccLogo.classList.add('hidden');
            logoPlaceholder.classList.remove('hidden');
            logoEditor.classList.remove('show');
            logoEditorVisible = false;
            
            // Clear localStorage
            localStorage.removeItem('mecccLogoSettings');
            
            showToast('🗑️ Logo已删除');
        }

        function saveLogoSettings() {
            const mecccLogo = document.getElementById('mecccLogo');
            const logoSizeSlider = document.getElementById('logoSizeSlider');
            
            if (mecccLogo.src) {
                const logoSettings = {
                    src: mecccLogo.src,
                    size: logoSizeSlider.value,
                    shape: getLogoShape(mecccLogo),
                    background: getLogoBackground(mecccLogo)
                };
                localStorage.setItem('mecccLogoSettings', JSON.stringify(logoSettings));
            }
        }

        function loadLogoSettings() {
            const savedSettings = localStorage.getItem('mecccLogoSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                const logoSizeSlider = document.getElementById('logoSizeSlider');
                const sizeDisplay = document.getElementById('sizeDisplay');
                
                logoSizeSlider.value = settings.size;
                sizeDisplay.textContent = settings.size + 'px';
            }
        }

        function getLogoShape(logoElement) {
            if (logoElement.classList.contains('rounded-full')) return 'rounded-full';
            if (logoElement.classList.contains('rounded-none')) return 'rounded-none';
            return 'rounded-lg';
        }

        function getLogoBackground(logoElement) {
            if (logoElement.classList.contains('bg-green-100')) return 'bg-green-100';
            if (logoElement.classList.contains('bg-blue-100')) return 'bg-blue-100';
            if (logoElement.classList.contains('bg-white') && !logoElement.classList.contains('bg-opacity-20')) return 'bg-white';
            return 'bg-white bg-opacity-20';
        }

        function getShapeName(shape) {
            switch(shape) {
                case 'rounded-full': return '圆形';
                case 'rounded-none': return '方形';
                default: return '圆角';
            }
        }

        // Load saved logo on page load
        function loadSavedLogo() {
            const savedSettings = localStorage.getItem('mecccLogoSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                const mecccLogo = document.getElementById('mecccLogo');
                const logoPlaceholder = document.getElementById('logoPlaceholder');
                
                mecccLogo.src = settings.src;
                mecccLogo.style.width = settings.size + 'px';
                mecccLogo.style.height = settings.size + 'px';
                
                // Apply shape
                mecccLogo.classList.remove('rounded-lg', 'rounded-full', 'rounded-none');
                mecccLogo.classList.add(settings.shape);
                
                // Apply background
                mecccLogo.classList.remove('bg-white', 'bg-opacity-20', 'bg-green-100', 'bg-blue-100');
                const bgClasses = settings.background.split(' ');
                bgClasses.forEach(cls => mecccLogo.classList.add(cls));
                
                mecccLogo.classList.remove('hidden');
                logoPlaceholder.classList.add('hidden');
            }
        }

        // Background image functions
        function changeButtonBackground(buttonType) {
            currentButtonType = buttonType;
            currentBannerType = '';
            const config = buttonConfig[buttonType];
            
            // Update modal content
            document.getElementById('currentButtonIcon').textContent = config.icon;
            document.getElementById('currentButtonName').textContent = config.name;
            document.getElementById('previewIcon').textContent = config.icon;
            document.getElementById('previewTitle').textContent = config.name;
            
            // Reset form
            document.getElementById('backgroundImageUpload').value = '';
            document.getElementById('backgroundPreview').classList.add('hidden');
            document.getElementById('opacityControl').classList.add('hidden');
            document.getElementById('applyBackgroundBtn').disabled = true;
            document.getElementById('applyBackgroundBtn').className = 'flex-1 bg-gray-400 text-white py-3 px-4 rounded-lg font-semibold cursor-not-allowed';
            
            // Show modal
            document.getElementById('backgroundUploadModal').classList.remove('hidden');
        }
        
        // Banner background functions
        function changeBannerBackground(bannerType) {
            currentBannerType = bannerType;
            currentButtonType = '';
            const config = bannerConfig[bannerType];
            
            // Update modal content for banner
            document.getElementById('currentButtonIcon').textContent = config.icon;
            document.getElementById('currentButtonName').textContent = config.name;
            document.getElementById('previewIcon').textContent = config.icon;
            document.getElementById('previewTitle').textContent = config.name;
            
            // Reset form
            document.getElementById('backgroundImageUpload').value = '';
            document.getElementById('backgroundPreview').classList.add('hidden');
            document.getElementById('opacityControl').classList.add('hidden');
            document.getElementById('applyBackgroundBtn').disabled = true;
            document.getElementById('applyBackgroundBtn').className = 'flex-1 bg-gray-400 text-white py-3 px-4 rounded-lg font-semibold cursor-not-allowed';
            
            // Show modal
            document.getElementById('backgroundUploadModal').classList.remove('hidden');
        }

        function closeBackgroundUploadModal() {
            document.getElementById('backgroundUploadModal').classList.add('hidden');
            currentButtonType = '';
            currentBannerType = '';
            uploadedBackgroundImage = '';
        }

        function handleBackgroundImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Check if it's an image file
                if (!file.type.startsWith('image/')) {
                    showToast('⚠️ 请上传图片文件（JPG, PNG, WebP等格式）');
                    return;
                }
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('⚠️ 图片文件过大，请选择小于10MB的文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedBackgroundImage = e.target.result;
                    
                    // Show preview
                    const previewBackground = document.getElementById('previewBackground');
                    previewBackground.style.backgroundImage = `url(${uploadedBackgroundImage})`;
                    
                    document.getElementById('backgroundPreview').classList.remove('hidden');
                    document.getElementById('opacityControl').classList.remove('hidden');
                    
                    // Enable apply button
                    const applyBtn = document.getElementById('applyBackgroundBtn');
                    applyBtn.disabled = false;
                    applyBtn.className = 'flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold';
                    
                    showToast('✅ 图片上传成功！您可以调整透明度并预览效果。');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateBackgroundOpacity(opacity) {
            const previewBackground = document.getElementById('previewBackground');
            previewBackground.style.opacity = opacity;
        }

        function applyBackgroundImage() {
            if ((!currentButtonType && !currentBannerType) || !uploadedBackgroundImage) return;
            
            const opacity = document.getElementById('backgroundOpacity').value;
            const targetName = currentButtonType ? buttonConfig[currentButtonType].name : bannerConfig[currentBannerType].name;
            
            showConfirmation(
                `您确定要更换${targetName}的背景图片吗？`,
                `新背景：自定义图片\n透明度：${Math.round(opacity * 100)}%\n此操作将替换当前背景设置。`,
                '🖼️',
                () => {
                    if (currentButtonType) {
                        // Handle button background
                        const backgroundElement = document.getElementById(currentButtonType + 'Bg');
                        const oldSettings = backgroundSettings[currentButtonType];
                        
                        // 保存到历史记录
                        saveToHistory(
                            CHANGE_TYPES.BACKGROUND_CHANGE,
                            currentButtonType + 'Bg',
                            oldSettings,
                            {
                                type: 'image',
                                value: uploadedBackgroundImage,
                                opacity: opacity
                            },
                            { backgroundId: currentButtonType + 'Bg' }
                        );
                        
                        backgroundElement.style.backgroundImage = `url(${uploadedBackgroundImage})`;
                        backgroundElement.style.opacity = opacity;
                        
                        // Update settings
                        backgroundSettings[currentButtonType] = {
                            type: 'image',
                            value: uploadedBackgroundImage,
                            opacity: opacity
                        };
                        
                        // Save to localStorage
                        localStorage.setItem('buttonBackgroundSettings', JSON.stringify(backgroundSettings));
                        showToast(`🎉 ${buttonConfig[currentButtonType].name} 背景已更新！`);
                        
                    } else if (currentBannerType) {
                        // Handle banner background
                        const backgroundElement = document.getElementById(currentBannerType + 'Bg');
                        const oldSettings = bannerSettings[currentBannerType];
                        
                        // 保存到历史记录
                        saveToHistory(
                            CHANGE_TYPES.BACKGROUND_CHANGE,
                            currentBannerType + 'Bg',
                            oldSettings,
                            {
                                type: 'image',
                                value: uploadedBackgroundImage,
                                opacity: opacity
                            },
                            { backgroundId: currentBannerType + 'Bg' }
                        );
                        
                        backgroundElement.style.backgroundImage = `url(${uploadedBackgroundImage})`;
                        backgroundElement.style.opacity = opacity;
                        
                        // Update settings
                        bannerSettings[currentBannerType] = {
                            type: 'image',
                            value: uploadedBackgroundImage,
                            opacity: opacity
                        };
                        
                        // Save to localStorage
                        localStorage.setItem('bannerBackgroundSettings', JSON.stringify(bannerSettings));
                        showToast(`🎉 ${bannerConfig[currentBannerType].name} 背景已更新！`);
                    }
                    
                    closeBackgroundUploadModal();
                }
            );
        }

        function resetToGradient() {
            if (!currentButtonType && !currentBannerType) return;
            
            if (currentButtonType) {
                // Handle button reset
                const backgroundElement = document.getElementById(currentButtonType + 'Bg');
                const config = buttonConfig[currentButtonType];
                
                // Reset to original gradient
                const gradientClass = `bg-gradient-to-br from-${config.color}-500 to-${config.color}-600`;
                backgroundElement.style.backgroundImage = '';
                backgroundElement.style.opacity = '1';
                backgroundElement.className = `absolute inset-0 ${gradientClass} hover:from-${config.color}-600 hover:to-${config.color}-700 transition-all bg-cover bg-center`;
                
                // Update settings
                backgroundSettings[currentButtonType] = {
                    type: 'gradient',
                    value: gradientClass
                };
                
                // Save to localStorage
                localStorage.setItem('buttonBackgroundSettings', JSON.stringify(backgroundSettings));
                showToast(`🔄 ${buttonConfig[currentButtonType].name} 已恢复为渐变背景！`);
                
            } else if (currentBannerType) {
                // Handle banner reset
                const backgroundElement = document.getElementById(currentBannerType + 'Bg');
                const originalGradient = bannerSettings[currentBannerType].value;
                
                // Reset to original gradient
                backgroundElement.style.backgroundImage = '';
                backgroundElement.style.opacity = '1';
                backgroundElement.className = `absolute inset-0 ${originalGradient}`;
                
                // Update settings
                bannerSettings[currentBannerType] = {
                    type: 'gradient',
                    value: originalGradient
                };
                
                // Save to localStorage
                localStorage.setItem('bannerBackgroundSettings', JSON.stringify(bannerSettings));
                showToast(`🔄 ${bannerConfig[currentBannerType].name} 已恢复为渐变背景！`);
            }
            
            closeBackgroundUploadModal();
        }

        function applyPresetBackground(presetType) {
            if (!currentButtonType && !currentBannerType) return;
            
            let presetStyle = '';
            
            switch(presetType) {
                case 'nature':
                    presetStyle = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%2310b981\' fill-opacity=\'0.1\'%3E%3Ccircle cx=\'30\' cy=\'30\' r=\'4\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")';
                    break;
                case 'ocean':
                    presetStyle = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    break;
                case 'sunset':
                    presetStyle = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                    break;
                case 'forest':
                    presetStyle = 'linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%)';
                    break;
                case 'sky':
                    presetStyle = 'linear-gradient(135deg, #87CEEB 0%, #4682B4 100%)';
                    break;
                case 'earth':
                    presetStyle = 'linear-gradient(135deg, #D2691E 0%, #8B4513 100%)';
                    break;
            }
            
            const presetNames = {
                nature: '自然',
                ocean: '海洋',
                sunset: '日落',
                forest: '森林',
                sky: '天空',
                earth: '大地'
            };
            
            if (currentButtonType) {
                // Handle button preset
                const backgroundElement = document.getElementById(currentButtonType + 'Bg');
                backgroundElement.style.backgroundImage = presetStyle;
                backgroundElement.style.opacity = '1';
                
                // Update settings
                backgroundSettings[currentButtonType] = {
                    type: 'preset',
                    value: presetStyle,
                    preset: presetType
                };
                
                // Save to localStorage
                localStorage.setItem('buttonBackgroundSettings', JSON.stringify(backgroundSettings));
                showToast(`🎨 ${buttonConfig[currentButtonType].name} 已应用${presetNames[presetType]}背景！`);
                
            } else if (currentBannerType) {
                // Handle banner preset
                const backgroundElement = document.getElementById(currentBannerType + 'Bg');
                backgroundElement.style.backgroundImage = presetStyle;
                backgroundElement.style.opacity = '1';
                
                // Update settings
                bannerSettings[currentBannerType] = {
                    type: 'preset',
                    value: presetStyle,
                    preset: presetType
                };
                
                // Save to localStorage
                localStorage.setItem('bannerBackgroundSettings', JSON.stringify(bannerSettings));
                showToast(`🎨 ${bannerConfig[currentBannerType].name} 已应用${presetNames[presetType]}背景！`);
            }
            
            closeBackgroundUploadModal();
        }

        // Load saved background settings
        function loadSavedBackgrounds() {
            // Load button backgrounds
            const savedButtonSettings = localStorage.getItem('buttonBackgroundSettings');
            if (savedButtonSettings) {
                const settings = JSON.parse(savedButtonSettings);
                
                Object.entries(settings).forEach(([buttonType, setting]) => {
                    const backgroundElement = document.getElementById(buttonType + 'Bg');
                    if (backgroundElement) {
                        if (setting.type === 'image') {
                            backgroundElement.style.backgroundImage = `url(${setting.value})`;
                            backgroundElement.style.opacity = setting.opacity || '1';
                        } else if (setting.type === 'preset') {
                            backgroundElement.style.backgroundImage = setting.value;
                            backgroundElement.style.opacity = '1';
                        }
                        // Gradient backgrounds are already set by default
                    }
                });
                
                backgroundSettings = { ...backgroundSettings, ...settings };
            }
            
            // Load banner backgrounds
            const savedBannerSettings = localStorage.getItem('bannerBackgroundSettings');
            if (savedBannerSettings) {
                const settings = JSON.parse(savedBannerSettings);
                
                Object.entries(settings).forEach(([bannerType, setting]) => {
                    const backgroundElement = document.getElementById(bannerType + 'Bg');
                    if (backgroundElement) {
                        if (setting.type === 'image') {
                            backgroundElement.style.backgroundImage = `url(${setting.value})`;
                            backgroundElement.style.opacity = setting.opacity || '1';
                        } else if (setting.type === 'preset') {
                            backgroundElement.style.backgroundImage = setting.value;
                            backgroundElement.style.opacity = '1';
                        }
                        // Gradient backgrounds are already set by default
                    }
                });
                
                bannerSettings = { ...bannerSettings, ...settings };
            }
        }

        // Close logo editor when clicking outside
        document.addEventListener('click', function(event) {
            const logoContainer = document.getElementById('logoContainer');
            const logoEditor = document.getElementById('logoEditor');
            
            if (logoEditorVisible && !logoContainer.contains(event.target)) {
                logoEditor.classList.remove('show');
                logoEditorVisible = false;
            }
        });

        // Text editing system
        let isTextEditMode = false;
        let selectedTextElement = null;
        let currentlyEditing = null;
        
        // Undo/Redo system
        let changeHistory = [];
        let currentHistoryIndex = -1;
        const MAX_HISTORY = 50; // 最多保存50个历史记录
        
        // Change types
        const CHANGE_TYPES = {
            TEXT_EDIT: 'text_edit',
            FONT_SIZE: 'font_size',
            FONT_STYLE: 'font_style',
            TEXT_ADD: 'text_add',
            TEXT_DELETE: 'text_delete',
            BACKGROUND_CHANGE: 'background_change',
            LOGO_CHANGE: 'logo_change'
        };
        
        // Emoji collections for picker
        const emojiCollections = {
            nature: ['🌱', '🌿', '🌳', '🌲', '🌴', '🌵', '🌾', '🌺', '🌻', '🌷', '🌹', '🌸', '🌼', '🌙', '⭐', '🌟', '💫', '☀️', '🌤️', '⛅', '🌦️', '🌧️', '⛈️', '🌩️', '❄️', '☃️', '⛄', '🌊', '💧', '🔥', '🌍', '🌎', '🌏'],
            objects: ['📚', '📖', '📝', '✏️', '🖊️', '🖍️', '📄', '📃', '📋', '📊', '📈', '📉', '📌', '📍', '📎', '🖇️', '📐', '📏', '🔍', '🔎', '💡', '🔦', '🕯️', '🪔', '🔋', '🔌', '💻', '🖥️', '🖨️', '⌨️', '🖱️', '💾', '💿', '📀'],
            symbols: ['✅', '❌', '⭐', '🌟', '💫', '✨', '🎯', '🎪', '🎨', '🎭', '🎪', '🎡', '🎢', '🎠', '🎰', '🃏', '🎲', '🎮', '🕹️', '🎸', '🎺', '🎷', '🎻', '🥁', '🎤', '🎧', '🎵', '🎶', '🎼', '🎹', '🏆', '🥇', '🥈', '🥉'],
            faces: ['😊', '😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞']
        };
        
        // Undo/Redo system functions
        let pendingAction = null; // 存储待确认的操作
        
        function saveToHistory(changeType, elementId, oldValue, newValue, additionalData = {}) {
            // 清除当前位置之后的历史记录（如果用户在历史中间进行了新操作）
            if (currentHistoryIndex < changeHistory.length - 1) {
                changeHistory = changeHistory.slice(0, currentHistoryIndex + 1);
            }
            
            const change = {
                id: Date.now() + Math.random(), // 唯一ID
                timestamp: Date.now(),
                type: changeType,
                elementId: elementId,
                oldValue: oldValue,
                newValue: newValue,
                ...additionalData
            };
            
            changeHistory.push(change);
            currentHistoryIndex = changeHistory.length - 1;
            
            // 限制历史记录数量
            if (changeHistory.length > MAX_HISTORY) {
                changeHistory.shift();
                currentHistoryIndex--;
            }
            
            updateHistoryButtons();
            
            // 保存到localStorage
            localStorage.setItem('changeHistory', JSON.stringify(changeHistory));
            localStorage.setItem('currentHistoryIndex', currentHistoryIndex.toString());
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            const historyStatus = document.getElementById('historyStatus');
            
            // 更新撤销按钮
            if (currentHistoryIndex >= 0) {
                undoBtn.disabled = false;
                undoBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs';
            } else {
                undoBtn.disabled = true;
                undoBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs cursor-not-allowed';
            }
            
            // 更新重做按钮
            if (currentHistoryIndex < changeHistory.length - 1) {
                redoBtn.disabled = false;
                redoBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs';
            } else {
                redoBtn.disabled = true;
                redoBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs cursor-not-allowed';
            }
            
            // 更新状态文本
            if (changeHistory.length === 0) {
                historyStatus.textContent = '无历史记录';
            } else {
                historyStatus.textContent = `${currentHistoryIndex + 1}/${changeHistory.length} 步操作`;
            }
        }
        
        function undoChange() {
            if (currentHistoryIndex < 0) return;
            
            const change = changeHistory[currentHistoryIndex];
            applyChange(change, true); // true表示撤销
            currentHistoryIndex--;
            updateHistoryButtons();
            
            showToast(`↩️ 已撤销：${getChangeDescription(change)}`);
        }
        
        function redoChange() {
            if (currentHistoryIndex >= changeHistory.length - 1) return;
            
            currentHistoryIndex++;
            const change = changeHistory[currentHistoryIndex];
            applyChange(change, false); // false表示重做
            updateHistoryButtons();
            
            showToast(`↪️ 已重做：${getChangeDescription(change)}`);
        }
        
        function applyChange(change, isUndo) {
            const element = document.getElementById(change.elementId) || 
                           document.querySelector(`[data-element-id="${change.elementId}"]`);
            
            switch (change.type) {
                case CHANGE_TYPES.TEXT_EDIT:
                    if (element) {
                        element.textContent = isUndo ? change.oldValue : change.newValue;
                    }
                    break;
                    
                case CHANGE_TYPES.FONT_SIZE:
                    if (element) {
                        element.style.fontSize = isUndo ? change.oldValue : change.newValue;
                    }
                    break;
                    
                case CHANGE_TYPES.FONT_STYLE:
                    if (element) {
                        const property = change.property;
                        element.style[property] = isUndo ? change.oldValue : change.newValue;
                    }
                    break;
                    
                case CHANGE_TYPES.TEXT_ADD:
                    if (isUndo && element) {
                        element.remove();
                    } else if (!isUndo && !element) {
                        // 重新创建元素
                        recreateTextElement(change);
                    }
                    break;
                    
                case CHANGE_TYPES.TEXT_DELETE:
                    if (isUndo && !element) {
                        // 重新创建被删除的元素
                        recreateTextElement(change);
                    } else if (!isUndo && element) {
                        element.remove();
                    }
                    break;
                    
                case CHANGE_TYPES.BACKGROUND_CHANGE:
                    applyBackgroundChange(change, isUndo);
                    break;
                    
                case CHANGE_TYPES.LOGO_CHANGE:
                    applyLogoChange(change, isUndo);
                    break;
            }
        }
        
        function recreateTextElement(change) {
            const container = document.querySelector(change.containerSelector);
            if (container) {
                const element = document.createElement('div');
                element.className = change.className;
                element.textContent = change.textContent;
                element.setAttribute('data-element-id', change.elementId);
                container.appendChild(element);
                
                // 如果在编辑模式，添加编辑功能
                if (isTextEditMode) {
                    element.classList.add('editable-text');
                    element.addEventListener('click', handleTextElementClick);
                }
            }
        }
        
        function applyBackgroundChange(change, isUndo) {
            const element = document.getElementById(change.backgroundId);
            if (element) {
                const targetValue = isUndo ? change.oldValue : change.newValue;
                if (targetValue.type === 'image') {
                    element.style.backgroundImage = `url(${targetValue.value})`;
                    element.style.opacity = targetValue.opacity || '1';
                } else {
                    element.style.backgroundImage = '';
                    element.style.opacity = '1';
                    element.className = targetValue.className;
                }
            }
        }
        
        function applyLogoChange(change, isUndo) {
            const logo = document.getElementById('mecccLogo');
            const placeholder = document.getElementById('logoPlaceholder');
            const targetValue = isUndo ? change.oldValue : change.newValue;
            
            if (targetValue.src) {
                logo.src = targetValue.src;
                logo.style.width = targetValue.size + 'px';
                logo.style.height = targetValue.size + 'px';
                logo.className = targetValue.className;
                logo.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                logo.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }
        
        function getChangeDescription(change) {
            switch (change.type) {
                case CHANGE_TYPES.TEXT_EDIT:
                    return '文字编辑';
                case CHANGE_TYPES.FONT_SIZE:
                    return '字体大小调整';
                case CHANGE_TYPES.FONT_STYLE:
                    return '字体样式修改';
                case CHANGE_TYPES.TEXT_ADD:
                    return '添加文字元素';
                case CHANGE_TYPES.TEXT_DELETE:
                    return '删除文字元素';
                case CHANGE_TYPES.BACKGROUND_CHANGE:
                    return '背景修改';
                case CHANGE_TYPES.LOGO_CHANGE:
                    return 'Logo修改';
                default:
                    return '未知操作';
            }
        }
        
        function showConfirmation(message, details, icon, action) {
            pendingAction = action;
            
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('changeDetails').textContent = details;
            document.getElementById('confirmationIcon').textContent = icon;
            document.getElementById('confirmationModal').classList.remove('hidden');
        }
        
        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.add('hidden');
            pendingAction = null;
        }
        
        function confirmAction() {
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
            closeConfirmationModal();
        }
        
        // Load history from localStorage
        function loadChangeHistory() {
            const savedHistory = localStorage.getItem('changeHistory');
            const savedIndex = localStorage.getItem('currentHistoryIndex');
            
            if (savedHistory) {
                try {
                    changeHistory = JSON.parse(savedHistory);
                    currentHistoryIndex = savedIndex ? parseInt(savedIndex) : -1;
                    updateHistoryButtons();
                } catch (e) {
                    console.log('Failed to load change history');
                    changeHistory = [];
                    currentHistoryIndex = -1;
                }
            }
        }

        // Admin access functions
        const ADMIN_PASSWORD = "admin2024"; // 可以更改为更复杂的密码
        let adminAccessAttempts = 0;
        const MAX_ATTEMPTS = 3;
        
        function showAdminAccessModal() {
            // 检查是否已经是管理员模式
            if (isAdminMode) {
                // 如果已经是管理员模式，直接退出
                exitAdminMode();
                return;
            }
            
            // 检查尝试次数
            if (adminAccessAttempts >= MAX_ATTEMPTS) {
                showToast('🚫 访问尝试次数过多，请稍后再试。');
                return;
            }
            
            document.getElementById('adminAccessModal').classList.remove('hidden');
            document.getElementById('adminAccessPassword').focus();
        }
        
        function closeAdminAccessModal() {
            document.getElementById('adminAccessModal').classList.add('hidden');
            document.getElementById('adminAccessPassword').value = '';
        }
        
        function verifyAdminAccess(event) {
            event.preventDefault();
            const password = document.getElementById('adminAccessPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                // 密码正确，进入管理员模式
                enterAdminMode();
                closeAdminAccessModal();
                adminAccessAttempts = 0; // 重置尝试次数
            } else {
                // 密码错误
                adminAccessAttempts++;
                const remainingAttempts = MAX_ATTEMPTS - adminAccessAttempts;
                
                if (remainingAttempts > 0) {
                    showToast(`❌ 密码错误！还有 ${remainingAttempts} 次尝试机会。`);
                    document.getElementById('adminAccessPassword').value = '';
                    document.getElementById('adminAccessPassword').focus();
                } else {
                    showToast('🚫 密码错误次数过多，访问已被暂时锁定。');
                    closeAdminAccessModal();
                    
                    // 5分钟后重置尝试次数
                    setTimeout(() => {
                        adminAccessAttempts = 0;
                        showToast('🔓 管理员访问已解锁，可以重新尝试。');
                    }, 300000); // 5分钟
                }
            }
        }
        
        function enterAdminMode() {
            isAdminMode = true;
            const adminElements = document.querySelectorAll('.admin-only');
            const adminModeText = document.getElementById('adminModeText');
            
            // Show admin controls
            adminElements.forEach(element => {
                element.classList.remove('hidden');
            });
            adminModeText.innerHTML = '🚪 退出管理员模式';
            
            // Save admin mode state
            localStorage.setItem('adminModeEnabled', 'true');
            localStorage.setItem('adminModeTimestamp', Date.now().toString());
            
            showToast('🔧 管理员模式已启用！现在可以自定义所有背景和Logo。点击右上角按钮可退出。');
            
            // 自动退出机制：30分钟后自动退出管理员模式
            setTimeout(() => {
                if (isAdminMode) {
                    exitAdminMode();
                    showToast('⏰ 管理员模式已自动退出（30分钟超时）。');
                }
            }, 1800000); // 30分钟
        }
        
        function exitAdminMode() {
            isAdminMode = false;
            const adminElements = document.querySelectorAll('.admin-only');
            const adminModeText = document.getElementById('adminModeText');
            
            // Hide admin controls
            adminElements.forEach(element => {
                element.classList.add('hidden');
            });
            adminModeText.innerHTML = '🔧 Admin Access';
            
            // Clear admin mode state
            localStorage.removeItem('adminModeEnabled');
            localStorage.removeItem('adminModeTimestamp');
            
            showToast('👤 已退出管理员模式。自定义功能已隐藏。');
        }
        
        // Load admin mode state on page load
        function loadAdminModeState() {
            const savedAdminMode = localStorage.getItem('adminModeEnabled');
            const savedTimestamp = localStorage.getItem('adminModeTimestamp');
            
            if (savedAdminMode === 'true' && savedTimestamp) {
                const currentTime = Date.now();
                const savedTime = parseInt(savedTimestamp);
                const timeDiff = currentTime - savedTime;
                
                // 检查是否超过30分钟（1800000毫秒）
                if (timeDiff < 1800000) {
                    // 未超时，恢复管理员模式
                    isAdminMode = true;
                    const adminElements = document.querySelectorAll('.admin-only');
                    const adminModeText = document.getElementById('adminModeText');
                    
                    adminElements.forEach(element => {
                        element.classList.remove('hidden');
                    });
                    adminModeText.innerHTML = '🚪 退出管理员模式';
                    
                    // 计算剩余时间并设置自动退出
                    const remainingTime = 1800000 - timeDiff;
                    setTimeout(() => {
                        if (isAdminMode) {
                            exitAdminMode();
                            showToast('⏰ 管理员模式已自动退出（30分钟超时）。');
                        }
                    }, remainingTime);
                    
                    showToast(`🔧 管理员模式已恢复。将在 ${Math.ceil(remainingTime / 60000)} 分钟后自动退出。`);
                } else {
                    // 已超时，清除状态
                    localStorage.removeItem('adminModeEnabled');
                    localStorage.removeItem('adminModeTimestamp');
                }
            }
        }

        // Toolbar dragging functionality
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let isToolbarCollapsed = false;
        
        function initializeToolbarDragging() {
            const toolbar = document.getElementById('textEditToolbar');
            const header = document.getElementById('toolbarHeader');
            
            header.addEventListener('mousedown', function(e) {
                isDragging = true;
                const rect = toolbar.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                document.addEventListener('mousemove', handleToolbarDrag);
                document.addEventListener('mouseup', stopToolbarDrag);
                
                // Prevent text selection while dragging
                e.preventDefault();
            });
        }
        
        function handleToolbarDrag(e) {
            if (!isDragging) return;
            
            const toolbar = document.getElementById('textEditToolbar');
            const newX = e.clientX - dragOffset.x;
            const newY = e.clientY - dragOffset.y;
            
            // Keep toolbar within viewport bounds
            const maxX = window.innerWidth - toolbar.offsetWidth;
            const maxY = window.innerHeight - toolbar.offsetHeight;
            
            const constrainedX = Math.max(0, Math.min(newX, maxX));
            const constrainedY = Math.max(0, Math.min(newY, maxY));
            
            toolbar.style.left = constrainedX + 'px';
            toolbar.style.top = constrainedY + 'px';
            toolbar.style.right = 'auto'; // Remove right positioning
        }
        
        function stopToolbarDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', handleToolbarDrag);
            document.removeEventListener('mouseup', stopToolbarDrag);
        }
        
        function toggleToolbarCollapse() {
            const toolbarContent = document.getElementById('toolbarContent');
            const collapseBtn = document.getElementById('collapseBtn');
            
            isToolbarCollapsed = !isToolbarCollapsed;
            
            if (isToolbarCollapsed) {
                toolbarContent.style.display = 'none';
                collapseBtn.textContent = '➕';
                collapseBtn.title = '展开工具栏';
            } else {
                toolbarContent.style.display = 'block';
                collapseBtn.textContent = '➖';
                collapseBtn.title = '折叠工具栏';
            }
        }

        // Text editing functions
        function toggleTextEditMode() {
            isTextEditMode = !isTextEditMode;
            const textEditModeText = document.getElementById('textEditModeText');
            const textEditToolbar = document.getElementById('textEditToolbar');
            const body = document.body;
            
            if (isTextEditMode) {
                // Enter text edit mode
                body.classList.add('text-edit-mode');
                textEditModeText.textContent = '🚪 退出文字编辑';
                textEditToolbar.classList.remove('hidden');
                
                // Initialize dragging functionality
                initializeToolbarDragging();
                
                // Make text elements editable
                makeTextElementsEditable();
                
                showToast('✏️ 文字编辑模式已启用！工具栏可拖拽和折叠。点击文字直接编辑，Enter保存，Esc取消。');
            } else {
                // Exit text edit mode
                body.classList.remove('text-edit-mode');
                textEditModeText.textContent = '✏️ 文字编辑模式';
                textEditToolbar.classList.add('hidden');
                
                // Remove editable classes
                removeTextEditability();
                
                // Clear selection
                clearSelection();
                
                showToast('👤 已退出文字编辑模式。所有编辑功能已关闭。');
            }
        }
        
        function makeTextElementsEditable() {
            // Find all text elements that can be edited
            const textSelectors = [
                'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span', 'div', 'button', 'a', 'li'
            ];
            
            textSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    // Skip elements that are part of the editing interface
                    if (element.closest('#textEditToolbar') || 
                        element.closest('#emojiPickerModal') || 
                        element.closest('#textInputModal') ||
                        element.closest('#toast') ||
                        element.classList.contains('admin-only')) {
                        return;
                    }
                    
                    // Skip elements that contain only other elements (no direct text)
                    if (element.children.length > 0 && !hasDirectTextContent(element)) {
                        return;
                    }
                    
                    element.classList.add('editable-text');
                    
                    // 使用捕获阶段的事件监听器，确保优先处理
                    element.addEventListener('click', handleTextElementClick, true);
                    
                    // 如果是按钮内的文字，添加额外的保护
                    if (element.closest('button')) {
                        element.addEventListener('mousedown', function(e) {
                            if (isTextEditMode) {
                                e.preventDefault();
                                e.stopPropagation();
                                e.stopImmediatePropagation();
                            }
                        }, true);
                        
                        element.addEventListener('mouseup', function(e) {
                            if (isTextEditMode) {
                                e.preventDefault();
                                e.stopPropagation();
                                e.stopImmediatePropagation();
                            }
                        }, true);
                    }
                });
            });
        }
        
        function hasDirectTextContent(element) {
            for (let node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                    return true;
                }
            }
            return false;
        }
        
        function removeTextEditability() {
            const editableElements = document.querySelectorAll('.editable-text');
            editableElements.forEach(element => {
                element.classList.remove('editable-text', 'selected', 'editing');
                element.removeEventListener('click', handleTextElementClick);
            });
        }
        
        function handleTextElementClick(event) {
            if (!isTextEditMode) return;
            
            // 强制阻止所有事件传播和默认行为
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            
            // 防止在表格、模态框等特殊区域进行编辑
            const element = event.target;
            if (element.closest('table') || 
                element.closest('.modal-backdrop') || 
                element.closest('#textEditToolbar') ||
                element.closest('.edit-controls') ||
                element.classList.contains('inline-editor')) {
                showToast('⚠️ 此区域不支持文字编辑');
                return false;
            }
            
            // 特别检查是否在按钮内部
            const parentButton = element.closest('button');
            if (parentButton) {
                // 如果在按钮内部，临时禁用按钮功能
                const originalOnClick = parentButton.onclick;
                const originalHref = parentButton.getAttribute('onclick');
                
                // 临时移除按钮的点击事件
                parentButton.onclick = null;
                parentButton.removeAttribute('onclick');
                parentButton.style.pointerEvents = 'none';
                
                // 在编辑完成后恢复按钮功能
                const restoreButton = () => {
                    if (originalOnClick) {
                        parentButton.onclick = originalOnClick;
                    }
                    if (originalHref) {
                        parentButton.setAttribute('onclick', originalHref);
                    }
                    parentButton.style.pointerEvents = '';
                };
                
                // 存储恢复函数以便后续使用
                element.restoreParentButton = restoreButton;
            }
            
            // Clear previous selection
            clearSelection();
            
            // Select current element
            selectedTextElement = element;
            selectedTextElement.classList.add('selected');
            
            // Update selection info
            updateSelectionInfo();
            
            // Start inline editing with delay to ensure proper focus
            setTimeout(() => {
                startInlineEditing(selectedTextElement);
            }, 100);
            
            return false;
        }
        
        function clearSelection() {
            if (selectedTextElement) {
                // 恢复父按钮功能
                if (selectedTextElement.restoreParentButton) {
                    selectedTextElement.restoreParentButton();
                    delete selectedTextElement.restoreParentButton;
                }
                
                selectedTextElement.classList.remove('selected', 'editing');
                selectedTextElement = null;
            }
            
            // Hide selection info
            document.getElementById('selectionInfo').classList.add('hidden');
            
            // Clear any existing inline editors
            const existingEditors = document.querySelectorAll('.inline-editor');
            existingEditors.forEach(editor => {
                const parent = editor.parentNode.parentNode; // 因为有wrapper
                if (parent && parent.restoreParentButton) {
                    parent.restoreParentButton();
                    delete parent.restoreParentButton;
                }
                
                const originalContent = editor.originalHTML || editor.originalText || editor.value;
                if (parent) {
                    parent.innerHTML = originalContent;
                    parent.classList.remove('editing');
                }
            });
            
            currentlyEditing = null;
        }
        
        function updateSelectionInfo() {
            const selectionInfo = document.getElementById('selectionInfo');
            const selectedElementInfo = document.getElementById('selectedElementInfo');
            
            if (selectedTextElement) {
                const tagName = selectedTextElement.tagName.toLowerCase();
                const textContent = selectedTextElement.textContent.substring(0, 30) + '...';
                selectedElementInfo.textContent = `${tagName}: "${textContent}"`;
                selectionInfo.classList.remove('hidden');
            }
        }
        
        function startInlineEditing(element) {
            if (currentlyEditing) return;
            
            currentlyEditing = element;
            element.classList.add('editing');
            
            const originalText = element.textContent.trim();
            const isMultiline = originalText.length > 50 || originalText.includes('\n');
            
            // Create editor with better visibility
            const editor = document.createElement(isMultiline ? 'textarea' : 'input');
            editor.className = 'inline-editor';
            editor.value = originalText;
            
            if (isMultiline) {
                editor.rows = Math.min(Math.max(3, originalText.split('\n').length), 8);
            } else {
                editor.type = 'text';
            }
            
            // Store original content and replace element content directly
            const originalHTML = element.innerHTML;
            element.innerHTML = '';
            element.appendChild(editor);
            
            // Focus and select with delay
            setTimeout(() => {
                editor.focus();
                editor.select();
            }, 50);
            
            // 简化的事件处理 - 只处理必要的键盘事件
            editor.addEventListener('keydown', function(e) {
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveInlineEdit(); // Enter键直接保存
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelInlineEdit(); // Esc键取消
                }
            }, true);
            
            // 失去焦点时自动保存
            editor.addEventListener('blur', function(e) {
                // 延迟检查，避免点击其他元素时误触发
                setTimeout(() => {
                    if (currentlyEditing && document.querySelector('.inline-editor')) {
                        saveInlineEdit();
                    }
                }, 100);
            });
            
            // 阻止事件传播
            ['keyup', 'keypress', 'input', 'paste', 'cut', 'copy', 'click'].forEach(eventType => {
                editor.addEventListener(eventType, function(e) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }, true);
            });
            
            // Store original data for cancel
            editor.originalText = originalText;
            editor.originalHTML = originalHTML;
        }
        
        function saveInlineEdit() {
            if (!currentlyEditing) return;
            
            const editor = currentlyEditing.querySelector('.inline-editor');
            if (!editor) return;
            
            const newText = editor.value.trim();
            const oldText = editor.originalText || '';
            
            // 立即更新显示内容
            currentlyEditing.innerHTML = newText || oldText;
            
            if (newText && newText !== oldText) {
                // 保存到历史记录
                const elementId = currentlyEditing.id || `element_${Date.now()}`;
                if (!currentlyEditing.id) {
                    currentlyEditing.id = elementId;
                }
                
                saveToHistory(
                    CHANGE_TYPES.TEXT_EDIT,
                    elementId,
                    oldText,
                    newText
                );
                
                showToast('✅ 文字已保存！修改立即生效');
            } else if (!newText) {
                // 如果内容为空，恢复原文
                currentlyEditing.innerHTML = oldText;
                showToast('⚠️ 内容为空，已恢复原文');
            } else {
                showToast('💡 文字内容未改变');
            }
            
            // 清理编辑状态
            finishEditing();
        }
        
        function finishEditing() {
            if (!currentlyEditing) return;
            
            // 恢复父按钮功能
            if (currentlyEditing.restoreParentButton) {
                setTimeout(() => {
                    currentlyEditing.restoreParentButton();
                    delete currentlyEditing.restoreParentButton;
                }, 50);
            }
            
            // 清理编辑状态
            currentlyEditing.classList.remove('editing');
            
            // 如果仍在文字编辑模式，保持选中状态
            if (isTextEditMode) {
                currentlyEditing.classList.add('selected');
                selectedTextElement = currentlyEditing;
                updateSelectionInfo();
            } else {
                currentlyEditing.classList.remove('selected');
                selectedTextElement = null;
            }
            
            currentlyEditing = null;
        }
        
        function cancelInlineEdit() {
            if (!currentlyEditing) return;
            
            const editor = currentlyEditing.querySelector('.inline-editor');
            const originalText = editor ? editor.originalText : '';
            const originalHTML = editor ? editor.originalHTML : '';
            
            // 立即恢复原始内容
            if (originalHTML) {
                currentlyEditing.innerHTML = originalHTML;
            } else if (originalText) {
                currentlyEditing.textContent = originalText;
            }
            
            showToast('❌ 编辑已取消，内容已恢复');
            
            // 清理编辑状态
            finishEditing();
        }
        
        // Font size functions
        function changeFontSize(direction) {
            if (!selectedTextElement) {
                showToast('⚠️ 请先选择要修改的文字元素');
                return;
            }
            
            const element = selectedTextElement;
            const currentSize = window.getComputedStyle(element).fontSize;
            const currentSizePx = parseFloat(currentSize);
            
            let newSize;
            if (direction === 'larger') {
                newSize = Math.min(currentSizePx * 1.2, 72); // Max 72px
            } else {
                newSize = Math.max(currentSizePx * 0.8, 10); // Min 10px
            }
            
            const actionText = direction === 'larger' ? '增大' : '减小';
            const message = `您确定要${actionText}选中文字的字体大小吗？`;
            const details = `当前大小：${Math.round(currentSizePx)}px → 新大小：${Math.round(newSize)}px`;
            
            showConfirmation(message, details, '📏', () => {
                // 保存到历史记录
                const elementId = element.id || `element_${Date.now()}`;
                if (!element.id) {
                    element.id = elementId;
                }
                
                saveToHistory(
                    CHANGE_TYPES.FONT_SIZE,
                    elementId,
                    currentSize,
                    newSize + 'px'
                );
                
                element.style.fontSize = newSize + 'px';
                showToast(`📏 字体大小已调整为 ${Math.round(newSize)}px`);
            });
        }
        
        function resetFontSize() {
            if (!selectedTextElement) {
                showToast('⚠️ 请先选择要重置的文字元素');
                return;
            }
            
            selectedTextElement.style.fontSize = '';
            showToast('🔄 字体大小已重置为默认值');
        }
        
        // Text style functions
        function toggleBold() {
            if (!selectedTextElement) {
                showToast('⚠️ 请先选择要修改的文字元素');
                return;
            }
            
            const element = selectedTextElement;
            const currentWeight = window.getComputedStyle(element).fontWeight;
            const isBold = currentWeight === 'bold' || parseInt(currentWeight) >= 600;
            const newWeight = isBold ? 'normal' : 'bold';
            const actionText = isBold ? '取消粗体' : '设置为粗体';
            
            showConfirmation(
                `您确定要${actionText}吗？`,
                `当前状态：${isBold ? '粗体' : '正常'} → 新状态：${isBold ? '正常' : '粗体'}`,
                '📝',
                () => {
                    const elementId = element.id || `element_${Date.now()}`;
                    if (!element.id) {
                        element.id = elementId;
                    }
                    
                    saveToHistory(
                        CHANGE_TYPES.FONT_STYLE,
                        elementId,
                        currentWeight,
                        newWeight,
                        { property: 'fontWeight' }
                    );
                    
                    element.style.fontWeight = newWeight;
                    showToast(`📝 已${actionText}`);
                }
            );
        }
        
        function toggleItalic() {
            if (!selectedTextElement) {
                showToast('⚠️ 请先选择要修改的文字元素');
                return;
            }
            
            const element = selectedTextElement;
            const currentStyle = window.getComputedStyle(element).fontStyle;
            const isItalic = currentStyle === 'italic';
            const newStyle = isItalic ? 'normal' : 'italic';
            const actionText = isItalic ? '取消斜体' : '设置为斜体';
            
            showConfirmation(
                `您确定要${actionText}吗？`,
                `当前状态：${isItalic ? '斜体' : '正常'} → 新状态：${isItalic ? '正常' : '斜体'}`,
                '📝',
                () => {
                    const elementId = element.id || `element_${Date.now()}`;
                    if (!element.id) {
                        element.id = elementId;
                    }
                    
                    saveToHistory(
                        CHANGE_TYPES.FONT_STYLE,
                        elementId,
                        currentStyle,
                        newStyle,
                        { property: 'fontStyle' }
                    );
                    
                    element.style.fontStyle = newStyle;
                    showToast(`📝 已${actionText}`);
                }
            );
        }
        
        // Emoji functions
        function insertEmoji(emoji) {
            if (!selectedTextElement) {
                showToast('⚠️ 请先选择要插入表情的文字元素');
                return;
            }
            
            const element = selectedTextElement;
            element.textContent = element.textContent + emoji;
            showToast(`😊 已插入表情：${emoji}`);
        }
        
        function showEmojiPicker() {
            document.getElementById('emojiPickerModal').classList.remove('hidden');
            showEmojiCategory('nature'); // Default to nature category
        }
        
        function closeEmojiPicker() {
            document.getElementById('emojiPickerModal').classList.add('hidden');
        }
        
        function showEmojiCategory(category) {
            const emojiGrid = document.getElementById('emojiGrid');
            const emojis = emojiCollections[category] || emojiCollections.nature;
            
            emojiGrid.innerHTML = '';
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.textContent = emoji;
                button.className = 'hover:bg-gray-100 rounded p-2 transition-colors';
                button.onclick = () => {
                    insertEmoji(emoji);
                    closeEmojiPicker();
                };
                emojiGrid.appendChild(button);
            });
        }
        
        // Text management functions
        function addTextElement() {
            document.getElementById('textInputModal').classList.remove('hidden');
        }
        
        function closeTextInputModal() {
            document.getElementById('textInputModal').classList.add('hidden');
            document.getElementById('newTextContent').value = '';
        }
        
        function createNewTextElement(event) {
            event.preventDefault();
            
            const content = document.getElementById('newTextContent').value;
            const size = document.getElementById('textSize').value;
            const color = document.getElementById('textColor').value;
            const position = document.getElementById('textPosition').value;
            
            // Create new text element
            const textElement = document.createElement('div');
            textElement.className = `custom-text-element ${size} ${color} font-medium`;
            textElement.textContent = content;
            
            // Find target container
            let targetContainer;
            switch(position) {
                case 'header':
                    targetContainer = document.querySelector('header .max-w-7xl');
                    break;
                case 'hero':
                    targetContainer = document.querySelector('.hero-bg .max-w-7xl');
                    break;
                case 'features':
                    targetContainer = document.querySelector('.glass-effect .max-w-7xl');
                    break;
                case 'competition':
                    targetContainer = document.querySelector('.section-bg .max-w-7xl');
                    break;
                case 'partnership':
                    targetContainer = document.querySelector('.py-16.glass-effect .max-w-7xl');
                    break;
                default:
                    targetContainer = document.querySelector('.hero-bg .max-w-7xl');
            }
            
            if (targetContainer) {
                targetContainer.appendChild(textElement);
                
                // If in edit mode, make it editable
                if (isTextEditMode) {
                    textElement.classList.add('editable-text');
                    textElement.addEventListener('click', handleTextElementClick);
                }
                
                showToast(`✅ 新文字已添加到${getPositionName(position)}！`);
            } else {
                showToast('❌ 无法找到目标位置，文字添加失败');
            }
            
            closeTextInputModal();
        }
        
        function getPositionName(position) {
            const names = {
                header: 'Header区域',
                hero: 'Hero区域',
                features: '功能区域',
                competition: '竞赛区域',
                partnership: '合作区域'
            };
            return names[position] || 'Hero区域';
        }
        
        function deleteSelectedText() {
            if (!selectedTextElement) {
                showToast('⚠️ 请先选择要删除的文字元素');
                return;
            }
            
            const element = selectedTextElement;
            const isCustomElement = element.classList.contains('custom-text-element');
            const actionText = isCustomElement ? '完全删除此自定义文字元素' : '清空此系统文字的内容';
            const warningText = isCustomElement ? '删除后无法直接恢复，但可以通过撤销功能恢复。' : '系统文字不能完全删除，只能清空内容。';
            
            showConfirmation(
                `您确定要${actionText}吗？`,
                `${warningText}\n当前文字：${element.textContent.substring(0, 30)}${element.textContent.length > 30 ? '...' : ''}`,
                '🗑️',
                () => {
                    const elementId = element.id || `element_${Date.now()}`;
                    if (!element.id) {
                        element.id = elementId;
                    }
                    
                    if (isCustomElement) {
                        // 保存完整的元素信息以便恢复
                        const containerSelector = getContainerSelector(element);
                        
                        saveToHistory(
                            CHANGE_TYPES.TEXT_DELETE,
                            elementId,
                            {
                                exists: true,
                                textContent: element.textContent,
                                className: element.className,
                                containerSelector: containerSelector
                            },
                            { exists: false },
                            {
                                textContent: element.textContent,
                                className: element.className,
                                containerSelector: containerSelector
                            }
                        );
                        
                        element.remove();
                        selectedTextElement = null;
                        document.getElementById('selectionInfo').classList.add('hidden');
                        showToast('🗑️ 自定义文字已删除');
                    } else {
                        // 系统文字只清空内容
                        const oldContent = element.textContent;
                        
                        saveToHistory(
                            CHANGE_TYPES.TEXT_EDIT,
                            elementId,
                            oldContent,
                            ''
                        );
                        
                        element.textContent = '';
                        showToast('🗑️ 文字内容已清空（系统文字不能完全删除）');
                    }
                }
            );
        }
        
        function getContainerSelector(element) {
            const container = element.parentElement;
            if (!container) return 'body';
            
            // 尝试找到一个唯一的选择器
            if (container.id) {
                return `#${container.id}`;
            }
            
            // 查找具有特定类的容器
            const specificClasses = ['max-w-7xl', 'hero-bg', 'glass-effect', 'section-bg'];
            for (let cls of specificClasses) {
                if (container.classList.contains(cls) || container.querySelector(`.${cls}`)) {
                    return `.${cls}`;
                }
            }
            
            return 'body'; // 默认返回body
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 4000);
        }

        // 终极空格键阻止系统 - 多层防护
        let ultimateSpaceBlocker = null;
        let isBlockingSpace = false;
        
        function setupUltimateSpaceProtection() {
            // 移除旧的处理器
            if (ultimateSpaceBlocker) {
                document.removeEventListener('keydown', ultimateSpaceBlocker, true);
                document.removeEventListener('keyup', ultimateSpaceBlocker, true);
                document.removeEventListener('keypress', ultimateSpaceBlocker, true);
                window.removeEventListener('keydown', ultimateSpaceBlocker, true);
                window.removeEventListener('keyup', ultimateSpaceBlocker, true);
                window.removeEventListener('keypress', ultimateSpaceBlocker, true);
            }
            
            // 创建终极空格阻止器
            ultimateSpaceBlocker = function(event) {
                // 检查是否正在编辑文字
                const isEditing = currentlyEditing && document.querySelector('.inline-editor');
                const activeEditor = document.querySelector('.inline-editor');
                const isInTextarea = event.target && (event.target.tagName === 'TEXTAREA' || event.target.tagName === 'INPUT');
                const isInModal = event.target && event.target.closest('.modal-backdrop');
                
                // 如果正在编辑文字，特殊处理
                if (isEditing || isInTextarea || isInModal) {
                    // 只允许编辑器内的空格键
                    if (event.key === ' ' || event.code === 'Space' || event.keyCode === 32) {
                        if (event.target === activeEditor || isInTextarea || isInModal) {
                            // 允许在编辑器、输入框或模态框中使用空格
                            return true;
                        } else {
                            // 完全阻止其他地方的空格键
                            event.preventDefault();
                            event.stopPropagation();
                            event.stopImmediatePropagation();
                            isBlockingSpace = true;
                            
                            // 强制焦点回到编辑器
                            if (activeEditor) {
                                setTimeout(() => {
                                    activeEditor.focus();
                                    isBlockingSpace = false;
                                }, 0);
                            }
                            return false;
                        }
                    }
                }
                
                // 全局空格键阻止（当不在编辑状态时）
                if (event.key === ' ' || event.code === 'Space' || event.keyCode === 32) {
                    // 检查是否在可输入元素中
                    const isInputElement = event.target && (
                        event.target.tagName === 'INPUT' || 
                        event.target.tagName === 'TEXTAREA' || 
                        event.target.contentEditable === 'true' ||
                        event.target.classList.contains('inline-editor')
                    );
                    
                    if (!isInputElement) {
                        // 不在输入元素中，阻止空格键
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        console.log('Space key completely blocked');
                        return false;
                    }
                }
                
                // 其他快捷键处理
                if (isTextEditMode && !isEditing) {
                    // Ctrl+Z for undo
                    if (event.ctrlKey && event.key === 'z' && !event.shiftKey) {
                        event.preventDefault();
                        undoChange();
                        return false;
                    }
                    
                    // Ctrl+Shift+Z or Ctrl+Y for redo
                    if ((event.ctrlKey && event.shiftKey && event.key === 'Z') || 
                        (event.ctrlKey && event.key === 'y')) {
                        event.preventDefault();
                        redoChange();
                        return false;
                    }
                }
                
                return true;
            };
            
            // 多层事件监听 - 确保完全拦截
            document.addEventListener('keydown', ultimateSpaceBlocker, true);
            document.addEventListener('keyup', ultimateSpaceBlocker, true);
            document.addEventListener('keypress', ultimateSpaceBlocker, true);
            window.addEventListener('keydown', ultimateSpaceBlocker, true);
            window.addEventListener('keyup', ultimateSpaceBlocker, true);
            window.addEventListener('keypress', ultimateSpaceBlocker, true);
            
            // 额外的空格键专用阻止器
            const spaceOnlyBlocker = function(event) {
                if ((event.key === ' ' || event.code === 'Space' || event.keyCode === 32) && !isBlockingSpace) {
                    const isInputElement = event.target && (
                        event.target.tagName === 'INPUT' || 
                        event.target.tagName === 'TEXTAREA' || 
                        event.target.contentEditable === 'true' ||
                        event.target.classList.contains('inline-editor') ||
                        event.target.closest('.modal-backdrop')
                    );
                    
                    if (!isInputElement) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        return false;
                    }
                }
            };
            
            // 在所有可能的阶段都添加空格阻止器
            document.addEventListener('keydown', spaceOnlyBlocker, true);
            document.addEventListener('keypress', spaceOnlyBlocker, true);
            window.addEventListener('keydown', spaceOnlyBlocker, true);
            window.addEventListener('keypress', spaceOnlyBlocker, true);
        }
        
        // 页面加载完成后立即初始化
        setupUltimateSpaceProtection();
        
        // 确保在DOM完全加载后再次初始化
        document.addEventListener('DOMContentLoaded', setupUltimateSpaceProtection);
        
        // 页面获得焦点时重新初始化
        window.addEventListener('focus', setupUltimateSpaceProtection);

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-backdrop')) {
                event.target.classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'994802feb38897fa',t:'MTc2MTQ2MTM0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
